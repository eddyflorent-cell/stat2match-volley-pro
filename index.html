<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Stats de match pro ‚Äì 6x6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 10px;
      background: #202124;
      color: #f5f5f5;
    }
    h1, h2, h3 { margin: 8px 0; }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }
#app-signature {
  margin-top: 8px;
  font-size: 11px;
  text-align: center;
  color: #888;
}

    .no-select,
    .no-select * {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    /* Boutons en haut */
    #btn-toggle-roster,
    #btn-dashboard,
    #btn-diagnostics,
    #btn-history {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      border: none;
      margin-bottom: 8px;
      margin-right: 6px;
    }
    #btn-help {
  border-radius: 999px;
  padding: 6px 12px;
  font-size: 13px;
  cursor: pointer;
  border: 1px solid #29b6f6;
  margin-bottom: 8px;
  margin-right: 6px;
  background: #171717;
  color: #29b6f6;
}

    #btn-toggle-roster {
      background: #0077ff;
      color: #fff;
    }
    #btn-dashboard {
      background: #171717;
      color: #00e676;
      border: 1px solid #00e676;
    }
    #btn-diagnostics {
      background: #171717;
      color: #29b6f6;
      border: 1px solid #29b6f6;
    }

    #btn-history {
      background: #171717;
      color: #ffb300;
      border: 1px solid #ffb300;
    }
    #team-name-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    #team-name-bar input {
      flex: 1 1 140px;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #171717;
      color: #fff;
      font-size: 13px;
    }

    /* Bloc effectif */
    #roster {
      background: #303134;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
      margin-bottom: 12px;
    }
    #player-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    #player-form input,
    #player-form select,
    #player-form button {
      padding: 6px 8px;
      font-size: 14px;
    }
    #player-form input,
    #player-form select {
      flex: 1 1 100px;
      border-radius: 6px;
      border: 1px solid #555;
      background:#171717;
      color:#fff;
    }
    #player-form button {
      flex: 1 1 120px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background: #0077ff;
      color: #fff;
      font-weight: 600;
    }
        #config-transfer {
      margin-top: 8px;
      padding: 6px;
      border-radius: 6px;
      background: #252628;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #config-transfer textarea {
      width: 100%;
      min-height: 70px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #171717;
      color: #eee;
      font-size: 12px;
      padding: 4px 6px;
      resize: vertical;
      font-family: "SF Mono","Consolas",monospace;
    }
    #config-transfer button {
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    #btn-export-config {
      background: #00c853;
      color: #fff;
    }
    #btn-import-config {
      background: #0077ff;
      color: #fff;
    }
    #config-transfer small {
      font-size: 11px;
      color: #aaa;
    }

    #player-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 260px;
      overflow-y: auto;
    }
    .player-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px solid #444;
      gap: 8px;
      font-size: 14px;
    }
    .player-main {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      cursor: pointer;
    }
    .badge-jersey {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      padding: 0;
      font-weight: 800;
      color: #fff;
      font-size: 14px;
      line-height: 1;
    }
    .player-actions button {
      padding: 3px 6px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .btn-edit { background: #ffc107; }
    .btn-delete { background: #e53935; color: #fff; }

         /* Couleurs maillots */
     .c-blue  { background: #1e88e5; }
     .c-green { background: #43a047; }
     .c-red   { background: #e53935; }
     .c-yellow{ background: #fdd835; color:#222; }
     .c-purple{ background: #8e24aa; }
     .c-orange{ background: #fb8c00; }
     .c-teal  { background: #00897b; }
     .c-pink  { background: #d81b60; }


    /* Terrain 6x6 */
    #court {
      background: #303134;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
      margin-bottom: 12px;
    }
    .court-grid {
      background: #e0a96d;
      border-radius: 8px;
      padding: 8px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, auto);
      align-content: start;
gap: 6px;
    }
    @media (min-width: 700px) {
  .court-grid { grid-template-rows: repeat(2, auto); }
}
    .court-pos {
      border: 1px solid rgba(255,255,255,0.6);
      border-radius: 8px;
      padding: 6px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 2px;
      min-height: 0;
      font-size: 12px;
      color: #fff;
      cursor: default;
}
    /* halo rouge quand delta tr√®s n√©gatif */
    .court-pos.danger-delta {
      box-shadow: 0 0 0 3px rgba(229,57,53,0.9);
      border-color: #e53935;
    }

    .pos-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pos-label {
      font-weight: 600;
    }
    .pos-select {
      width: 100%;
      margin-top: 2px;
      font-size: 12px;
      padding: 2px 4px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
    }
    .pos-jersey {
      margin-top: 2px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 12px;
      text-align: center;
      padding: 2px 3px;
      color: #fff;
      pointer-events: none;
      min-height: 0;
    }
    
    .pos-jersey .name{font-weight:700;font-size:13px;line-height:1.15;}
    .pos-jersey span{display:block;}
.pos-jersey span { display: block; }
    .pos-jersey .name {
      font-weight: 600;
      margin-top: 2px;
    }

    /* Banc */
    #bench {
      margin-top: 10px;
    }
    #bench-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .bench-player {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 11px;
    }
    .bench-player .badge-jersey {
      margin-bottom: 2px;
    }

    small { color: #aaa; }

    /* Score du match */
    #score-section {
      background: #303134;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
      margin-bottom: 12px;
    }
    #score-title span {
      font-size: 13px;
      font-weight: 400;
      margin-left: 4px;
      color: #ccc;
    }
    #set-selector-main,
    #set-selector-s,
    #set-selector-dashboard {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .set-btn-main,
    .set-btn-s,
    .set-btn-dashboard {
      border-radius: 999px;
      border: 1px solid #0077ff;
      padding: 4px 10px;
      background: #171717;
      color: #0077ff;
      cursor: pointer;
      font-size: 13px;
    }
    .set-btn-main.active,
    .set-btn-s.active,
    .set-btn-dashboard.active {
      background: #0077ff;
      color: #fff;
    }
    .set-btn-main.is-disabled,
    .set-btn-s.is-disabled,
    .set-btn-dashboard.is-disabled {
      opacity: 0.35;
      cursor: not-allowed;
    }
    .score-board {
      display: flex;
      gap: 10px;
      justify-content: space-around;
      align-items: stretch;
      flex-wrap: wrap;
    }
    .score-team {
      background: #171717;
      border-radius: 8px;
      padding: 8px;
      flex: 1 1 120px;
      text-align: center;
    }
    .score-label {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .score-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .score-controls button {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .score-btn-minus { background: #e53935; color: #fff; }
    .score-btn-plus  { background: #43a047; color: #fff; }
    .score-value {
      font-size: 22px;
      font-weight: 700;
      min-width: 32px;
      text-align: center;
      cursor: pointer;
    }
    .tm-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      font-size: 13px;
    }
    .tm-label {
      flex: 1;
      color: #dddddd;
    }
    .tm-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }
        /* Temps morts compacts sous le score */
    #timeout-inline {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px 12px;
      font-size: 11px;
      align-items: center;
    }
    .tm-inline {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .tm-inline-label {
      color: #dddddd;
      margin-right: 4px;
    }
    .tm-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid #888;
      background: transparent;
      padding: 0;
      cursor: pointer;
    }
    .tm-dot.tm-used {
      background: #ffb300;
      border-color: #ffb300;
    }
    .tm-inline-count {
      font-size: 10px;
      color: #aaaaaa;
      margin-left: 2px;
    }

    .tm-controls button {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      background: #555555;
      color: #ffffff;
    }
    .tm-controls span {
      min-width: 40px;
      text-align: center;
      font-size: 13px;
    }
        /* Bandeau rallye */
    #rally-bar {
      margin-top: 8px;
      padding: 6px;
      background: #171717;
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: space-between;
    }
    .rally-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      flex: 1 1 70px;
      font-size: 11px;
    }
    .rally-label {
      color: #ddd;
      font-size: 11px;
    }
    .rally-group .rally-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
    .rally-group .rally-btn[data-outcome="plus"] {
      background: #43a047;
      color: #fff;
    }
    .rally-group .rally-btn[data-outcome="minus"] {
      background: #e53935;
      color: #fff;
    }

    /* --- Pro controls --- */
.pro-pill{
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.06);
  color: #fff;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  cursor: pointer;
}
.pro-pill.active{
  background: rgba(76,175,80,0.22);
  border-color: rgba(76,175,80,0.55);
}
.pro-check{
  display:flex;
  align-items:center;
  gap:4px;
  font-size:12px;
  opacity:.9;
}
.pro-badge{
  font-size:12px;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(64,196,255,0.18);
  border: 1px solid rgba(64,196,255,0.45);
  color: #fff;
}

/* --- Action pad on player tiles (7 rubriques x 4 √©tats) --- */
.pro-action-pad{
  display:flex;
  flex-direction:column;
  gap:3px;
  margin-top:2px;
  padding-top:2px;
  border-top: 1px solid rgba(255,255,255,0.10);
}
.pro-skill-row{
  display:grid;
  grid-template-columns: 28px repeat(4, 1fr);
  gap:6px;
  align-items:center;
}
.pro-skill-label{
  font-size: 10px;
  opacity: .9;
  text-align:center;
  padding: 3px 0;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.04);
}
.pro-out-btn{
  padding: 3px 0;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: #fff;
  font-size: 12px;
  cursor: pointer;
}

/* Feedback imm√©diat au toucher (desktop + mobile) */
.pro-out-btn.pressed{
  background: rgba(255,255,255,0.14);
  border-color: rgba(255,255,255,0.45) !important;
  transform: translateY(1px);
}
.pro-out-btn:active{
  filter: brightness(1.12);
}

.pro-out-btn:hover{ background: rgba(255,255,255,0.10); }

.pro-out-btn.tapped{
  background: rgba(0,230,118,0.22);
  border-color: rgba(0,230,118,0.75) !important;
  box-shadow: 0 0 0 2px rgba(0,230,118,0.18) inset;
}
.pro-out-btn.undone{
  background: rgba(255,193,7,0.22);
  border-color: rgba(255,193,7,0.80) !important;
  box-shadow: 0 0 0 2px rgba(255,193,7,0.18) inset;
}

#tiny-toast{
  position: fixed;
  left: 50%;
  bottom: 16px;
  transform: translateX(-50%);
  padding: 8px 10px;
  border-radius: 12px;
  background: rgba(0,0,0,0.72);
  color: #fff;
  font-size: 12px;
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease;
}
#tiny-toast.show{
  opacity: 1;
  transform: translateX(-50%) translateY(-2px);
}
@media (prefers-reduced-motion: reduce){
  #tiny-toast{ transition:none; }
}

.pro-out-btn[data-outcome="plus"]{ border-color: rgba(0,230,118,0.35); }
.pro-out-btn[data-outcome="minus"]{ border-color: rgba(255,82,82,0.35); }
.pro-out-btn[data-outcome="point"]{ border-color: rgba(64,196,255,0.35); }
.pro-out-btn[data-outcome="fault"]{ border-color: rgba(255,179,0,0.35); }

/* --- Pro action overlay --- */
#pro-action-overlay{
  position: fixed;
  inset: 0;
  display: none;
  align-items: flex-end;
  justify-content: center;
  z-index: 9999;
}
#pro-action-backdrop{
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.55);
}
#pro-action-panel{
  position: relative;
  width: min(520px, calc(100vw - 16px));
  margin: 0 0 12px 0;
  background: #11161c;
  border: 1px solid rgba(255,255,255,0.16);
  border-radius: 14px;
  box-shadow: 0 14px 40px rgba(0,0,0,0.55);
  padding: 12px;
}
#pro-action-title{
  font-size: 13px;
  opacity: .9;
  margin-bottom: 10px;
  display:flex;
  justify-content: space-between;
  align-items:center;
  gap:10px;
}
#pro-action-grid{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}
.pro-action-choice{
  padding: 14px 10px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: #fff;
  font-size: 16px;
  cursor:pointer;
}
.pro-action-choice:hover{ background: rgba(255,255,255,0.10); }

/* √âtats: + / - / P / F */
.pro-action-choice[data-outcome="plus"]{ border-color: rgba(0,230,118,0.55); }
.pro-action-choice[data-outcome="minus"]{ border-color: rgba(255,82,82,0.55); }
.pro-action-choice[data-outcome="point"]{ border-color: rgba(64,196,255,0.55); }
.pro-action-choice[data-outcome="fault"]{ border-color: rgba(255,145,0,0.55); }

/* --- Rally bar : ajoute P/F --- */
.rally-group .rally-btn[data-outcome="point"]{
  background: rgba(64,196,255,0.18);
  border-color: rgba(64,196,255,0.55);
  color:#fff;
}
.rally-group .rally-btn[data-outcome="fault"]{
  background: rgba(255,145,0,0.18);
  border-color: rgba(255,145,0,0.55);
  color:#fff;
}

/* Overlay rallye */
    #rally-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #rally-overlay-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
    }

    /* --- Fix: l‚Äôoverlay rallye ne doit JAMAIS bloquer les clics sur le score & stats adverses ---
   - l‚Äôenveloppe plein √©cran laisse passer les clics
   - seul le panneau reste interactif
*/
#rally-overlay-backdrop{
  pointer-events: none; /* on garde le voile visuel sans bloquer */
}
#rally-overlay{
  pointer-events: none;
}
#rally-overlay-panel{
  pointer-events: auto;
}

#rally-overlay-panel {
      position: fixed;
      right: 18px;
      top: 110px;
      width: min(360px, calc(100vw - 36px));
      padding: 12px;
      border-radius: 16px;

      /* Funky glass + gradient */
      background: linear-gradient(135deg, rgba(32,33,36,0.92), rgba(32,33,36,0.70));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);

      border: 1px solid rgba(255,255,255,0.14);
      box-shadow:
        0 18px 60px rgba(0,0,0,0.70),
        inset 0 1px 0 rgba(255,255,255,0.08);

      z-index: 1;
      overflow: hidden;
      transform: translateZ(0);
    }

    /* Petit glow discret */
    #rally-overlay-panel::after{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle at 15% 10%, rgba(64,196,255,0.16), transparent 55%),
                  radial-gradient(circle at 85% 25%, rgba(255,145,0,0.14), transparent 60%),
                  radial-gradient(circle at 50% 110%, rgba(0,230,118,0.10), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }


    /* Accent "funky" selon la rubrique ouverte */
    #rally-overlay-panel::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width:8px;
      border-radius:14px 0 0 14px;
      opacity:.95;
      background: rgba(255,255,255,0.08);
    }
    #rally-overlay-panel[data-cat="attaque"]::before{ background: rgba(255,82,82,0.95); }
    #rally-overlay-panel[data-cat="service"]::before{ background: rgba(0,230,118,0.95); }
    #rally-overlay-panel[data-cat="bloc"]::before{ background: rgba(255,145,0,0.95); }
    #rally-overlay-panel[data-cat="reception"]::before{ background: rgba(64,196,255,0.95); }
    #rally-overlay-panel[data-cat="defense"]::before{ background: rgba(105,240,174,0.95); }
    #rally-overlay-panel[data-cat="passe"]::before{ background: rgba(179,136,255,0.95); }
    #rally-overlay-panel[data-cat="relance"]::before{ background: rgba(255,235,59,0.92); }
    #rally-overlay-panel[data-cat="rally"]::before{ background: linear-gradient(180deg, rgba(105,240,174,0.95), rgba(179,136,255,0.95)); }

    #rally-overlay-panel[data-cat="attaque"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(255,82,82,0.22), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="service"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(0,230,118,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="bloc"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(255,145,0,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="reception"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(64,196,255,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="defense"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(105,240,174,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="passe"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(179,136,255,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="relance"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(255,235,59,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="rally"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(105,240,174,0.20), rgba(179,136,255,0.16)); }

    #rally-overlay-title {
      margin: 0 0 4px;
      font-size: 16px;
    }
    #rally-overlay-hint {
      margin: 0 0 8px;
      font-size: 11px;
      color: #ccc;
    }
    #rally-player-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    .rally-player-btn {
      flex: 1 1 45%;
      border-radius: 999px;
      border: 1px solid #0077ff;
      background: #171717;
      color: #fff;
      padding: 6px 8px;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
    }
    .rally-player-btn span {
      display: inline-block;
      margin-right: 4px;
      font-weight: 600;
    }

    /* Boutons joueur¬∑euses : bordure accord√©e √† la rubrique */
    #rally-overlay-panel[data-cat="attaque"] .rally-player-btn{ border-color: rgba(255,82,82,0.9); }
    #rally-overlay-panel[data-cat="service"] .rally-player-btn{ border-color: rgba(0,230,118,0.85); }
    #rally-overlay-panel[data-cat="bloc"] .rally-player-btn{ border-color: rgba(255,145,0,0.85); }
    #rally-overlay-panel[data-cat="reception"] .rally-player-btn{ border-color: rgba(64,196,255,0.85); }
    #rally-overlay-panel[data-cat="defense"] .rally-player-btn{ border-color: rgba(105,240,174,0.85); }
    #rally-overlay-panel[data-cat="passe"] .rally-player-btn{ border-color: rgba(179,136,255,0.85); }
    #rally-overlay-panel[data-cat="relance"] .rally-player-btn{ border-color: rgba(255,235,59,0.75); }
    #rally-overlay-panel[data-cat="rally"] .rally-player-btn{ border-color: rgba(179,136,255,0.55); }

    #rally-overlay-panel .rally-player-btn:hover{
      background: rgba(255,255,255,0.06);
      transform: translateY(-1px);
    }
    .rally-count {
  margin-left: 4px;
  font-weight: 400;
  color: #ccc;
}

    #rally-close-btn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 8px;
      background: #0077ff;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }


   /* Cartes s (joueur¬∑euse / adversaire / dashboard / historique / aide) */
#s-view,
#stats-view,
#opponent,
#dashboard,
#history,
#help {
  background: #303134;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.5);
  margin-bottom: 12px;

  overflow-x: hidden;
}


        #btn-back,
    #btn-back-from-dashboard,
    #btn-back-from-history,
    #btn-back-from-history-bottom {
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      background: #555;
      color: #fff;
      cursor: pointer;
      margin-bottom: 8px;
    }


    #s-player-title {
      margin: 4px 0 8px;
    }

    #stats-list,
    #opponent-stats-list,
    #dash-team-body {
      border-top: 1px solid #444;
      padding-top: 6px;
    }

    
    /* --- Toggle d'affichage des panneaux adverses (pli√©/d√©pli√©) --- */
    .opp-headbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .opp-toggle{
      font-size:12.5px;
      padding:7px 11px;
      border-radius:999px;
      white-space:nowrap;
    }
    .opp-toggle.is-open{
      filter: brightness(1.06);
    }
    .opp-panels-wrap{ margin-top:8px; }
    .opp-panels-wrap.is-collapsed{ display:none; }

/* --- Point adverse (niveau 1 + niveau 2) : panneau rapide au-dessus des stats adverses --- */
    .opp-point-panel{
      margin: 10px 0 12px;
      padding: 10px 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(135deg, rgba(236,79,33,.14), rgba(73,146,219,.10), rgba(158,206,9,.08));
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }

    /* --- Fautes adverses directes (point pour nous) : panneau rapide --- */
    .opp-fault-panel{
      background: linear-gradient(135deg, rgba(158,206,9,.14), rgba(244,154,30,.10), rgba(73,146,219,.08));
      border: 1px solid rgba(255,255,255,.14);
    }
    .opp-fault-panel .opp-point-title{ color: rgba(255,255,255,.98); }
    .opp-point-head{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .opp-point-title{ font-weight:800; letter-spacing:.2px; }
    .opp-point-sub{ opacity:.9; font-size: 12.5px; }
    .opp-point-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .opp-point-score{
      display:flex; align-items:center; gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
    }
    .opppt-team{ font-weight:800; opacity:.95; }
    .opppt-btn{
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      color: #fff;
      background: rgba(0,0,0,.28);
      font-size: 20px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, filter .08s ease, background .12s ease;
    }
    .opppt-btn:active{ transform: scale(.96); filter: brightness(1.15); }
    .opppt-btn.minus{ background: rgba(255, 64, 64, .28); }
    .opppt-btn.plus{ background: rgba(0, 200, 120, .26); }
    #opppt-score-val{
      min-width: 46px;
      text-align:center;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .5px;
    }
    .opppt-tags{
      display:flex; align-items:center; gap:8px;
      flex-wrap:wrap;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
    }
    .opppt-tag{
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.26);
      color:#fff;
      cursor:pointer;
      font-weight:700;
      font-size: 13px;
      transition: transform .08s ease, filter .08s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .opppt-tag:active{ transform: scale(.97); filter: brightness(1.15); }
    .opppt-tag small{ opacity:.8; font-weight:600; }

    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      border-bottom: 1px solid #444;
      font-size: 14px;
    }
    .stat-label { font-weight: 500; }
    .stat-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
    }
    .stat-controls button {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }

@media (max-width: 600px){
  /* Page stats joueuse : √©vite le tronquage horizontal */
  .stat-row{flex-wrap: wrap; align-items: flex-start;}
  .stat-label{flex: 1 1 100%;}
  .stat-controls{flex-wrap: wrap; justify-content: flex-end;}
  .stat-controls button{width: 30px; height: 30px; font-size: 18px;}
  .btn-stat-point, .btn-stat-fault{ padding: 4px 8px; font-size: 14px; }
}

    .btn-stat-minus {
      background: #e53935;
      color: #fff;
    }
    .btn-stat-plus {
      background: #43a047;
      color: #fff;
    }
    .btn-stat-point{
  padding: 6px 10px;
  border-radius: 10px;
  border: 1px solid rgba(64,196,255,0.55);
  background: rgba(64,196,255,0.18);
  color: #fff;
  cursor:pointer;
  font-weight:700;
}
.btn-stat-fault{
  padding: 6px 10px;
  border-radius: 10px;
  border: 1px solid rgba(255,145,0,0.55);
  background: rgba(255,145,0,0.18);
  color: #fff;
  cursor:pointer;
  font-weight:700;
}
.stat-value {
      min-width: 22px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
    }
    .stat-sep {
      font-size: 12px;
      color: #aaa;
    }

    #opponent-title span {
      font-size: 13px;
      margin-left: 4px;
      color: #ccc;
      font-weight: 400;
    }

    #dash-score-box {
      background:#171717;
      border-radius:8px;
      padding:8px;
      margin-bottom:8px;
    }
    #dash-score-line {
      font-size: 18px;
      font-weight:600;
      text-align:center;
    }
    #dash-comment {
      font-size: 12px;
      color:#bbb;
      margin-top:4px;
      display:block;
    }

    #btn-close-match {
      width: 100%;
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #d81b60;
      color: #fff;
      font-weight: 600;
      font-size: 14px;
    }

    /* Historique */
    .history-item{
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.25));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      position: relative;
      overflow: hidden;
    }
    .history-item::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 20% 0%, rgba(73,146,219,.20), transparent 45%),
                  radial-gradient(circle at 90% 20%, rgba(236,79,33,.18), transparent 55%),
                  radial-gradient(circle at 40% 90%, rgba(158,206,9,.14), transparent 55%);
      pointer-events:none;
      filter: blur(.2px);
    }
    .history-header{
      position:relative;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:4px;
    }
    .history-header h3{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .history-score{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color:#fff;
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
    }
    .history-meta{
      position:relative;
      font-size:12px;
      color:rgba(255,255,255,.72);
      margin-bottom:8px;
    }
    .history-actions{
      position:relative;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin: 8px 0 6px;
    }
    .btn-history-toggle,
    .btn-history-delete,
    .btn-history-copy,
    .btn-history-print,
    .btn-history-share,
    .btn-history-wa,
    .btn-history-tg{
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      padding: 7px 12px;
      font-size: 12px;
      cursor: pointer;
      background: rgba(0,0,0,.22);
      color: #fff;
      transition: transform .08s ease, opacity .12s ease;
    }
    .btn-history-toggle:hover,
    .btn-history-delete:hover,
    .btn-history-copy:hover,
    .btn-history-print:hover,
    .btn-history-share:hover,
    .btn-history-wa:hover,
    .btn-history-tg:hover{ transform: translateY(-1px); }
    .btn-history-toggle{ border-color: rgba(73,146,219,.35); }
    .btn-history-print{ border-color: rgba(244,154,30,.35); }
    .btn-history-copy{ border-color: rgba(158,206,9,.35); }
    .btn-history-share{ border-color: rgba(236,79,33,.35); }
    .btn-history-wa{ border-color: rgba(0,200,83,.35); }
    .btn-history-tg{ border-color: rgba(73,146,219,.25); }
    .btn-history-delete{ border-color: rgba(255,70,70,.35); }

    .history-body{
      position:relative;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.12);
    }
    .history-body textarea{
      width: 100%;
      min-height: 140px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.92);
      padding: 10px;
      resize: vertical;
      font-size: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      margin-bottom: 8px;
    }

    /* Stats joueur¬∑euses ‚Äì barre d‚Äôactions + export */
    .stats-export-bar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin: 8px 0 10px;
    }
    .stats-export-bar .btn{
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: #fff;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
    }
    .stats-export-bar .btn:hover{ transform: translateY(-1px); }
    .stats-export-bar .btn.copy{ border-color: rgba(158,206,9,.35); }
    .stats-export-bar .btn.share{ border-color: rgba(236,79,33,.35); }
    .stats-export-bar .btn.wa{ border-color: rgba(0,200,83,.35); }
    .stats-export-bar .btn.tg{ border-color: rgba(73,146,219,.30); }
    .stats-export-bar .btn.print{ border-color: rgba(244,154,30,.35); }
    #player-report-text{
      border: 1px solid rgba(255,255,255,.10) !important;
      background: rgba(0,0,0,.25) !important;
      border-radius: 14px !important;
      display:block;
      width:100%;
      min-height: 110px;
      box-sizing:border-box;
    }

/* =========================
   STATS JOUEUSES (FUNKY)
   ========================= */
#stats-view{
  position:relative;
  overflow:hidden;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.22));
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}
#stats-view::before{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 15% 0%, rgba(73,146,219,.22), transparent 45%),
    radial-gradient(circle at 85% 20%, rgba(236,79,33,.18), transparent 55%),
    radial-gradient(circle at 35% 95%, rgba(158,206,9,.14), transparent 55%);
  pointer-events:none;
}
#stats-view > *{ position:relative; }

.stats-hero{
  margin:10px 0 10px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  flex-wrap:wrap;
}
.stats-hero p{
  margin:0;
  color: rgba(255,255,255,.82);
  font-size:13px;
  line-height:1.35;
}
.stats-badges{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.stats-badge{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color:#fff;
  white-space:nowrap;
}
.stats-badge.orange{ border-color: rgba(236,79,33,.55); }
.stats-badge.blue{ border-color: rgba(73,146,219,.55); }
.stats-badge.green{ border-color: rgba(158,206,9,.55); }
.stats-badge.yellow{ border-color: rgba(244,154,30,.55); }

#stats-list{
  border-top: 0;
  padding-top: 0;
}
#stats-view .stat-row{
  border-bottom: 1px solid rgba(255,255,255,.10);
  padding: 10px 8px;
  border-radius: 14px;
  margin: 8px 0;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.06);
}
#stats-view .stat-label{
  font-weight:800;
  letter-spacing:.2px;
}
#stats-view .stat-controls .btn-stat-plus,
#stats-view .stat-controls .btn-stat-minus{
  box-shadow: 0 8px 18px rgba(0,0,0,.30);
}
#stats-view .stat-controls .stat-value{
  min-width: 26px;
  padding: 2px 6px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
}

#stats-view .stat-row[data-cat="attaque"]{ border-left: 8px solid rgba(236,79,33,.95); }
#stats-view .stat-row[data-cat="service"]{ border-left: 8px solid rgba(244,154,30,.95); }
#stats-view .stat-row[data-cat="bloc"]{ border-left: 8px solid rgba(73,146,219,.95); }
#stats-view .stat-row[data-cat="reception"]{ border-left: 8px solid rgba(158,206,9,.95); }
#stats-view .stat-row[data-cat="defense"]{ border-left: 8px solid rgba(0,137,123,.95); }
#stats-view .stat-row[data-cat="passe"]{ border-left: 8px solid rgba(142,36,170,.95); }

#stats-view .stat-row{
  background: rgba(255,255,255,0.035);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 14px;
  padding: 10px 10px;
  margin: 10px 0;
  box-shadow: 0 8px 20px rgba(0,0,0,0.28);
}
#stats-view .stat-row:hover{ background: rgba(255,255,255,0.05); }

#stats-view .stat-row[data-cat="attaque"]{ background: linear-gradient(90deg, rgba(255,82,82,0.16), rgba(0,0,0,0.10)); }
#stats-view .stat-row[data-cat="service"]{ background: linear-gradient(90deg, rgba(0,230,118,0.14), rgba(0,0,0,0.10)); }
#stats-view .stat-row[data-cat="bloc"]{ background: linear-gradient(90deg, rgba(255,145,0,0.14), rgba(0,0,0,0.10)); }
#stats-view .stat-row[data-cat="reception"]{ background: linear-gradient(90deg, rgba(64,196,255,0.14), rgba(0,0,0,0.10)); }
#stats-view .stat-row[data-cat="defense"]{ background: linear-gradient(90deg, rgba(105,240,174,0.12), rgba(0,0,0,0.10)); }
#stats-view .stat-row[data-cat="passe"]{ background: linear-gradient(90deg, rgba(179,136,255,0.12), rgba(0,0,0,0.10)); }

#stats-view .stat-label{
  font-weight: 900;
  letter-spacing: .2px;
  display:flex;
  align-items:center;
  gap:8px;
}
#stats-view .stat-row[data-cat="attaque"] .stat-label::before{ content:"üéØ"; }
#stats-view .stat-row[data-cat="service"] .stat-label::before{ content:"üöÄ"; }
#stats-view .stat-row[data-cat="bloc"] .stat-label::before{ content:"üß±"; }
#stats-view .stat-row[data-cat="reception"] .stat-label::before{ content:"üõ°Ô∏è"; }
#stats-view .stat-row[data-cat="defense"] .stat-label::before{ content:"üß§"; }
#stats-view .stat-row[data-cat="passe"] .stat-label::before{ content:"üéõÔ∏è"; }

#stats-view .btn-stat-minus,
#stats-view .btn-stat-plus{
  border-radius: 999px;
  width: 34px;
  height: 34px;
  font-weight: 900;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(0,0,0,0.22);
}
#stats-view .btn-stat-plus:hover{ filter: brightness(1.08); }
#stats-view .btn-stat-minus:hover{ filter: brightness(1.08); }

#player-stats-summary{
  margin-top: 10px;
  padding: 12px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.10);
  background: linear-gradient(135deg, rgba(0,119,255,0.10), rgba(0,0,0,0.22));
}
#player-stats-summary h3{ margin-top:0; }
#player-stats-summary strong{ color:#fff; }

#player-report-text{
  background: rgba(0,0,0,.25) !important;
}
/* Distinctions du match (MVP / soutien) */
    #match-awards {
      margin-top: 10px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #18191c;
    }
    #match-awards h3 {
      margin: 0 0 6px;
      font-size: 14px;
    }
    .award-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .award-row label {
      flex: 0 0 140px;
      font-size: 12px;
    }
    .award-row select {
      flex: 1 1 auto;
      border-radius: 6px;
      border: 1px solid #555;
      background: #171717;
      color: #fff;
      font-size: 12px;
      padding: 3px 6px;
    }

    /* Export / import saison compl√®te */
    #season-transfer {
      margin-top: 8px;
      padding: 6px;
      border-radius: 6px;
      background: #252628;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #season-transfer textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #171717;
      color: #eee;
      font-size: 12px;
      padding: 4px 6px;
      resize: vertical;
      font-family: "SF Mono","Consolas",monospace;
    }
    #season-transfer button {
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    #btn-export-season {
      background: #00c853;
      color: #fff;
    }
    #btn-import-season {
      background: #0077ff;
      color: #fff;
    }

    /* Fiche individuelle */
    #player-report-text {
      width: 100%;
      min-height: 90px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #171717;
      color: #eee;
      padding: 6px;
      resize: vertical;
      font-size: 12px;
      font-family: "SF Mono","Consolas",monospace;
      margin-top: 4px;
      margin-bottom: 6px;
    }
    #btn-player-report-copy {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      background: #00c853;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }
  
/* ===== Dashboard (v2 lisible + export) ===== */
#dash-actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin:8px 0 12px;
}
#dash-actions .btn-dash{
  border:1px solid rgba(255,255,255,.18);
  background:#111;
  color:#fff;
  padding:7px 10px;
  border-radius:10px;
  cursor:pointer;
  font-size:12px;
}
#dash-actions .btn-dash:hover{ filter:brightness(1.08); }

.dash-section{
  margin-top:14px;
  padding:12px;
  border-radius:14px;
  background: rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.08);
}
.dash-team{ border-left:6px solid #2e7d32; }
.dash-opp{ border-left:6px solid #c62828; }
.dash-compare{ border-left:6px solid #1565c0; }
.dash-note{
  margin-top:10px;
  font-size:12px;
  color:#cfcfcf;
  opacity:.95;
}
.dash-opp-grid, .dash-compare-grid{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.dash-opp-row, .dash-compare-row{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  background: rgba(0,0,0,0.25);
  border:1px solid rgba(255,255,255,0.06);
}
.dash-opp-label, .dash-compare-label{ color:#eee; font-weight:600; }
.dash-opp-val, .dash-compare-val{ color:#ddd; text-align:right; }


/* Highlights (fun + lisible) */
#dash-highlights-summary{
  margin-top:10px;
  padding:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  border-left:8px solid #d81b60;
  background:
    linear-gradient(135deg, rgba(216,27,96,0.12), rgba(0,119,255,0.06)),
    rgba(0,0,0,0.22);
}
#dash-highlights-summary h3{
  margin:0 0 8px 0;
}
.dash-hl-row{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  background: rgba(0,0,0,0.25);
  border:1px solid rgba(255,255,255,0.06);
  margin:8px 0;
}
.dash-hl-label{ color:#fff; font-weight:700; }
.dash-hl-val{ color:#ddd; text-align:right; font-weight:600; }
.dash-pill{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  margin-left:6px;
  font-size:12px;
  white-space:nowrap;
}
.dash-pill.pink{ border-color: rgba(216,27,96,0.45); background: rgba(216,27,96,0.12); }
.dash-pill.blue{ border-color: rgba(0,119,255,0.45); background: rgba(0,119,255,0.12); }
.dash-pill.green{ border-color: rgba(0,200,83,0.45); background: rgba(0,200,83,0.12); }
.dash-pill.orange{ border-color: rgba(255,152,0,0.45); background: rgba(255,152,0,0.12); }

/* ===== Rallye (v2 flottant, d√©pla√ßable, multi D√©fense/Passe) ===== */

#rally-overlay-backdrop{
  display:none; /* plus de blocage √©cran */
}
#rally-overlay-panel{
  position:fixed;
  top:120px;
  right:18px;
  width:380px;
  max-width:calc(100vw - 36px);
  background:#202124;
  border:1px solid rgba(255,255,255,0.12);
  border-radius:16px;
  box-shadow:0 14px 38px rgba(0,0,0,0.55);
  padding:10px 10px 12px;
  pointer-events:auto;
}
#rally-drag-handle{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-radius:12px;
  background:rgba(255,255,255,0.06);
  cursor:move;
  user-select:none;
  font-weight:700;
}
#rally-drag-handle small{
  font-weight:500;
  opacity:.85;
}
#rally-close-x{ pointer-events:auto; z-index:5; 
  border:0;
  background:transparent;
  color:#fff;
  font-size:18px;
  cursor:pointer;
  padding:2px 6px;
  border-radius:8px;
}
#rally-close-x:hover{ background:rgba(255,255,255,0.08); }

#rally-overlay-hint{ margin:8px 6px 10px; font-size:12px; color:#ddd; opacity:.95; }

#rally-player-list{
  display:none;
}
#rally-multi-wrap{
  display:none;
  gap:10px;
}
.rally-col{
  flex:1;
  min-width:0;
  padding:8px;
  border-radius:12px;
  background:rgba(0,0,0,0.20);
  border:1px solid rgba(255,255,255,0.06);
}
.rally-col h4{
  margin:0 0 8px;
  font-size:13px;
  letter-spacing:.2px;
}
.rally-col.def{ border-left:5px solid #2e7d32; }
.rally-col.pass{ border-left:5px solid #f9a825; }

.rally-player-btn{
  width:100%;
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  margin:6px 0;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(255,255,255,0.04);
  color:#fff;
  cursor:pointer;
  font-size:12px;
}
.rally-player-btn:hover{ filter:brightness(1.12); }
.rally-player-btn .rally-count{ opacity:.9; font-weight:700; }

#rally-close-btn{
  width:100%;
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.12);
  background:#111;
  color:#fff;
  cursor:pointer;
  display:none; /* only in multi */
}
#rally-close-btn:hover{ filter:brightness(1.08); }


/* =========================
   HELP / TUTORIEL (FUNKY)
   ========================= */
#help.help-page{
  background: transparent;
}
#help-container{
  padding-bottom: 16px;
}
#help-container #help{
  background: transparent;
}
#help .help-back{
  background:#171717;
  color:#fff;
  border:1px solid #4a4a4a;
  border-radius:999px;
  padding:8px 14px;
  font-size:13px;
  cursor:pointer;
}
#help .help-hero{
  margin-top:10px;
  padding:14px;
  border-radius:16px;
  background: linear-gradient(135deg, rgba(41,182,246,0.22), rgba(0,230,118,0.10), rgba(255,179,0,0.12));
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow: 0 10px 24px rgba(0,0,0,0.35);
}
#help .help-hero-top{
  display:flex;
  gap:12px;
  align-items:flex-start;
  justify-content:space-between;
  flex-wrap:wrap;
}
#help .help-hero h2{
  margin:0 0 4px 0;
  letter-spacing:0.2px;
}
#help .help-hero p{
  margin:0;
  color: rgba(255,255,255,0.80);
  font-size: 13px;
  line-height: 1.35;
}
#help .help-badges{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
#help .help-badge{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(0,0,0,0.25);
  color:#fff;
  white-space:nowrap;
}
#help .badge-blue{ border-color: rgba(41,182,246,0.55); }
#help .badge-green{ border-color: rgba(0,230,118,0.55); }
#help .badge-amber{ border-color: rgba(255,179,0,0.55); }
#help .badge-pink{ border-color: rgba(255,82,82,0.55); }

#help .help-rule{
  margin-top:12px;
  padding:12px;
  border-radius:14px;
  background: rgba(0,0,0,0.25);
  border: 1px solid rgba(255,255,255,0.10);
}
#help .help-rule h3{
  margin:0 0 6px 0;
  font-size:14px;
}
#help .help-rule ul{
  margin:8px 0 0 18px;
  padding:0;
  color: rgba(255,255,255,0.86);
  font-size:13px;
  line-height:1.45;
}
#help .help-rule li{
  margin:6px 0;
}
#help .help-rule code{
  background: rgba(0,0,0,0.35);
  padding: 2px 6px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.10);
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 12px;
}

#help .help-grid{
  margin-top:12px;
  display:grid;
  grid-template-columns: repeat(12, 1fr);
  gap:10px;
}
#help .help-card{
  grid-column: span 12;
  background:#303134;
  border-radius:14px;
  padding:12px;
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
}
@media (min-width: 860px){
  #help .help-card.span-6{ grid-column: span 6; }
  #help .help-card.span-4{ grid-column: span 4; }
  #help .help-card.span-8{ grid-column: span 8; }
}
#help .help-card h3{
  margin:0 0 6px 0;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:8px;
}
#help .help-card p{
  margin:0 0 8px 0;
  color: rgba(255,255,255,0.84);
  font-size:13px;
  line-height:1.45;
}
#help .help-card ul{
  margin:6px 0 0 18px;
  padding:0;
  color: rgba(255,255,255,0.86) !important;
  font-size:13px !important;
  line-height:1.45;
}
#help .help-kbd{
  display:inline-block;
  padding:2px 8px;
  border-radius:8px;
  background: rgba(0,0,0,0.25);
  border: 1px solid rgba(255,255,255,0.12);
  font-size:12px;
  margin:0 2px;
}
#help .accent{
  color:#29b6f6;
  font-weight:700;
}
#help .accent2{
  color:#00e676;
  font-weight:700;
}
#help .accent3{
  color:#ffb300;
  font-weight:700;
}
#help .help-callout{
  margin-top:12px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.10);
  background: linear-gradient(135deg, rgba(0,0,0,0.25), rgba(41,182,246,0.08));
}
#help .help-callout h3{
  margin:0 0 6px 0;
  font-size:14px;
}
#help .help-callout p{
  margin:0;
  color: rgba(255,255,255,0.84);
  font-size:13px;
  line-height:1.45;
}
#help .help-footer{
  margin-top:10px;
  text-align:center;
  color: rgba(255,255,255,0.65);
  font-size:12px;
}
#help .help-divider{
  height:1px;
  background: rgba(255,255,255,0.10);
  margin:10px 0;
}



/* ===== Match I/O (export/import) ===== */
#matchio-overlay{
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
}
#matchio-panel{
  width: min(860px, 96vw);
  max-height: min(78vh, 740px);
  background: rgba(28,28,30,0.92);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,0.55);
  overflow: hidden;
}
.matchio-head{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 12px;
  padding: 14px 16px;
  background: linear-gradient(90deg, rgba(0,119,255,0.22), rgba(255,46,146,0.18), rgba(255,153,0,0.16));
  border-bottom: 1px solid rgba(255,255,255,0.10);
  cursor: move;
}
.matchio-title{ font-weight: 900; letter-spacing: .2px; }
.matchio-sub{ font-size: 12px; opacity: .88; margin-top: 2px; }
.matchio-x{
  border: none;
  background: rgba(255,255,255,0.10);
  color: rgba(255,255,255,0.92);
  width: 34px;
  height: 34px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 20px;
  line-height: 1;
}
.matchio-x:hover{ background: rgba(255,255,255,0.16); }

.matchio-body{ padding: 14px 16px 16px; }
#matchio-text{
  width: 100%;
  min-height: 240px;
  max-height: 44vh;
  resize: vertical;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size: 12px;
  line-height: 1.45;
  color: rgba(255,255,255,0.92);
  background: rgba(10,10,10,0.55);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 14px;
  padding: 12px;
  outline: none;
}
#matchio-text:focus{
  border-color: rgba(0,119,255,0.55);
  box-shadow: 0 0 0 4px rgba(0,119,255,0.18);
}
.matchio-actions{
  display:flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 12px;
}
.matchio-hint{
  margin-top: 12px;
  font-size: 12px;
  opacity: .88;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.08);
  padding: 10px 12px;
  border-radius: 14px;
}


/* ===========================
   FUNKY THEME (terrain + tuto)
   =========================== */
:root{
  --funky-pink:#ff4fd8;
  --funky-cyan:#4de3ff;
  --funky-yellow:#ffe75a;
  --funky-lime:#7cff6b;
  --funky-ink:#0b0d12;
  --funky-glow: 0 0 0 2px rgba(255,255,255,0.10), 0 10px 30px rgba(0,0,0,0.35);
}
body{
  background:
    radial-gradient(1200px 800px at 15% 10%, rgba(255,79,216,0.16), transparent 60%),
    radial-gradient(900px 650px at 90% 20%, rgba(77,227,255,0.14), transparent 55%),
    radial-gradient(1000px 700px at 60% 95%, rgba(255,231,90,0.10), transparent 55%),
    linear-gradient(180deg, #1a1d24 0%, #12141a 55%, #0e1015 100%);
}

/* Terrain */
#court-grid{
  background:
    radial-gradient(800px 420px at 30% 30%, rgba(77,227,255,0.12), transparent 60%),
    radial-gradient(900px 520px at 70% 70%, rgba(255,79,216,0.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.0));
  border: 1px solid rgba(255,255,255,0.14);
  box-shadow: var(--funky-glow);
}
.court-pos{
  background:
    linear-gradient(135deg, rgba(255,255,255,0.08), rgba(0,0,0,0.04)),
    repeating-linear-gradient(
      45deg,
      rgba(255,255,255,0.05) 0px,
      rgba(255,255,255,0.05) 10px,
      rgba(255,255,255,0.02) 10px,
      rgba(255,255,255,0.02) 20px
    );
  border: 1px solid rgba(255,255,255,0.18);
  box-shadow: 0 6px 18px rgba(0,0,0,0.22);
}
.court-pos h3{
  text-shadow: 0 2px 10px rgba(0,0,0,0.35);
}

/* Saisie pro dans les tuiles (micro-alignements) */
.action-row{
  display:flex;
  align-items:center;
  gap:6px;
}
.action-row .skill-tag{
  width:30px;
  min-width:30px;
  text-align:left;
}
.action-row .btn-grid{
  flex:1;
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap:6px;
}
.action-row .btn-grid button{
  min-width:0;
}

/* Banc (petits carr√©s fun, mais lisibles) */
.bench-player{
  box-shadow: 0 8px 20px rgba(0,0,0,0.30);
  border: 1px solid rgba(255,255,255,0.16);
}
.bench-player:focus-visible{
  outline: 3px solid rgba(77,227,255,0.70);
  outline-offset: 2px;
}

/* Tutoriel / Aide */
.help-hero{
  background:
    radial-gradient(800px 400px at 10% 30%, rgba(255,79,216,0.18), transparent 60%),
    radial-gradient(800px 420px at 90% 40%, rgba(77,227,255,0.16), transparent 60%),
    linear-gradient(135deg, rgba(255,255,255,0.08), rgba(0,0,0,0.10));
  border: 1px solid rgba(255,255,255,0.16);
  box-shadow: var(--funky-glow);
}
.help-card{
  border: 1px solid rgba(255,255,255,0.14);
  box-shadow: 0 8px 26px rgba(0,0,0,0.30);
}
.help-badge.badge-pink{ background: rgba(255,79,216,0.18); border: 1px solid rgba(255,79,216,0.35); }
.help-badge.badge-blue{ background: rgba(77,227,255,0.16); border: 1px solid rgba(77,227,255,0.35); }
.help-badge.badge-amber{ background: rgba(255,231,90,0.14); border: 1px solid rgba(255,231,90,0.35); }
.help-badge.badge-green{ background: rgba(124,255,107,0.12); border: 1px solid rgba(124,255,107,0.30); }


.help-page{
  background:
    radial-gradient(900px 420px at 20% 20%, rgba(255,79,216,0.10), transparent 60%),
    radial-gradient(900px 520px at 80% 30%, rgba(77,227,255,0.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.10));
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 14px;
}
.help-rule{
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 12px;
}

/* Temps morts : on retire toute trace de TM tech. (si jamais il restait dans un vieux cache) */
.tm-inline-tech{ display:none !important; }


/* === Floating "Retour au terrain" (toujours visible sur les pages annexes) === */
.floating-back-wrap{
  position: fixed;
  top: 50%;
  transform: translateY(-50%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none; /* container doesn't block; buttons re-enable */
}
.floating-back-wrap.left{ left: 10px; }
.floating-back-wrap.right{ right: 10px; }

.floating-back-btn{
  pointer-events: auto;
  border: 1px solid rgba(255,255,255,.25);
  background: rgba(0,0,0,.45);
  color: #fff;
  border-radius: 999px;
  padding: 10px 12px;
  font-weight: 800;
  letter-spacing: .2px;
  box-shadow: 0 10px 24px rgba(0,0,0,.35);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  cursor: pointer;
  user-select: none;
  touch-action: manipulation;
  opacity: .95;
}
.floating-back-btn:hover{ opacity: 1; }
.floating-back-btn:active{ transform: scale(.98); }

@media (max-width: 520px){
  .floating-back-wrap.left{ left: 6px; }
  .floating-back-wrap.right{ right: 6px; }
  .floating-back-btn{
    padding: 9px 10px;
    font-size: 13px;
  }
}
.floating-back-hidden{ display:none !important; }


/* --- Indicateur Mode Rallye (visible, non bloquant) --- */
#rally-indicator-fixed{
  position: fixed;
  top: 76px;
  right: 14px;
  z-index: 9998;
  display: none;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  font-size: 12px;
  letter-spacing: .3px;
  border: 1px solid rgba(0,230,118,.35);
  background: rgba(0,0,0,.55);
  color: rgba(255,255,255,.92);
  box-shadow: 0 12px 34px rgba(0,0,0,.35);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  pointer-events: none; /* never block clicks */
}
#rally-indicator-fixed .dot{
  width: 10px; height: 10px;
  border-radius: 999px;
  background: rgba(0,230,118,.35);
  box-shadow: 0 0 0 3px rgba(0,230,118,.12);
}
#rally-indicator-fixed.on{
  display: inline-flex;
  border-color: rgba(0,230,118,.65);
}
#rally-indicator-fixed.on .dot{
  background: rgba(0,230,118,.95);
  box-shadow: 0 0 0 4px rgba(0,230,118,.18);
}



/* ===== AJOUT 4x4 Pro Stable : overlay rallye + vue compacte ===== */
/* Overlay Rallye ‚Äì s√©lecteur d‚Äôissue + grille 2√ó2 */
    .rally-issue{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      padding: 8px 6px 10px;
      margin: 2px 0 8px;
    }
    .rally-issue-btn{
      flex: 1 1 0;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color:#fff;
      padding: 10px 0;
      border-radius: 12px;
      font-size: 14px;
      cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .rally-issue-btn.mid{ max-width: 76px; flex: 0 0 76px; }
    .rally-issue-btn.active{
      border-color: rgba(255,255,255,0.40);
      background: rgba(255,255,255,0.14);
      transform: translateY(-1px);
    }

    #rally-matrix-wrap{ margin-top: 4px; }
    .rally-matrix-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .rally-matrix-card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      border-radius: 14px;
      padding: 10px;
    }
    .rally-matrix-card.flash{ box-shadow: 0 0 0 2px rgba(255,255,255,0.25); }
    .rally-matrix-card h4{
      margin: 0 0 8px;
      font-size: 13px;
      letter-spacing: .2px;
      opacity: .95;
    }
    .rally-matrix-card > div{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }



    /* --- Pro controls --- */
.pro-pill{
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.06);
  color: #fff;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  cursor: pointer;
}
.pro-pill.active{
  background: rgba(76,175,80,0.22);
  border-color: rgba(76,175,80,0.55);
}
.pro-check{
  display:flex;
  align-items:center;
  gap:4px;
  font-size:12px;
  opacity:.9;
}
.pro-badge{
  font-size:12px;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(64,196,255,0.18);
  border: 1px solid rgba(64,196,255,0.45);
  color: #fff;
}

/* --- Action pad on player tiles (7 rubriques x 4 √©tats) --- */
.pro-action-pad{
  display:flex;
  flex-direction:column;
  gap:3px;
  margin-top:2px;
  padding-top:2px;
  border-top: 1px solid rgba(255,255,255,0.10);
}
.pro-skill-row{
  display:grid;
  grid-template-columns: 28px repeat(4, 1fr);
  gap:6px;
  align-items:center;
}
.pro-skill-label{
  font-size: 10px;
  opacity: .9;
  text-align:center;
  padding: 3px 0;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.04);
}
.pro-out-btn{
  padding: 3px 0;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: #fff;
  font-size: 12px;
  cursor: pointer;
}

/* Feedback imm√©diat au toucher (desktop + mobile) */
.pro-out-btn.pressed{
  background: rgba(255,255,255,0.14);
  border-color: rgba(255,255,255,0.45) !important;
  transform: translateY(1px);
}
.pro-out-btn:active{
  filter: brightness(1.12);
}

.pro-out-btn:hover{ background: rgba(255,255,255,0.10); }

.pro-out-btn.tapped{
  background: rgba(0,230,118,0.22);
  border-color: rgba(0,230,118,0.75) !important;
  box-shadow: 0 0 0 2px rgba(0,230,118,0.18) inset;
}
.pro-out-btn.undone{
  background: rgba(255,193,7,0.22);
  border-color: rgba(255,193,7,0.80) !important;
  box-shadow: 0 0 0 2px rgba(255,193,7,0.18) inset;
}

#tiny-toast{
  position: fixed;
  left: 50%;
  bottom: 16px;
  transform: translateX(-50%);
  padding: 8px 10px;
  border-radius: 12px;
  background: rgba(0,0,0,0.72);
  color: #fff;
  font-size: 12px;
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease;
}
#tiny-toast.show{
  opacity: 1;
  transform: translateX(-50%) translateY(-2px);
}
@media (prefers-reduced-motion: reduce){
  #tiny-toast{ transition:none; }
}

.pro-out-btn[data-outcome="plus"]{ border-color: rgba(0,230,118,0.35); }
.pro-out-btn[data-outcome="minus"]{ border-color: rgba(255,82,82,0.35); }
.pro-out-btn[data-outcome="point"]{ border-color: rgba(64,196,255,0.35); }
.pro-out-btn[data-outcome="fault"]{ border-color: rgba(255,179,0,0.35); }

/* --- Pro action overlay --- */
#pro-action-overlay{
  position: fixed;
  inset: 0;
  display: none;
  align-items: flex-end;
  justify-content: center;
  z-index: 9999;
}
#pro-action-backdrop{
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.55);
}
#pro-action-panel{
  position: relative;
  width: min(520px, calc(100vw - 16px));
  margin: 0 0 12px 0;
  background: #11161c;
  border: 1px solid rgba(255,255,255,0.16);
  border-radius: 14px;
  box-shadow: 0 14px 40px rgba(0,0,0,0.55);
  padding: 12px;
}
#pro-action-title{
  font-size: 13px;
  opacity: .9;
  margin-bottom: 10px;
  display:flex;
  justify-content: space-between;
  align-items:center;
  gap:10px;
}
#pro-action-grid{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}
.pro-action-choice{
  padding: 14px 10px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: #fff;
  font-size: 16px;
  cursor:pointer;
}
.pro-action-choice:hover{ background: rgba(255,255,255,0.10); }

/* √âtats: + / - / P / F */
.pro-action-choice[data-outcome="plus"]{ border-color: rgba(0,230,118,0.55); }
.pro-action-choice[data-outcome="minus"]{ border-color: rgba(255,82,82,0.55); }
.pro-action-choice[data-outcome="point"]{ border-color: rgba(64,196,255,0.55); }
.pro-action-choice[data-outcome="fault"]{ border-color: rgba(255,145,0,0.55); }

/* --- Rally bar : ajoute P/F --- */
.rally-group .rally-btn[data-outcome="point"]{
  background: rgba(64,196,255,0.18);
  border-color: rgba(64,196,255,0.55);
  color:#fff;
}
.rally-group .rally-btn[data-outcome="fault"]{
  background: rgba(255,145,0,0.18);
  border-color: rgba(255,145,0,0.55);
  color:#fff;
}

/* Overlay rallye */
    #rally-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #rally-overlay-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
    }

    /* --- Fix: en mode Rally compact, le backdrop ne doit PAS bloquer les clics sur le score & stats adverses --- */
    body.rally-view #rally-overlay-backdrop{
      pointer-events: none;
      /* on garde un l√©ger voile visuel sans bloquer */
      background: rgba(0, 0, 0, 0.18);
    }
    #rally-overlay-panel {
      position: fixed;
      right: 18px;
      top: 110px;
      background: #202124;
      border-radius: 14px;
      padding: 12px;
      width: min(360px, calc(100vw - 36px));
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 14px 50px rgba(0,0,0,0.65);
      z-index: 1;
    }

    /* Accent "funky" selon la rubrique ouverte */
    #rally-overlay-panel::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width:8px;
      border-radius:14px 0 0 14px;
      opacity:.95;
      background: rgba(255,255,255,0.08);
    }
    #rally-overlay-panel[data-cat="attaque"]::before{ background: rgba(255,82,82,0.95); }
    #rally-overlay-panel[data-cat="service"]::before{ background: rgba(0,230,118,0.95); }
    #rally-overlay-panel[data-cat="bloc"]::before{ background: rgba(255,145,0,0.95); }
    #rally-overlay-panel[data-cat="reception"]::before{ background: rgba(64,196,255,0.95); }
    #rally-overlay-panel[data-cat="defense"]::before{ background: rgba(105,240,174,0.95); }
    #rally-overlay-panel[data-cat="passe"]::before{ background: rgba(179,136,255,0.95); }
    #rally-overlay-panel[data-cat="relance"]::before{ background: rgba(255,235,59,0.92); }
    #rally-overlay-panel[data-cat="rally"]::before{ background: linear-gradient(180deg, rgba(105,240,174,0.95), rgba(179,136,255,0.95)); }

    #rally-overlay-panel[data-cat="attaque"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(255,82,82,0.22), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="service"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(0,230,118,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="bloc"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(255,145,0,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="reception"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(64,196,255,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="defense"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(105,240,174,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="passe"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(179,136,255,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="relance"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(255,235,59,0.18), rgba(255,255,255,0.06)); }
    #rally-overlay-panel[data-cat="rally"] #rally-drag-handle{ background: linear-gradient(135deg, rgba(105,240,174,0.20), rgba(179,136,255,0.16)); }

    #rally-overlay-title {
      margin: 0 0 4px;
      font-size: 16px;
    }
    #rally-overlay-hint {
      margin: 0 0 8px;
      font-size: 11px;
      color: #ccc;
    }
    #rally-player-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    .rally-player-btn {
      flex: 1 1 45%;
      border-radius: 999px;
      border: 1px solid #0077ff;
      background: #171717;
      color: #fff;
      padding: 6px 8px;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
    }
    .rally-player-btn span {
      display: inline-block;
      margin-right: 4px;
      font-weight: 600;
    }

    /* Boutons joueur¬∑euses : bordure accord√©e √† la rubrique */
    #rally-overlay-panel[data-cat="attaque"] .rally-player-btn{ border-color: rgba(255,82,82,0.9); }
    #rally-overlay-panel[data-cat="service"] .rally-player-btn{ border-color: rgba(0,230,118,0.85); }
    #rally-overlay-panel[data-cat="bloc"] .rally-player-btn{ border-color: rgba(255,145,0,0.85); }
    #rally-overlay-panel[data-cat="reception"] .rally-player-btn{ border-color: rgba(64,196,255,0.85); }
    #rally-overlay-panel[data-cat="defense"] .rally-player-btn{ border-color: rgba(105,240,174,0.85); }
    #rally-overlay-panel[data-cat="passe"] .rally-player-btn{ border-color: rgba(179,136,255,0.85); }
    #rally-overlay-panel[data-cat="relance"] .rally-player-btn{ border-color: rgba(255,235,59,0.75); }
    #rally-overlay-panel[data-cat="rally"] .rally-player-btn{ border-color: rgba(179,136,255,0.55); }

    #rally-overlay-panel .rally-player-btn:hover{
      background: rgba(255,255,255,0.06);
      transform: translateY(-1px);
    }
    .rally-count {
  margin-left: 4px;
  font-weight: 400;
  color: #ccc;
}
/* ===== Rally View Switch (compact tablet rally) ===== */
/* Objectif: en mode Rallye, n'afficher que le SCORE + STATS ADV + overlay Rallye. */
body.rally-view #app-title,
body.rally-view #team-name-bar,
body.rally-view #btn-toggle-roster,
body.rally-view #btn-dashboard,
body.rally-view #btn-history,
body.rally-view #btn-help,
body.rally-view #roster,
body.rally-view #bench,
body.rally-view #stats-view,
body.rally-view #s-view,
body.rally-view #dashboard,
body.rally-view #history,
body.rally-view #help{
  display:none !important;
}

/* En mode Rallye, on ne garde dans le "terrain" que : SCORE + STATS ADV.
   (Important : #score-section et #opponent sont des enfants de #court, pas du #main-view.) */
body.rally-view #court{
  display:block !important;
  padding-top:10px;
}
body.rally-view #court > :not(#score-section):not(#opponent){
  display:none !important;
}

/* Laisse de la place √† droite pour l'overlay Rallye (panneau fixe) */
body.rally-view #main-view{
  padding-top:10px;
  padding-right:420px;
}


/* ===== /AJOUT ===== */

/* ===== Storytelling (dashboard) ‚Äì lisible & agr√©able ===== */
.dash-read-body{ display:block; }
.story-wrap{ display:flex; flex-direction:column; gap:12px; }
.story-topline{
  display:flex; gap:12px; align-items:flex-start;
  padding:12px 12px;
  border-radius:16px;
  background: rgba(0,0,0,0.28);
  border:1px solid rgba(255,255,255,0.10);
}
.story-topline .story-icon{
  width:34px; height:34px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.12);
  flex: 0 0 auto;
  font-size:18px;
}
.story-topline .story-main{ flex:1; min-width:0; }
.story-topline .story-title{
  font-weight:800;
  font-size:14px;
  margin:0 0 4px 0;
}
.story-topline .story-sub{
  margin:0;
  color:#ddd;
  font-size:13px;
  line-height:1.35;
}
.story-kpis{
  display:flex; gap:8px; flex-wrap:wrap;
  margin-top:8px;
}
.story-kpi{
  display:inline-flex; align-items:center; gap:6px;
  padding:5px 9px;
  border-radius:999px;
  background: rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
  font-size:12px;
  color:#eee;
  white-space:nowrap;
}
.story-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
}
@media (min-width: 900px){
  .story-grid{ grid-template-columns: 1fr 1fr; }
}
.story-card{
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.10);
  background:
    linear-gradient(135deg, rgba(255,255,255,0.06), rgba(0,0,0,0.18));
}
.story-card h4{
  margin:0 0 6px 0;
  font-size:13px;
  font-weight:850;
  display:flex;
  align-items:center;
  gap:8px;
}
.story-card p{
  margin:0;
  color:#e6e6e6;
  font-size:13px;
  line-height:1.35;
}
.story-card .mini{
  margin-top:6px;
  color:#cfcfcf;
  font-size:12px;
  opacity:.95;
}
.story-card.good{ border-left:6px solid rgba(0,200,83,0.65); }
.story-card.bad{ border-left:6px solid rgba(255,82,82,0.65); }
.story-card.prio{ border-left:6px solid rgba(255,193,7,0.65); }
.story-card.neutral{ border-left:6px solid rgba(130,130,130,0.55); }
.story-card.trophy{ border-left:6px solid rgba(156,39,176,0.60); }
.story-badge{
  display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px;
  border-radius:10px;
  background: rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.12);
  flex:0 0 auto;
}


.story-table-wrap{ margin-top:10px; }
.story-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 8px;
  font-size:12px;
}
.story-table th{
  text-align:left;
  font-weight:800;
  color:#eaeaea;
  font-size:11px;
  letter-spacing:.25px;
  opacity:.9;
  padding:0 8px 4px;
}
.story-table td{
  padding:10px 10px;
  background: rgba(0,0,0,0.22);
  border: 1px solid rgba(255,255,255,0.08);
  color:#f0f0f0;
}
.story-table tr td:first-child{
  border-radius:12px 0 0 12px;
  font-weight:800;
  white-space:nowrap;
}
.story-table tr td:last-child{ border-radius:0 12px 12px 0; text-align:right; white-space:nowrap; }
.story-table .muted{ color: rgba(255,255,255,0.72); font-weight:600; }
.story-metrics{
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.story-metric{
  display:inline-flex;
  gap:6px;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  font-size:12px;
  color:#fff;
}
.story-metric b{ font-weight:900; }


/* =========================
   REPORTS / STORYTELLING ‚Äì PRO READ (GLOBAL)
   Objectif : rendre lisible partout (dashboard, stats joueurs, historique, cl√¥ture).
   ========================= */
.report-preview{
  margin: 10px 0 10px;
  padding: 12px 12px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.22));
  box-shadow: 0 10px 30px rgba(0,0,0,.28);
      width:100%;
      box-sizing:border-box;
    }
.report-preview:empty{ display:none; }

.pretty-report{
  font-size: 13px;
  line-height: 1.55;
  color: rgba(255,255,255,.90);
}
.pretty-report p{ margin: 0 0 8px; }
.pretty-report p:last-child{ margin-bottom:0; }

.pretty-report .pr-title{
  font-weight: 900;
  font-size: 14px;
  margin: 0 0 8px;
  letter-spacing: .2px;
}
.pretty-report .pr-sub{
  color: rgba(255,255,255,.72);
  font-size: 12px;
  margin: 0 0 10px;
}

.pretty-report ul{
  margin: 6px 0 10px 18px;
  padding: 0;
}
.pretty-report li{ margin: 2px 0; }

.pretty-report .pr-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 5px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  font-size: 12px;
  margin: 0 6px 6px 0;
  white-space: nowrap;
}
.pretty-report .pr-hr{
  height:1px;
  background: rgba(255,255,255,.10);
  border:0;
  margin: 10px 0;
}

.pretty-report .pr-tag{
  font-weight: 800;
  border-radius: 10px;
  padding: 2px 8px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.10);
  margin-right: 6px;
}

.pretty-report .pr-note{
  color: rgba(255,255,255,.75);
  font-size: 12px;
}

textarea.history-text-long, textarea.history-text-short, #player-report-text, #match-io-json, #import-match-json, #export-match-json{
  line-height: 1.35;
}


/* =========================
   PLAYER DIAGNOSTICS (TAUX)
   ========================= */
.diag-wrap{
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.22));
  box-shadow: 0 10px 30px rgba(0,0,0,.32);
  padding: 12px;
  overflow:hidden;
}


.diag-toggle-row .btn-dash{
  border-radius: 999px;
  padding: 10px 14px;
  font-weight: 800;
}
.diag-toggle-note{
  padding:6px 10px;
  border:1px solid rgba(255,255,255,.10);
  border-radius:999px;
  background: rgba(0,0,0,.18);
}

/* Print: always show diagnostics */
@media print{
  #player-diagnostics{ display:block !important; }
  .diag-toggle-row{ display:none !important; }
}

diag-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
.diag-head h3{ margin:0; font-size:15px; letter-spacing:.2px; }
.diag-sub{ margin:0; font-size:12px; color: rgba(255,255,255,.72); }
.diag-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
}
@media (min-width: 860px){
  .diag-grid{ grid-template-columns: 1fr 1fr; }
}
.diag-card{
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  padding:10px;
}
.diag-card h4{ margin:0 0 8px 0; font-size:13px; }
.diag-kpis{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin: 6px 0 10px;
}
.diag-pill{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color:#fff;
  white-space:nowrap;
}
.diag-pill.good{ border-color: rgba(0,230,118,.55); background: rgba(0,230,118,.12); }
.diag-pill.warn{ border-color: rgba(255,145,0,.55); background: rgba(255,145,0,.12); }
.diag-pill.bad{ border-color: rgba(255,82,82,.55); background: rgba(255,82,82,.12); }
.diag-pill.info{ border-color: rgba(64,196,255,.55); background: rgba(64,196,255,.12); }

.diag-table{
  width:100%;
  border-collapse: collapse;
  font-size:12px;
}
.diag-table th,
.diag-table td{
  padding:7px 8px;
  border-bottom:1px solid rgba(255,255,255,.10);
  text-align:right;
  white-space:nowrap;
}
.diag-table th:first-child,
.diag-table td:first-child{
  text-align:left;
  font-weight:800;
}
.diag-table th{
  color: rgba(255,255,255,.78);
  font-weight:700;
  position:sticky;
  top:0;
  background: rgba(0,0,0,.22);
  backdrop-filter: blur(6px);
}
.diag-row-hint{
  margin-top:8px;
  font-size:12px;
  color: rgba(255,255,255,.78);
  line-height:1.35;
}

    /* === Diagnostics modal (PRO) === */
    #diag-modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      z-index: 99999;
    }
    #diag-modal{
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      width: min(980px, calc(100vw - 18px));
      max-height: calc(100vh - 18px);
      overflow: auto;
      background: rgba(20,20,24,.96);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 14px 14px 18px;
    }
    #diag-modal .diag-modal-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position: sticky; top: 0;
      background: rgba(20,20,24,.96);
      padding: 8px 6px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      z-index: 1;
    }
    #diag-modal .diag-modal-title{
      font-weight: 800;
      letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    #diag-modal .diag-modal-close{
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color: #fff;
      border-radius: 999px;
      padding: 6px 10px;
      cursor:pointer;
    }
    #diag-modal .diag-modal-controls{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    #diag-modal .diag-nav-btn{
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color:#fff;
      border-radius: 12px;
      width: 40px;
      height: 34px;
      font-size: 20px;
      font-weight: 900;
      cursor:pointer;
      line-height: 1;
    }
    #diag-modal .diag-nav-btn:active{ transform: translateY(1px); }
    #diag-modal .diag-player-select{
      min-width: 220px;
      max-width: min(52vw, 420px);
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:#fff;
      padding: 6px 10px;
      font-size: 13px;
      cursor:pointer;
    }

    #diag-modal .diag-modal-close:hover{ background: rgba(255,255,255,.10); }
    #diag-modal .diag-modal-body{ padding: 10px 6px 0; }

    /* --- Stats: navigation joueuse (PRO) --- */
    .stats-player-nav{
      display:flex;
      align-items:center;
      gap:10px;
      margin: 10px 0 8px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(8px);
    }
    .stats-player-nav .btn.btn-ghost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color:#fff;
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing:.2px;
    }
    .stats-player-nav .btn.btn-ghost:disabled{
      opacity:.4;
      cursor:not-allowed;
    }
    .stats-player-nav-mid{
      display:flex;
      align-items:center;
      gap:8px;
      flex:1;
      justify-content:center;
      min-width: 0;
    }
    .stats-player-nav-mid .muted{opacity:.8; font-weight:700;}
    #stats-player-select{
      max-width: 420px;
      width: min(420px, 100%);
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff;
      outline:none;
    }
    #stats-player-select option{ background:#111; }

  
/* ===== Lecture intelligente PRO (joueuse) ===== */
.pro-read{ background: rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px 14px 10px; }
.pro-read-title{ font-weight:800; font-size:16px; letter-spacing:.2px; margin:2px 0 6px; }
.pro-read-note{ font-size:12.5px; opacity:.85; line-height:1.45; margin-bottom:10px; }
.pro-read-block{ margin-top:12px; }
.pro-read-subtitle{ font-weight:800; font-size:13px; opacity:.95; margin:0 0 6px; }
.pro-read-lead{ margin:6px 0 10px; line-height:1.55; font-size:13.5px; }
.pro-kpi-row{ display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 10px; }
.pro-pill{ display:inline-flex; gap:6px; align-items:baseline; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.22); font-size:12.5px; }
.pro-read-grid{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:8px; }
@media(min-width: 860px){ .pro-read-grid{ grid-template-columns: 1fr 1fr 1fr; } }
.pro-card{ border-radius:14px; padding:10px 12px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); }
.pro-card-title{ font-weight:800; font-size:13px; margin-bottom:6px; }
.pro-card p{ margin:6px 0; line-height:1.55; }
.pro-card .muted, .pro-read .muted{ opacity:.82; font-size:12.8px; }
.pro-card.good{ box-shadow: inset 0 0 0 1px rgba(46,204,113,.20); }
.pro-card.bad{ box-shadow: inset 0 0 0 1px rgba(231,76,60,.18); }
.pro-card.prio{ box-shadow: inset 0 0 0 1px rgba(241,196,15,.18); }
.pro-sep{ height:1px; background: rgba(255,255,255,.08); margin:12px 0; }


    /* --- REPORT: align√© & lisible (centr√© comme le reste) --- */
    #player-report-preview, #player-report-text { max-width: 100%; }
    #player-report-preview * { max-width: 100%; }
</style>
</head>
<body>
  <!-- VUE PRINCIPALE -->
 <div class="container" id="main-view">
  <h1 id="app-title">Stats de match pro ‚Äì 6x6</h1>

  <div id="team-name-bar">
    <input id="team-name-input" type="text" placeholder="Nom de notre √©quipe" />
    <input id="opponent-name-input" type="text" placeholder="Nom de l'adversaire" />
  </div>

  <button id="btn-toggle-roster">G√©rer l'effectif</button>
  <button id="btn-dashboard">Tableau de bord</button>
  <button id="btn-diagnostics">Diagnostics</button>
  <button id="btn-history">Historique</button>
  <button id="btn-help">Tutoriel</button>

 

    <!-- EFFECTIF -->
    <section id="roster" style="display:none;">
      <h2>Effectif</h2>
      <form id="player-form">
        <input type="hidden" id="player-id" />
        <input id="player-name" type="text" placeholder="Pr√©nom" required />
        <input id="player-number" type="number" placeholder="N¬∞" min="0" />
          <input id="player-license" type="text" placeholder="N¬∞ licence" />
        <select id="player-role">
          <option value="">Poste</option>
          <option value="Passeur">Passeur</option>
          <option value="R√©cep/attaq">R√©cep/attaq</option>
          <option value="Central">Central</option>
          <option value="Libero">Libero</option>
          <option value="Oppos√©">Oppos√©</option>
        </select>
                 <select id="player-color">
           <option value="blue">Bleu</option>
           <option value="green">Vert</option>
           <option value="red">Rouge</option>
           <option value="yellow">Jaune</option>
           <option value="purple">Violet</option>
           <option value="orange">Orange</option>
           <option value="teal">Turquoise</option>
           <option value="pink">Rose</option>
         </select>

        <label style="font-size:11px;color:#ccc;display:flex;align-items:center;gap:4px;">
  <input type="checkbox" id="player-in-match" checked />
  Dans l‚Äôeffectif du match
</label>

        <button type="submit">Enregistrer joueur¬∑euse</button>
      </form>

      <div id="config-transfer">
        <textarea id="config-json" placeholder="Zone de transfert de configuration (export / import)"></textarea>
       <div style="display:flex;flex-wrap:wrap;gap:6px;">
  <button type="button" id="btn-export-config">Exporter la configuration</button>
  <button type="button" id="btn-import-config">Importer la configuration</button>
</div>
<small>
  Export : clique sur ‚ÄúExporter‚Äù, puis colle le texte dans WhatsApp / mail / notes.<br>
  Import : colle ici une configuration re√ßue, puis clique sur ‚ÄúImporter‚Äù.
</small>
</div>

<button type="button" id="btn-validate-match-roster" style="margin:8px 0;">
  Valider l‚Äôeffectif du match
</button>

<ul id="player-list"></ul>
<small>Tout est sauvegard√© dans ton navigateur, m√™me hors ligne.</small>
</section>



    <!-- TERRAIN 6x6 -->
<!-- TERRAIN 6x6 -->
<section id="court" class="no-select">
  <h2>Terrain (6 joueur¬∑euses) üéõÔ∏è</h2>

  <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:6px;">
    <button type="button" id="btn-rotate-court">
      Rotation (sens horaire)
    </button>
    <button type="button" id="btn-rotate-court-ccw">
      Rotation (sens inverse)
    </button>
  </div>

  <div class="court-grid" id="court-grid">


         <!-- Ligne avant -->
         <div class="court-pos" data-pos="AG">
           <div class="pos-header">
             <span class="pos-label">Avant gauche</span>
           </div>
           <select class="pos-select"></select>
           <div class="pos-jersey"></div>
           
           <div class="pro-action-pad" aria-label="Actions (Srv Rec Pas Att Blo Def Rel)">
             <div class="pro-skill-row">
               <div class="pro-skill-label">Srv</div>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="plus" aria-label="Service : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="minus" aria-label="Service : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="point" aria-label="Service : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="fault" aria-label="Service : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rec</div>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="plus" aria-label="R√©ception : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="minus" aria-label="R√©ception : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="point" aria-label="R√©ception : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="fault" aria-label="R√©ception : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Pas</div>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="plus" aria-label="Passe : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="minus" aria-label="Passe : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="point" aria-label="Passe : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="fault" aria-label="Passe : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Att</div>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="plus" aria-label="Attaque : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="minus" aria-label="Attaque : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="point" aria-label="Attaque : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="fault" aria-label="Attaque : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Blo</div>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="plus" aria-label="Bloc : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="minus" aria-label="Bloc : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="point" aria-label="Bloc : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="fault" aria-label="Bloc : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Def</div>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="plus" aria-label="D√©fense : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="minus" aria-label="D√©fense : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="point" aria-label="D√©fense : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="fault" aria-label="D√©fense : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rel</div>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="plus" aria-label="Relance : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="minus" aria-label="Relance : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="point" aria-label="Relance : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="fault" aria-label="Relance : Faute (F)">F</button>
             </div>
           </div>
<div class="pos-jersey"></div>
         </div>
         <div class="court-pos" data-pos="AC">
           <div class="pos-header">
             <span class="pos-label">Avant centre</span>
           </div>
           <select class="pos-select"></select>
           <div class="pos-jersey"></div>
           
           <div class="pro-action-pad" aria-label="Actions (Srv Rec Pas Att Blo Def Rel)">
             <div class="pro-skill-row">
               <div class="pro-skill-label">Srv</div>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="plus" aria-label="Service : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="minus" aria-label="Service : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="point" aria-label="Service : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="fault" aria-label="Service : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rec</div>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="plus" aria-label="R√©ception : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="minus" aria-label="R√©ception : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="point" aria-label="R√©ception : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="fault" aria-label="R√©ception : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Pas</div>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="plus" aria-label="Passe : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="minus" aria-label="Passe : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="point" aria-label="Passe : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="fault" aria-label="Passe : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Att</div>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="plus" aria-label="Attaque : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="minus" aria-label="Attaque : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="point" aria-label="Attaque : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="fault" aria-label="Attaque : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Blo</div>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="plus" aria-label="Bloc : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="minus" aria-label="Bloc : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="point" aria-label="Bloc : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="fault" aria-label="Bloc : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Def</div>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="plus" aria-label="D√©fense : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="minus" aria-label="D√©fense : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="point" aria-label="D√©fense : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="fault" aria-label="D√©fense : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rel</div>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="plus" aria-label="Relance : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="minus" aria-label="Relance : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="point" aria-label="Relance : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="fault" aria-label="Relance : Faute (F)">F</button>
             </div>
           </div>
<div class="pos-jersey"></div>
         </div>
         <div class="court-pos" data-pos="AD">
           <div class="pos-header">
             <span class="pos-label">Avant droit</span>
           </div>
           <select class="pos-select"></select>
           <div class="pos-jersey"></div>
           
           <div class="pro-action-pad" aria-label="Actions (Srv Rec Pas Att Blo Def Rel)">
             <div class="pro-skill-row">
               <div class="pro-skill-label">Srv</div>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="plus" aria-label="Service : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="minus" aria-label="Service : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="point" aria-label="Service : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="fault" aria-label="Service : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rec</div>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="plus" aria-label="R√©ception : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="minus" aria-label="R√©ception : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="point" aria-label="R√©ception : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="fault" aria-label="R√©ception : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Pas</div>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="plus" aria-label="Passe : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="minus" aria-label="Passe : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="point" aria-label="Passe : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="fault" aria-label="Passe : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Att</div>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="plus" aria-label="Attaque : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="minus" aria-label="Attaque : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="point" aria-label="Attaque : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="fault" aria-label="Attaque : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Blo</div>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="plus" aria-label="Bloc : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="minus" aria-label="Bloc : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="point" aria-label="Bloc : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="fault" aria-label="Bloc : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Def</div>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="plus" aria-label="D√©fense : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="minus" aria-label="D√©fense : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="point" aria-label="D√©fense : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="fault" aria-label="D√©fense : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rel</div>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="plus" aria-label="Relance : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="minus" aria-label="Relance : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="point" aria-label="Relance : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="fault" aria-label="Relance : Faute (F)">F</button>
             </div>
           </div>
<div class="pos-jersey"></div>
         </div>

         <!-- Ligne arri√®re -->
         <div class="court-pos" data-pos="ARG">
           <div class="pos-header">
             <span class="pos-label">Arri√®re gauche</span>
           </div>
           <select class="pos-select"></select>
           <div class="pos-jersey"></div>
           
           <div class="pro-action-pad" aria-label="Actions (Srv Rec Pas Att Blo Def Rel)">
             <div class="pro-skill-row">
               <div class="pro-skill-label">Srv</div>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="plus" aria-label="Service : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="minus" aria-label="Service : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="point" aria-label="Service : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="fault" aria-label="Service : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rec</div>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="plus" aria-label="R√©ception : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="minus" aria-label="R√©ception : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="point" aria-label="R√©ception : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="fault" aria-label="R√©ception : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Pas</div>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="plus" aria-label="Passe : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="minus" aria-label="Passe : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="point" aria-label="Passe : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="fault" aria-label="Passe : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Att</div>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="plus" aria-label="Attaque : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="minus" aria-label="Attaque : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="point" aria-label="Attaque : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="fault" aria-label="Attaque : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Blo</div>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="plus" aria-label="Bloc : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="minus" aria-label="Bloc : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="point" aria-label="Bloc : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="fault" aria-label="Bloc : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Def</div>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="plus" aria-label="D√©fense : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="minus" aria-label="D√©fense : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="point" aria-label="D√©fense : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="fault" aria-label="D√©fense : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rel</div>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="plus" aria-label="Relance : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="minus" aria-label="Relance : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="point" aria-label="Relance : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="fault" aria-label="Relance : Faute (F)">F</button>
             </div>
           </div>
<div class="pos-jersey"></div>
         </div>
         <div class="court-pos" data-pos="ARC">
           <div class="pos-header">
             <span class="pos-label">Arri√®re centre</span>
           </div>
           <select class="pos-select"></select>
           <div class="pos-jersey"></div>
           
           <div class="pro-action-pad" aria-label="Actions (Srv Rec Pas Att Blo Def Rel)">
             <div class="pro-skill-row">
               <div class="pro-skill-label">Srv</div>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="plus" aria-label="Service : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="minus" aria-label="Service : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="point" aria-label="Service : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="fault" aria-label="Service : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rec</div>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="plus" aria-label="R√©ception : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="minus" aria-label="R√©ception : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="point" aria-label="R√©ception : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="fault" aria-label="R√©ception : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Pas</div>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="plus" aria-label="Passe : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="minus" aria-label="Passe : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="point" aria-label="Passe : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="fault" aria-label="Passe : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Att</div>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="plus" aria-label="Attaque : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="minus" aria-label="Attaque : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="point" aria-label="Attaque : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="fault" aria-label="Attaque : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Blo</div>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="plus" aria-label="Bloc : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="minus" aria-label="Bloc : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="point" aria-label="Bloc : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="fault" aria-label="Bloc : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Def</div>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="plus" aria-label="D√©fense : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="minus" aria-label="D√©fense : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="point" aria-label="D√©fense : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="fault" aria-label="D√©fense : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rel</div>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="plus" aria-label="Relance : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="minus" aria-label="Relance : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="point" aria-label="Relance : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="fault" aria-label="Relance : Faute (F)">F</button>
             </div>
           </div>
<div class="pos-jersey"></div>
         </div>
       <div class="court-pos" data-pos="ARD">
  <div class="pos-header">
    <span class="pos-label">Arri√®re droit</span>
  </div>
  <select class="pos-select"></select>
  
           <div class="pos-jersey"></div>
           <div class="pro-action-pad" aria-label="Actions (Srv Rec Pas Att Blo Def Rel)">
             <div class="pro-skill-row">
               <div class="pro-skill-label">Srv</div>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="plus" aria-label="Service : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="minus" aria-label="Service : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="point" aria-label="Service : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="service" data-outcome="fault" aria-label="Service : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rec</div>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="plus" aria-label="R√©ception : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="minus" aria-label="R√©ception : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="point" aria-label="R√©ception : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="reception" data-outcome="fault" aria-label="R√©ception : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Pas</div>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="plus" aria-label="Passe : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="minus" aria-label="Passe : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="point" aria-label="Passe : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="passe" data-outcome="fault" aria-label="Passe : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Att</div>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="plus" aria-label="Attaque : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="minus" aria-label="Attaque : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="point" aria-label="Attaque : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="attaque" data-outcome="fault" aria-label="Attaque : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Blo</div>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="plus" aria-label="Bloc : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="minus" aria-label="Bloc : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="point" aria-label="Bloc : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="bloc" data-outcome="fault" aria-label="Bloc : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Def</div>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="plus" aria-label="D√©fense : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="minus" aria-label="D√©fense : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="point" aria-label="D√©fense : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="defense" data-outcome="fault" aria-label="D√©fense : Faute (F)">F</button>
             </div>
             <div class="pro-skill-row">
               <div class="pro-skill-label">Rel</div>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="plus" aria-label="Relance : +">+</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="minus" aria-label="Relance : -">-</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="point" aria-label="Relance : Point (P)">P</button>
               <button type="button" class="pro-out-btn" data-skill="relance" data-outcome="fault" aria-label="Relance : Faute (F)">F</button>
             </div>
           </div>
<div class="pos-jersey"></div>
</div>
</div>

<div id="bench">
  <h3>Banc</h3>
  <div id="bench-list"></div>
</div>

<!-- SCORE DU MATCH -->
<section id="score-section" class="no-select">
  <h2 id="score-title">
    Score du match <span id="score-set-label">(set 1)</span>
  </h2>


      <div id="set-selector-main">
        <span>Set :</span>
        <button class="set-btn-main active" data-set="1">1</button>
        <button class="set-btn-main" data-set="2">2</button>
        <button class="set-btn-main" data-set="3">3</button>
        <button class="set-btn-main" data-set="4">4</button>
        <button class="set-btn-main" data-set="5">5</button>
      </div>

      <div class="score-board">
        <div class="score-team">
          <div class="score-label" id="score-label-nous">Nous</div>
          <div class="score-controls">
            <button class="score-btn-minus" data-team="nous">-</button>
            <span class="score-value" data-team="nous">0</span>
            <button class="score-btn-plus" data-team="nous">+</button>
          </div>
        </div>

        <div class="score-team">
          <div class="score-label" id="score-label-adv">Adversaire</div>
          <div class="score-controls">
            <button class="score-btn-minus" data-team="eux">-</button>
            <span class="score-value" data-team="eux">0</span>
            <button class="score-btn-plus" data-team="eux">+</button>
          </div>
        </div>
      </div>

      <!-- BANDEAU RALLYE -->
      <div id="rally-bar" style="display:none;">
        <div class="rally-group" data-skill="service">
          <span class="rally-label">Service</span>
          <button class="rally-btn" data-skill="service" data-outcome="plus">+</button>
          <button class="rally-btn" data-skill="service" data-outcome="minus">-</button>
          <button class="rally-btn" data-skill="service" data-outcome="point">P</button>
          <button class="rally-btn" data-skill="service" data-outcome="fault">F</button>
        </div>
        <div class="rally-group" data-skill="reception">
          <span class="rally-label">R√©cep.</span>
          <button class="rally-btn" data-skill="reception" data-outcome="plus">+</button>
          <button class="rally-btn" data-skill="reception" data-outcome="minus">-</button>
          <button class="rally-btn" data-skill="reception" data-outcome="point">P</button>
          <button class="rally-btn" data-skill="reception" data-outcome="fault">F</button>
        </div>
        <div class="rally-group" data-skill="passe">
          <span class="rally-label">Passe</span>
          <button class="rally-btn" data-skill="passe" data-outcome="plus">+</button>
          <button class="rally-btn" data-skill="passe" data-outcome="minus">-</button>
          <button class="rally-btn" data-skill="passe" data-outcome="point">P</button>
          <button class="rally-btn" data-skill="passe" data-outcome="fault">F</button>
        </div>
        <div class="rally-group" data-skill="attaque">
          <span class="rally-label">Attaque</span>
          <button class="rally-btn" data-skill="attaque" data-outcome="plus">+</button>
          <button class="rally-btn" data-skill="attaque" data-outcome="minus">-</button>
          <button class="rally-btn" data-skill="attaque" data-outcome="point">P</button>
          <button class="rally-btn" data-skill="attaque" data-outcome="fault">F</button>
        </div>
        <div class="rally-group" data-skill="bloc">
          <span class="rally-label">Bloc</span>
          <button class="rally-btn" data-skill="bloc" data-outcome="plus">+</button>
          <button class="rally-btn" data-skill="bloc" data-outcome="minus">-</button>
          <button class="rally-btn" data-skill="bloc" data-outcome="point">P</button>
          <button class="rally-btn" data-skill="bloc" data-outcome="fault">F</button>
        </div>
        <div class="rally-group" data-skill="defense">
          <span class="rally-label">D√©fense</span>
          <button class="rally-btn" data-skill="defense" data-outcome="plus">+</button>
          <button class="rally-btn" data-skill="defense" data-outcome="minus">-</button>
          <button class="rally-btn" data-skill="defense" data-outcome="point">P</button>
          <button class="rally-btn" data-skill="defense" data-outcome="fault">F</button>
        </div>
        <div class="rally-group" data-skill="relance">
          <span class="rally-label">Relance</span>
          <button class="rally-btn" data-skill="relance" data-outcome="plus">+</button>
          <button class="rally-btn" data-skill="relance" data-outcome="minus">-</button>
          <button class="rally-btn" data-skill="relance" data-outcome="point">P</button>
          <button class="rally-btn" data-skill="relance" data-outcome="fault">F</button>
        </div>
      </div>

      <!-- CONTROLES PRO (service / auto-rotation / lib√©ro) -->
<div id="pro-controls" class="no-select" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
  <div class="pro-serve">
    <span style="font-size:12px; opacity:.85; margin-right:6px;">Service :</span>
    <button type="button" id="btn-serve-nous" class="pro-pill active">Nous</button>
    <button type="button" id="btn-serve-eux" class="pro-pill">Eux</button>
  </div>

  <label class="pro-check">
    <input type="checkbox" id="chk-auto-rotate" checked />
    Rotation auto (side-out)
  </label>

  <label class="pro-check">
    <input type="checkbox" id="chk-auto-libero" checked />
    Lib√©ro auto
  </label>

  <label class="pro-check">
    <input type="checkbox" id="chk-rally-bar" />
    Bandeau rallye
  </label>

  <button type="button" id="btn-open-rally-overlay-bar" class="pro-pill" title="Ouvrir le bandeau rallye">Rallye</button>

  <select id="select-libero-pro" style="min-width:220px;"></select>

  

  <div class="pro-libero-map" style="display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
    <span style="font-size:12px; opacity:.85;">Lib√©ro remplace :</span>
    <select id="select-libero-target-1" style="min-width:220px;"></select>
    <select id="select-libero-target-2" style="min-width:220px;"></select>
    <span style="font-size:11px; opacity:.75;">(priorit√© au choix #1)</span>
  </div>

<span id="libero-active-badge" class="pro-badge" style="display:none;">Lib√©ro sur le terrain</span>
</div>

<!-- TEMPS MORTS ‚Äì VERSION COMPACTE -->
      <div id="timeout-inline" class="no-select" style="margin-top:8px;">
<!-- Temps morts pour notre √©quipe -->
        <div class="tm-inline tm-inline-nous">
          <span class="tm-inline-label">Temps morts nous</span>
          <button type="button" class="tm-dot" data-tm-type="nous" data-tm-index="1"></button>
          <button type="button" class="tm-dot" data-tm-type="nous" data-tm-index="2"></button>
          <span class="tm-inline-count" id="tm-nous-count">0/2</span>
        </div>

        <!-- Temps morts pour l'adversaire -->
        <div class="tm-inline tm-inline-eux">
          <span class="tm-inline-label">Temps morts eux</span>
          <button type="button" class="tm-dot" data-tm-type="eux" data-tm-index="1"></button>
          <button type="button" class="tm-dot" data-tm-type="eux" data-tm-index="2"></button>
          <span class="tm-inline-count" id="tm-eux-count">0/2</span>
        </div>
      </div>
    </section>


    <!-- STATS ADVERSAIRES -->
    <section id="opponent" class="no-select">
      <div class="opp-headbar">
        <h2 id="opponent-title">Stats adversaires <span id="opponent-set-label">(set 1)</span></h2>
        <button type="button" id="btn-toggle-opp-panels" class="btn chip-btn opp-toggle" aria-expanded="false" aria-controls="opp-panels-wrap" title="Afficher / masquer le panneau points & fautes adverses">‚ö° D√©tails</button>
      </div>

      <div id="opp-panels-wrap" class="opp-panels-wrap is-collapsed" aria-hidden="true">


      <div id="opp-point-panel" class="opp-point-panel">
        <div class="opp-point-head">
          <div class="opp-point-title">üî• Point adverse (sans ‚Äúfaute‚Äù chez nous)</div>
          <div class="opp-point-sub">Niveau 1 = juste le score ¬∑ Niveau 2 = score + tag (service / attaque / bloc / autre)</div>
        </div>

        <div class="opp-point-row">
          <div class="opp-point-score" aria-label="Contr√¥le rapide du score adverse">
            <span class="opppt-team" id="opppt-team">Adversaire</span>
            <button type="button" class="opppt-btn minus" data-opppt="minus" aria-label="Retirer 1 point adverse (correction)">‚àí</button>
            <span id="opppt-score-val" aria-live="polite">0</span>
            <button type="button" class="opppt-btn plus" data-opppt="plus" aria-label="Ajouter 1 point adverse (neutre)">+</button>
          </div>

          <div class="opppt-tags" aria-label="Niveau 2 : tag du point adverse (spectaculaire)">
            <button type="button" class="opppt-tag" data-opppt-tag="service">üöÄ Service <small>(+1)</small></button>
            <button type="button" class="opppt-tag" data-opppt-tag="attaque">üéØ Attaque <small>(+1)</small></button>
            <button type="button" class="opppt-tag" data-opppt-tag="bloc">üß± Bloc <small>(+1)</small></button>
            <button type="button" class="opppt-tag" data-opppt-tag="autre">‚ú® Autre <small>(+1)</small></button>
          </div>
        </div>

        <div style="margin-top:8px; font-size:12.5px; opacity:.95;">
          Astuce : tu peux utiliser √ßa quand <b>l‚Äôadversaire marque ‚Äútout seul‚Äù</b> (sans erreur flagrante chez nous).
          √áa met le score √† jour et garde la logique de service/rotation.
        </div>
      
      
      </div>
      <!-- /opp-point-panel -->

      <div id="opp-fault-panel" class="opp-point-panel opp-fault-panel">
        <div class="opp-point-head">
          <div class="opp-point-title">üéÅ Fautes adverses directes (point pour nous)</div>
          <div class="opp-point-sub">Quand <b>l‚Äôadversaire se rate</b> (service dehors, attaque dehors, filet, etc.) et que tu veux juste noter <b>un point pour nous</b> sans attribuer une action chez nous.</div>
        </div>

        <div class="opp-point-row">
          <div class="opp-point-score" aria-label="Contr√¥le rapide du score pour nous (fautes adverses)">
            <span class="opppt-team" id="oppft-team">Nous</span>
            <button type="button" class="opppt-btn minus" data-oppft="minus" aria-label="Retirer 1 point pour nous (correction)">‚àí</button>
            <span id="oppft-score-val" aria-live="polite">0</span>
            <button type="button" class="opppt-btn plus" data-oppft="plus" aria-label="Ajouter 1 point pour nous (neutre)">+</button>
          </div>

          <div class="opppt-tags" aria-label="Tag de la faute adverse (point pour nous)">
            <button type="button" class="opppt-tag" data-oppft-tag="service">üö´ Service <small>(+1 ‚Ä¢ <span data-oppft-count="service">0</span>)</small></button>
            <button type="button" class="opppt-tag" data-oppft-tag="attaque">üéØ Attaque <small>(+1 ‚Ä¢ <span data-oppft-count="attaque">0</span>)</small></button>
            <button type="button" class="opppt-tag" data-oppft-tag="bloc">üß± Bloc <small>(+1 ‚Ä¢ <span data-oppft-count="bloc">0</span>)</small></button>
            <button type="button" class="opppt-tag" data-oppft-tag="autre">‚ú® Autre <small>(+1 ‚Ä¢ <span data-oppft-count="autre">0</span>)</small></button>
          </div>
        </div>

        <div style="margin-top:8px; font-size:12.5px; opacity:.95;">
          Astuce : si tu es en <b>r√©ception</b> et que tu cliques ici ‚Üí c‚Äôest un <b>side‚Äëout</b> (on r√©cup√®re le service) ‚Üí <b>√ßa tourne</b> automatiquement (si rotation auto activ√©e).
        </div>
      </div>

</div>

      <div id="opponent-stats-list">
        <div class="stat-row" data-ocat="service">
          <div class="stat-label">Services</div>
          <div class="stat-controls">
            <button class="btn-stat-minus" data-type="minus">-</button>
            <span class="stat-value opp-value-minus">0</span>
            <span class="stat-sep">fautes / points</span>
            <span class="stat-value opp-value-plus">0</span>
            <button class="btn-stat-plus" data-type="plus">+</button>
          </div>
        </div>
        <div class="stat-row" data-ocat="bloc">
          <div class="stat-label">Bloc</div>
          <div class="stat-controls">
            <span class="stat-sep">points pour eux</span>
            <span class="stat-value opp-value-plus">0</span>
            <button class="btn-stat-plus" data-type="plus">+</button>
          </div>
        </div>
        <div class="stat-row" data-ocat="cadeaux">
          <div class="stat-label">Cadeaux (points offerts)</div>
          <div class="stat-controls">
            <span class="stat-sep">points pour nous</span>
            <span class="stat-value opp-value-plus">0</span>
            <button class="btn-stat-plus" data-type="plus">+</button>
          </div>
        </div>
        <div class="stat-row" data-ocat="points">
          <div class="stat-label">Points (hors service)</div>
          <div class="stat-controls">
            <button class="btn-stat-minus" data-type="minus">-</button>
            <span class="stat-value opp-value-minus">0</span>
            <span class="stat-sep">pour nous / pour eux</span>
            <span class="stat-value opp-value-plus">0</span>
            <button class="btn-stat-plus" data-type="plus">+</button>
          </div>
        </div>
      </div>
    
      </div>
      <!-- /opp-panels-wrap -->
</section>
  </div>
  <!-- FICHE STATS JOUEUSE -->
  <div class="container" id="stats-container" style="display:none;">
    <section id="stats-view" class="no-select">
<p style="margin:10px 0 0; opacity:.95;">üß≤ <b>Nouveau :</b> utilise les boutons flottants <b>Terrain ‚Ü©</b> (gauche + droite) : ils restent visibles m√™me quand tu scroll, sur Stats / Tableau de bord / Historique / Tutoriel.</p>
      <h2 id="stats-player-title">Statistiques :</h2>

      <div class="stats-player-nav" id="stats-player-nav" aria-label="Navigation joueuse">
        <button class="btn btn-ghost" id="btn-stats-prev" type="button" title="Joueuse pr√©c√©dente">‚óÄÔ∏é Pr√©c√©dente</button>
        <div class="stats-player-nav-mid">
          <span class="muted">Joueuse :</span>
          <select id="stats-player-select" aria-label="Choisir une joueuse"></select>
        </div>
        <button class="btn btn-ghost" id="btn-stats-next" type="button" title="Joueuse suivante">Suivante ‚ñ∂Ô∏é</button>
      </div>

      <div class="stats-hero">
        <div>
          <p><strong>Objectif :</strong> lire vite, comprendre vite, corriger vite. Les compteurs sont par set (s√©lecteur) et le rapport se g√©n√®re sur tout le match.</p>
        </div>
        <div class="stats-badges">
          <span class="stats-badge blue">üìà Impact</span>
          <span class="stats-badge orange">‚ö° Œî (delta)</span>
          <span class="stats-badge green">üõ°Ô∏è D√©f/R√©cep</span>
          <span class="stats-badge yellow">üì§ Export</span>
        </div>
      </div>

      <div id="set-selector-stats">
        <span>Set :</span>
        <button class="set-btn-stats active" data-set="1">1</button>
        <button class="set-btn-stats" data-set="2">2</button>
        <button class="set-btn-stats" data-set="3">3</button>
        <button class="set-btn-stats" data-set="4">4</button>
        <button class="set-btn-stats" data-set="5">5</button>
      </div>

      <div id="stats-list">
        <div class="stat-row" data-cat="service">
          <div class="stat-label">Service</div>
          <div class="stat-controls">
            <button class="btn-stat-minus" data-type="minus">-</button>
            <span class="stat-value stat-value-minus">0</span>
            <button class="btn-stat-plus" data-type="plus">+</button>
            <span class="stat-value stat-value-plus">0</span>
            <span class="stat-sep">¬∑</span>
            <button class="btn-stat-fault" data-type="fault">F</button>
            <span class="stat-value stat-value-fault">0</span>
            <button class="btn-stat-point" data-type="point">P</button>
            <span class="stat-value stat-value-point">0</span>
          </div>
        </div>

        <div class="stat-row" data-cat="reception">
          <div class="stat-label">R√©ception</div>
          <div class="stat-controls">
            <button class="btn-stat-minus" data-type="minus">-</button>
            <span class="stat-value stat-value-minus">0</span>
            <button class="btn-stat-plus" data-type="plus">+</button>
            <span class="stat-value stat-value-plus">0</span>
            <span class="stat-sep">¬∑</span>
            <button class="btn-stat-fault" data-type="fault">F</button>
            <span class="stat-value stat-value-fault">0</span>
            <button class="btn-stat-point" data-type="point">P</button>
            <span class="stat-value stat-value-point">0</span>
          </div>
        </div>

        <div class="stat-row" data-cat="passe">
          <div class="stat-label">Passe</div>
          <div class="stat-controls">
            <button class="btn-stat-minus" data-type="minus">-</button>
            <span class="stat-value stat-value-minus">0</span>
            <button class="btn-stat-plus" data-type="plus">+</button>
            <span class="stat-value stat-value-plus">0</span>
            <span class="stat-sep">¬∑</span>
            <button class="btn-stat-fault" data-type="fault">F</button>
            <span class="stat-value stat-value-fault">0</span>
            <button class="btn-stat-point" data-type="point">P</button>
            <span class="stat-value stat-value-point">0</span>
          </div>
        </div>

        <div class="stat-row" data-cat="attaque">
          <div class="stat-label">Attaque</div>
          <div class="stat-controls">
            <button class="btn-stat-minus" data-type="minus">-</button>
            <span class="stat-value stat-value-minus">0</span>
            <button class="btn-stat-plus" data-type="plus">+</button>
            <span class="stat-value stat-value-plus">0</span>
            <span class="stat-sep">¬∑</span>
            <button class="btn-stat-fault" data-type="fault">F</button>
            <span class="stat-value stat-value-fault">0</span>
            <button class="btn-stat-point" data-type="point">P</button>
            <span class="stat-value stat-value-point">0</span>
          </div>
        </div>

        <div class="stat-row" data-cat="bloc">
          <div class="stat-label">Bloc</div>
          <div class="stat-controls">
            <button class="btn-stat-minus" data-type="minus">-</button>
            <span class="stat-value stat-value-minus">0</span>
            <button class="btn-stat-plus" data-type="plus">+</button>
            <span class="stat-value stat-value-plus">0</span>
            <span class="stat-sep">¬∑</span>
            <button class="btn-stat-fault" data-type="fault">F</button>
            <span class="stat-value stat-value-fault">0</span>
            <button class="btn-stat-point" data-type="point">P</button>
            <span class="stat-value stat-value-point">0</span>
          </div>
        </div>

        <div class="stat-row" data-cat="defense">
          <div class="stat-label">D√©fense</div>
          <div class="stat-controls">
            <button class="btn-stat-minus" data-type="minus">-</button>
            <span class="stat-value stat-value-minus">0</span>
            <button class="btn-stat-plus" data-type="plus">+</button>
            <span class="stat-value stat-value-plus">0</span>
            <span class="stat-sep">¬∑</span>
            <button class="btn-stat-fault" data-type="fault">F</button>
            <span class="stat-value stat-value-fault">0</span>
            <button class="btn-stat-point" data-type="point">P</button>
            <span class="stat-value stat-value-point">0</span>
          </div>
        </div>

        <div class="stat-row" data-cat="relance">
          <div class="stat-label">Relance</div>
          <div class="stat-controls">
            <button class="btn-stat-minus" data-type="minus">-</button>
            <span class="stat-value stat-value-minus">0</span>
            <button class="btn-stat-plus" data-type="plus">+</button>
            <span class="stat-value stat-value-plus">0</span>
            <span class="stat-sep">¬∑</span>
            <button class="btn-stat-fault" data-type="fault">F</button>
            <span class="stat-value stat-value-fault">0</span>
            <button class="btn-stat-point" data-type="point">P</button>
            <span class="stat-value stat-value-point">0</span>
          </div>
        </div>
      </div>

      <div id="player-stats-summary">
        <h3>Impact dans le set <span id="player-summary-set">1</span></h3>
        <p>
          Fautes : <strong><span id="player-total-fautes">0</span></strong> ¬∑
          Points : <strong><span id="player-total-points">0</span></strong> ¬∑
          Delta : <strong><span id="player-delta">0</span></strong>
        </p>
        <p>
          Contribution au score du set :
          <strong><span id="player-pct-set-points">0%</span></strong> des points marqu√©s,
          <strong><span id="player-pct-set-fautes">0%</span></strong> des points conc√©d√©s.
        </p>
        <p>
          Sur tout le match :
          <strong><span id="player-pct-match-points">0%</span></strong> des points marqu√©s,
          <strong><span id="player-pct-match-fautes">0%</span></strong> des points conc√©d√©s.
        </p>
      </div>

      <div id="player-smart-read" class="dash-read" style="margin-top:12px;">
          <div class="dash-mini">Lecture intelligente (set + match)</div>
          <div id="player-smart-read-body" class="dash-read-body">
            <div class="dash-read-line"><span class="dash-badge neutral">Info</span>Saisis quelques actions pour obtenir une lecture coach.</div>
          </div>
        </div>

        <div class="diag-toggle-row" style="display:flex; margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="btn-toggle-diagnostics" class="btn-dash" type="button" title="Afficher / masquer le diagnostic d√©taill√©">üìä Diagnostic (PRO)</button>
          <span class="diag-toggle-note" style="opacity:.85; font-size:.92em;">Taux ‚Ä¢ efficacit√© ‚Ä¢ conversion ‚Ä¢ fautes (Set + Match)</span>
        </div>

        <div id="player-diagnostics" class="diag-wrap is-collapsed" style="margin-top:10px; display:none;">
          <!-- Rempli en JS : Diagnostic (taux, efficacit√©, conversion, fautes) -->
        </div>

      <h3>Rapport individuel √† partager</h3>
      <div class="stats-export-bar">
        <button id="btn-player-report-copy" class="btn copy" type="button">G√©n√©rer & copier</button>
        <button id="btn-player-report-share" class="btn share" type="button">Partager</button>
        <button id="btn-player-report-wa" class="btn wa" type="button">WhatsApp</button>
        <button id="btn-player-report-tg" class="btn tg" type="button">Telegram</button>
        <button id="btn-player-report-print" class="btn print" type="button">Imprimer / PDF</button>
      </div>
      <div id="player-report-preview" class="report-preview" aria-label="Aper√ßu rapport joueur"></div>
      <textarea id="player-report-text"
        placeholder="Le rapport est g√©n√©r√© √† partir des stats enregistr√©es (tous sets)."></textarea>
    </section>
  </div>


   <!-- TABLEAU DE BORD -->
  <div class="container" id="dashboard-container" style="display:none;">
    <section id="dashboard" class="no-select">
<h2>Tableau de bord</h2>
      <div id="dash-actions">
        <button id="btn-dashboard-print" class="btn-dash">Imprimer / PDF</button>
        <button id="btn-dashboard-share" class="btn-dash">Partager</button>
        <button id="btn-dashboard-copy" class="btn-dash">Copier</button>
        <button id="btn-dashboard-wa" class="btn-dash">WhatsApp</button>
        <button id="btn-dashboard-tg" class="btn-dash">Telegram</button>
<button id="btn-dashboard-save-match" class="btn-dash">Sauvegarder match</button>
<button id="btn-dashboard-load-match" class="btn-dash">Importer match</button>
<input type="file" id="file-import-match" accept="application/json,.json,.stat2match" style="display:none;" />

      </div>

      <!-- Match I/O (export / import JSON) -->
      <div id="matchio-overlay" style="display:none;">
        <div id="matchio-panel" role="dialog" aria-modal="true" aria-label="Sauvegarde et import de match">
          <div class="matchio-head" id="matchio-drag-handle">
            <div>
              <div class="matchio-title">Match ‚Äî Sauvegarde / Import</div>
              <div class="matchio-sub">Export JSON (relecture vid√©o) ou import pour reprendre un match.</div>
            </div>
            <button id="matchio-close" class="matchio-x" title="Fermer">√ó</button>
          </div>

          <div class="matchio-body">
            <textarea id="matchio-text" placeholder="1) Clique sur ‚ÄúSauvegarder match‚Äù pour g√©n√©rer le JSON
2) Copie/partage le texte
3) Plus tard : colle ici le JSON puis clique sur ‚ÄúImporter‚Äù.

(Option) Tu peux aussi choisir un fichier .json"></textarea>
            <div class="matchio-actions">
              <button id="matchio-pickfile" class="btn-dash">Choisir un fichier‚Ä¶</button>
              <button id="matchio-import" class="btn-dash btn-dash-accent">Importer</button>
              <button id="matchio-copy" class="btn-dash">Copier</button>
              <button id="matchio-download" class="btn-dash">T√©l√©charger .json</button>
            </div>
            <div class="matchio-hint">
              Astuce : tu peux <strong>sauvegarder</strong> m√™me avant de cl√¥turer, revenir dessus, corriger apr√®s vid√©o, puis continuer.
            </div>
          </div>
        </div>
      </div>

      <div id="set-selector-dashboard">
        <span>Set :</span>
        <button class="set-btn-dashboard active" data-set="1">1</button>
        <button class="set-btn-dashboard" data-set="2">2</button>
        <button class="set-btn-dashboard" data-set="3">3</button>
        <button class="set-btn-dashboard" data-set="4">4</button>
        <button class="set-btn-dashboard" data-set="5">5</button>
      </div>

      <div id="dash-score-box">
        <h3 id="dash-score-set-label">Set 1</h3>
        <div id="dash-score-line">
          <span id="dash-team-name-us">Nous</span>
          <span id="dash-score-nous">0</span> -
          <span id="dash-score-eux">0</span>
          <span id="dash-team-name-opponent">Eux</span>
        </div>

        <span id="dash-comment">
          Total de nos fautes estim√©es pour ce set :
          <strong><span id="dash-total-fautes-pour-eux">0</span></strong> (‚âà points offerts).
        </span>
      </div>

      <div id="dash-team-summary" class="dash-section dash-team">
        <h3>Nos stats (set <span id="dash-team-set-label">1</span>)</h3>
        <div id="dash-team-body"></div>
      </div>

            <div id="dash-opponent-summary" class="dash-section dash-opp">
        <h3>Stats adverses (set <span id="dash-opp-set-label">1</span>)</h3>

        <div class="dash-opp-grid">
          <div class="dash-opp-row">
            <div class="dash-opp-label">Services</div>
            <div class="dash-opp-val"><span id="dash-opp-service-fautes">0</span> fautes / <span id="dash-opp-service-points">0</span> points</div>
          </div>

          <div class="dash-opp-row">
            <div class="dash-opp-label">Bloc</div>
            <div class="dash-opp-val"><span id="dash-opp-bloc-points">0</span> points pour eux</div>
          </div>

          <div class="dash-opp-row">
            <div class="dash-opp-label">Cadeaux (points offerts)</div>
            <div class="dash-opp-val"><span id="dash-opp-cadeaux">0</span> points pour nous</div>
          </div>

          <div class="dash-opp-row">
            <div class="dash-opp-label">Points (hors service)</div>
            <div class="dash-opp-val"><span id="dash-opp-points-pourNous">0</span> pour nous / <span id="dash-opp-points-pourEux">0</span> pour eux</div>
          </div>
        </div>

        <div class="dash-note">
          Total de nos fautes estim√©es pour ce set : <strong><span id="dash-total-fautes-pour-eux">0</span></strong> (points offerts)
        </div>
      </div>

      <div id="dash-compare-summary" class="dash-section dash-compare">
        <h3>Comparatif ‚Äì Nous vs Eux</h3>
        <div class="dash-compare-grid">
          <div class="dash-compare-row">
            <div class="dash-compare-label">Actions positives</div>
            <div class="dash-compare-val">Nous : <strong><span id="dash-our-pos">0</span></strong> | Eux : <strong><span id="dash-opp-pos">0</span></strong></div>
          </div>
          <div class="dash-compare-row">
            <div class="dash-compare-label">Actions n√©gatives</div>
            <div class="dash-compare-val">Nous : <strong><span id="dash-our-neg">0</span></strong> | Eux : <strong><span id="dash-opp-neg">0</span></strong></div>
          </div>
          <div class="dash-compare-row">
            <div class="dash-compare-label">Impact fautes</div>
            <div class="dash-compare-val">Nos fautes ‚Üí points adverses : <strong><span id="dash-impact-theirs">0%</span></strong> | Leurs fautes ‚Üí nos points : <strong><span id="dash-impact-ours">0%</span></strong></div>
          </div>
        </div>
      </div>


      <div id="dash-highlights-summary" class="dash-section dash-highlights">
        <h3>‚≠ê Highlights ‚Äì Ce qui ressort</h3>
        <div id="dash-highlights-body"></div>
      </div>

      <div id="dash-read" class="dash-section dash-read">
        <h3>üé¨ Lecture coach (histoire set + match)</h3>
        <div id="dash-read-body" class="dash-read-body">
          <div class="dash-read-line"><span class="dash-badge neutral">Info</span>Saisis quelques points puis reviens ici.</div>
        </div>
      </div>


           <div id="match-awards">
        <h3>Distinctions du match</h3>

        <!-- MVP -->
        <div class="award-row">
          <label for="select-mvp">Joueur¬∑euse du match (MVP)</label>
          <select id="select-mvp">
            <option value="">‚Äî Aucune ‚Äî</option>
          </select>
        </div>
        <div id="mvp-suggestion" class="award-hint"></div>

        <!-- Meilleur¬∑e bloqueur¬∑euse -->
        <div class="award-row">
          <label for="select-best-block">Meilleur¬∑e bloqueur¬∑euse</label>
          <select id="select-best-block">
            <option value="">‚Äî Aucune ‚Äî</option>
          </select>
        </div>
        <div id="best-block-suggestion" class="award-hint"></div>

        <div id="block-suggestion" class="award-hint"></div>

        
        <!-- Meilleur¬∑e attaquant¬∑e -->
        <div class="award-row">
          <label for="select-best-attack">Meilleur¬∑e attaquant¬∑e</label>
          <select id="select-best-attack">
            <option value="">‚Äî Aucune ‚Äî</option>
          </select>
        </div>
        <div id="best-attack-suggestion" class="award-hint"></div>

<!-- Meilleur soutien -->
        <div class="award-row">
          <label for="select-best-support">Meilleur soutien</label>
          <select id="select-best-support">
            <option value="">‚Äî Aucune ‚Äî</option>
          </select>
        </div>
        <div id="best-support-suggestion" class="award-hint"></div>

        <div id="support-suggestion" class="award-hint"></div>
      </div>

      <button id="btn-close-match">Cl√¥turer ce match et l‚Äôarchiver</button>

    </section>
  </div>

  <!-- HISTORIQUE -->
  <div class="container" id="history-container" style="display:none;">
    <section id="history" class="no-select">
<h2>Historique des matchs</h2>

      <div id="history-list"></div>
</section>
  </div>
    <!-- TUTORIEL / AIDE -->
  <div class="container" id="help-container" style="display:none;">
    
<section id="help" class="no-select help-page funky-help">
  <button class="help-back" id="btn-back-from-help">‚Üê Retour au terrain</button>

  <div class="help-hero">
    <div class="help-hero-top">
      <div>
        <h2 style="margin:0 0 4px 0;">Tutoriel ‚Äî Stat2Match 6√ó6 PRO üß†üèê</h2>
        <p style="margin:0;">
          Objectif coach : <b>comprendre pourquoi un set bascule</b> (et quoi bosser au prochain entra√Ænement).
          <br>Tu observes ‚Üí tu cliques <b>une fois</b> sur la bonne tuile ‚Üí l‚Äôapp te sort une <b>lecture PRO</b>.
        </p>
      </div>

      <div class="help-badges" aria-label="Badges">
        <span class="help-badge badge-blue">6√ó6</span>
        <span class="help-badge badge-pink">PRO</span>
        <span class="help-badge badge-amber">Rallye</span>
        <span class="help-badge badge-green">Diagnostics</span>
      </div>
    </div>

    <div class="help-callout" style="margin-top:10px;">
      <b>R√®gle d‚Äôor :</b> tu ne ‚Äúnotes pas tout‚Äù. Tu notes <b>ce qui d√©cide le point</b> (P/F) + la <b>qualit√©</b> (+/‚àí).
      <br><b>Et tu restes bienveillant :</b> l‚Äôobjectif, c‚Äôest le progr√®s, pas le jugement.
    </div>
  </div>

  <div class="help-grid" style="margin-top:12px;">
    <div class="help-card">
      <h3 style="margin:0 0 8px;">üöÄ D√©marrage express (1 minute)</h3>
      <ol style="margin:0;padding-left:18px;color:rgba(255,255,255,0.90);font-size:13px;line-height:1.55;">
        <li><b>Effectif</b> ‚Üí ajoute les joueur¬∑euses ‚Üí <b>Valider le match</b>.</li>
        <li><b>Terrain</b> ‚Üí place les 6 postes : <b>AG / AC / AD / ARG / ARC / ARD</b>.</li>
        <li><b>Service</b> ‚Üí choisis qui sert : <b>Nous</b> ou <b>Eux</b>.</li>
        <li><b>Rotation auto</b> : ON si tu veux la rotation ‚Äúside-out‚Äù automatique.</li>
        <li><b>Lib√©ro auto</b> : ON si tu veux la question ‚Äúlib√©raut√© ?‚Äù quand un attaquant passe derri√®re.</li>
      </ol>
      <p class="help-tip" style="margin:10px 0 0;">
        Astuce : o√π que tu sois (Stats / Dashboard / Historique / Tutoriel), les boutons flottants <b>‚Ü© Terrain</b> sont l√†.
      </p>
    </div>

    <div class="help-card">
      <h3 style="margin:0 0 8px;">üéÆ La r√®gle ‚Äúclic unique‚Äù (anti-panique)</h3>
      <p style="margin:0;">
        Tu regardes l‚Äô√©change ‚Üí tu cliques <b>UNE</b> tuile ‚Üí c‚Äôest not√©.
        <br>Si tu h√©sites : choisis le geste <b>le plus d√©cisif</b> (celui qui explique le point).
      </p>
      <div class="help-rule" style="margin-top:10px;">
        <b>+ / ‚àí</b> = qualit√© (ne change pas le score) ¬∑ <b>P / F</b> = point / faute (change le score)
      </div>
    </div>
  </div>

  <div class="help-rule" style="margin-top:12px;">
    <h3 style="margin:0 0 6px;">üß© Les 4 boutons (√† conna√Ætre par c≈ìur)</h3>
    <p style="margin:6px 0 0;color:rgba(255,255,255,0.90);font-size:13px;line-height:1.55;">
      <span class="kbd">+</span> action propre / utile ¬∑
      <span class="kbd">‚àí</span> action subie / moyenne ¬∑
      <span class="kbd">P</span> <b>point pour nous</b> ¬∑
      <span class="kbd">F</span> <b>faute de nous</b> (point pour eux)
    </p>
    <p class="help-tip" style="margin:8px 0 0;">
      Exemple : <b>Attaque P</b> = point marqu√© par l‚Äôattaque. <b>R√©ception ‚àí</b> = r√©ception difficile mais rallye continue.
    </p>
  </div>

  <div class="help-grid" style="margin-top:12px;">
    <div class="help-card">
      <h3 style="margin:0 0 8px;">üî• Rallye : comment √ßa marche</h3>
      <p style="margin:0;">
        Le mode Rallye t‚Äôaide √† noter l‚Äôaction d√©cisive <b>pendant</b> l‚Äô√©change.
        <br>Tu peux finir un rallye par :
        <b>P</b> (on marque), <b>F</b> (on donne), ou une action PRO (attaque/bloc/d√©fense).
      </p>
      <p class="help-tip" style="margin:10px 0 0;">
        <b>R√®gle PRO :</b> un rallye ne se termine jamais par <b>service</b> ou <b>r√©ception</b>.
        Il se termine par <b>attaque</b>, <b>bloc</b>, <b>d√©fense</b>‚Ä¶ ou <b>faute</b>.
      </p>
    </div>

    <div class="help-card">
      <h3 style="margin:0 0 8px;">üßë‚Äçüöí ‚ÄúScore adverse‚Äù : toujours cliquable</h3>
      <p style="margin:0;">
        M√™me pendant Rallye, tu peux cliquer c√¥t√© adversaire :
        <br>‚Ä¢ <b>ils marquent</b> (attaque/service/bloc/‚Ä¶)
        <br>‚Ä¢ ou <b>ils donnent</b> un point (faute directe)
      </p>
      <p class="help-tip" style="margin:10px 0 0;">
        But : fermer le rallye correctement quand le point vient <b>d‚Äôeux</b> (bon jeu) ou <b>d‚Äôune faute adverse</b>.
      </p>
    </div>
  </div>

  <div class="help-rule" style="margin-top:12px;">
    <h3 style="margin:0 0 6px;">üß§ Lib√©ro auto (la r√®gle simple)</h3>
    <p style="margin:6px 0 0;color:rgba(255,255,255,0.90);font-size:13px;line-height:1.55;">
      Quand un attaquant ‚Äú√† lib√©rer‚Äù passe derri√®re, l‚Äôapp demande <b>une seule fois</b> :
      <b>‚ÄúLib√©ro √† la place de X ?‚Äù</b>
      <br>Si tu r√©ponds <b>Non</b>, c‚Äôest valable <b>tant que ce joueur reste derri√®re</b>.
      Si tu veux changer ensuite, tu le fais <b>manuellement</b>.
    </p>
  </div>

  <div class="help-grid" style="margin-top:12px;">
    <div class="help-card">
      <h3 style="margin:0 0 8px;">üìä Dashboard (lecture coach)</h3>
      <ul style="margin:0;padding-left:18px;color:rgba(255,255,255,0.90);font-size:13px;line-height:1.55;">
        <li><b>Ce qui marche</b> : tes leviers de points.</li>
        <li><b>Ce qui co√ªte</b> : les ‚Äúrobinets‚Äù (fautes directes).</li>
        <li><b>Priorit√©</b> : 1 action simple √† corriger tout de suite.</li>
      </ul>
      <p class="help-tip" style="margin:10px 0 0;">
        Lecture PRO = moins de blabla, plus de d√©cisions : <b>o√π gagner 3 points d√®s le prochain set</b>.
      </p>
    </div>

    <div class="help-card">
      <h3 style="margin:0 0 8px;">üìà Diagnostics (PRO)</h3>
      <p style="margin:0;">
        Le diagnostic te donne :
        <br>‚Ä¢ <b>Efficacit√©</b> (qualit√©) ¬∑ <b>Transformation</b> (capacit√© √† finir) ¬∑ <b>Fautes/Tentatives</b> (risque)
      </p>
      <p class="help-tip" style="margin:10px 0 0;">
        Tu peux naviguer joueur ‚Üí joueur directement depuis la fen√™tre Diagnostics (boutons <b>‚Äπ / ‚Ä∫</b>).
      </p>
    </div>
  </div>

  <div class="help-rule" style="margin-top:12px;">
    <h3 style="margin:0 0 6px;">üßæ Rapport (WhatsApp / PDF)</h3>
    <p style="margin:6px 0 0;color:rgba(255,255,255,0.90);font-size:13px;line-height:1.55;">
      Le rapport est fait pour √™tre <b>lu</b> (pas seulement stock√©) :
      r√©sum√©, chiffres cl√©s, points forts, axe de progr√®s.
      <br>En PDF : l‚Äôimpression doit √™tre propre, sans boutons parasites (c‚Äôest pr√©vu).
    </p>
  </div>

  <div class="help-grid" style="margin-top:12px;">
    <div class="help-card">
      <h3 style="margin:0 0 8px;">‚úÖ Routine coach (propre & efficace)</h3>
      <ol style="margin:0;padding-left:18px;color:rgba(255,255,255,0.90);font-size:13px;line-height:1.55;">
        <li>Set 1 : tu notes simple (P/F) + 1‚Äì2 secteurs cl√©s.</li>
        <li>Temps-mort : tu regardes <b>Ce qui co√ªte</b> ‚Üí tu choisis <b>1 consigne</b>.</li>
        <li>Fin de set : <b>Dashboard</b> ‚Üí 1 axe √©quipe + 1 axe service/attaque.</li>
        <li>Fin de match : <b>cl√¥ture</b> + 2 rapports individuels (leaders / fuites).</li>
      </ol>
    </div>

    <div class="help-card">
      <h3 style="margin:0 0 8px;">üö´ Erreurs classiques (√† √©viter)</h3>
      <ul style="margin:0;padding-left:18px;color:rgba(255,255,255,0.90);font-size:13px;line-height:1.55;">
        <li>Noter 10 trucs par point ‚Üí tu te perds.</li>
        <li>Mettre des <b>P</b> partout ‚Üí le score devient incoh√©rent.</li>
        <li>Oublier que <b>+ / ‚àí</b> ne changent pas le score.</li>
        <li>Comparer un joueur avec 1 action seulement ‚Üí pas fiable (volume requis).</li>
      </ul>
    </div>
  </div>

  <div class="help-rule" style="margin-top:14px;">
    <h3 style="margin:0 0 6px;">üèÅ Cl√¥turer & archiver</h3>
    <p style="margin:6px 0 0;color:rgba(255,255,255,0.90);font-size:13px;line-height:1.55;">
      Quand le match est fini : <b>Cl√¥turer</b> ‚Üí l‚Äôhistorique garde le match.
      <br><b>Pro tip :</b> note 1 phrase de contexte (blessure, fatigue, adversaire tr√®s fort‚Ä¶) pour relire intelligemment plus tard.
    </p>
  </div>

  <div class="help-rule" style="margin-top:14px; opacity:.92;">
    <p style="margin:0;">
      <b>Mantra PRO :</b> ‚Äú<b>moins</b> de clics, <b>meilleure</b> lecture, <b>meilleures</b> d√©cisions.‚Äù üß†üèê
    </p>
  </div>
</section>

  </div>

 </div>
    </section>
  </div>
<script>
/* === BOOT DIAG (visible) === */
(function(){
  function badge(txt, ok){
    try{
      const d=document.createElement('div');
      d.id="__s2m_boot_badge";
      d.textContent=txt;
      d.style.cssText="position:fixed;left:10px;bottom:10px;z-index:2147483647;padding:8px 10px;border-radius:10px;font:700 12px system-ui;background:"+(ok?"rgba(0,180,90,.95)":"rgba(220,60,60,.95)")+";color:#fff;box-shadow:0 10px 30px rgba(0,0,0,.35);";
      document.documentElement.appendChild(d);
      setTimeout(()=>{ try{d.remove();}catch(e){} }, ok?1200:8000);
    }catch(e){}
  }
  window.__S2M_BOOT_BADGE = badge;
  window.addEventListener("error", (e)=>badge("JS ERREUR: "+(e.message||"inconnue"), false));
  window.addEventListener("unhandledrejection", (e)=>badge("PROMISE ERREUR: "+(e.reason?.message||e.reason||"inconnue"), false));
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", ()=>badge("JS charg√© ‚úÖ", true));
  } else {
    badge("JS charg√© ‚úÖ", true);
  }
})();


       const STORAGE_KEY  = "stat2matchpro-6x6-players";
const STATS_KEY    = "stat2matchpro-6x6-stats";
const SETS_KEY     = "stat2matchpro-6x6-sets";
const OPP_KEY      = "stat2matchpro-6x6-opponent";
const HISTORY_KEY  = "stat2matchpro-6x6-history";
const TEAM_KEY     = "stat2matchpro-6x6-teamnames";
const COURT_KEY    = "stat2matchpro-6x6-court";
const PRO_KEY      = "stat2matchpro-6x6-prostate";
    

const POINTUNDO_KEY = "stat2matchpro-6x6-pointundo";
    const DEFAULT_OUR_TEAM_NAME = "Stats de match pro ‚Äì 6x6";
    const DEFAULT_US_LABEL      = "Nous";
    const DEFAULT_OPP_LABEL     = "Adversaire";

    const STAT_CATEGORIES   = ["service","reception","passe","attaque","bloc","defense","relance"];

/* ===== Dashboard Highlights ===== */
function computeSetPlayerTotals(setNumber) {
  const out = [];
  const inMatchPlayers = (players || []).filter(p => p.inMatch !== false);

  inMatchPlayers.forEach(p => {
    const s = (stats[p.id] && stats[p.id][setNumber]) ? stats[p.id][setNumber] : createEmptyStats();

    let points = 0;
    let faults = 0;
    STAT_CATEGORIES.forEach(cat => {
      points += (s[cat + "Point"] || 0);
      faults += (s[cat + "Fault"] || 0);
    });

    const delta = points - faults;

    const support =
      (s["defensePlus"] || 0) +
      (s["receptionPlus"] || 0) +
      (s["relancePlus"] || 0);

    const attack = (s["attaquePoint"] || 0);

    out.push({
      id: p.id,
      name: p.name || "",
      number: p.number || "",
      points,
      faults,
      plus: points,   // compat (ancien tableau)
      minus: faults,  // compat (ancien tableau)
      delta,
      support,
      attack
    });
  });

  return out;
}

function getSetHighlights(setNumber) {
  const totals = computeSetPlayerTotals(setNumber);

  const topDelta   = totals.slice().sort((a,b)=> (b.delta - a.delta) || (b.plus - a.plus)).slice(0,3);
  const topSupport = totals.slice().sort((a,b)=> (b.support - a.support) || (b.delta - a.delta)).slice(0,3);
  const topAttack  = totals.slice().sort((a,b)=> (b.attack - a.attack) || (b.delta - a.delta)).slice(0,3);
  const topFaults  = totals.slice().sort((a,b)=> (b.minus - a.minus) || (a.delta - b.delta)).slice(0,3);

  return { topDelta, topSupport, topAttack, topFaults };
}

function formatTopList(list, key, prefixSign=false) {
  const getName = (id) => (players||[]).find(x => x.id === id)?.name || id || "‚Äî";
  return (list||[]).filter(x => (x[key]||0) > 0 || (key==="delta"))
    .map(x => {
      const v = Number(x[key]||0);
      const sv = prefixSign && v>=0 ? ("+"+v) : String(v);
      return `${getName(x.id)} ${sv}`;
    }).join(" ‚Ä¢ ");
}


    const POINT_CATEGORIES  = STAT_CATEGORIES.slice();
    const FAULT_CATEGORIES  = STAT_CATEGORIES.slice();
    const OPP_CATEGORIES    = ["service","bloc","cadeaux","points"];

    const NEG_DELTA_THRESHOLD = -3; // delta <= -3 -> halo rouge

    let players = [];
    let stats = {};          // { playerId: { setNumber: {attaquePlus, attaqueMinus,...} } }
    let setScores = {};      // { setNumber: { nous, eux } }
    let opponentStats = {};  // { setNumber: { servicePlus, serviceMinus, blocPlus, ... } }
    let historyMatches = []; // matches archiv√©s

    let currentStatsPlayerId = null;
    let currentSet = 1;

    let mainSetButtons = [];
    let statsSetButtons = [];
    let dashboardSetButtons = [];
        let teamNames = {
      our: DEFAULT_OUR_TEAM_NAME,
      opp: DEFAULT_OPP_LABEL
    };


    /* ===== Match I/O (export / import JSON) ===== */
function buildMatchSnapshot() {
  const snap = {
    app: "Stats de match pro ‚Äì 6x6",
    version: "pro-6x6-v1",
    exportedAt: new Date().toISOString(),

    players,
    stats,
    setScores,
    opponentStats,
    history,

    teamNames,

    courtAssignments: getCourtAssignments(),

    proState: proState
  };
  return snap;
}

function safeJSONStringify(obj) {
  try { return JSON.stringify(obj, null, 2); } catch(e) { return ""; }
}

function openMatchIOModal(prefillText) {
  const overlay = document.getElementById("matchio-overlay");
  const ta = document.getElementById("matchio-text");
  if (!overlay || !ta) return;
  overlay.style.display = "flex";
  ta.value = prefillText || "";
  ta.focus();
  makeMatchIOPanelDraggable();
}

function closeMatchIOModal() {
  const overlay = document.getElementById("matchio-overlay");
  if (overlay) overlay.style.display = "none";
}

function copyTextToClipboard(txt) {
  if (!txt) return;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(txt).catch(() => {});
    return;
  }
  // fallback
  const ta = document.createElement("textarea");
  ta.value = txt;
  ta.style.position = "fixed";
  ta.style.left = "-9999px";
  document.body.appendChild(ta);
  ta.select();
  try { document.execCommand("copy"); } catch(e) {}
  document.body.removeChild(ta);
}

function downloadTextFile(filename, txt, mime="application/json") {
  try {
    const blob = new Blob([txt], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 800);
  } catch(e) {}
}

function setLocalStorageJSON(key, value){
  try { localStorage.setItem(key, JSON.stringify(value)); } catch(e) {}
}

function applyMatchSnapshot(snap) {
  if (!snap || typeof snap !== "object") throw new Error("Snapshot invalide.");

  // Donn√©es
  players = Array.isArray(snap.players) ? snap.players : [];
  stats = snap.stats && typeof snap.stats === "object" ? snap.stats : {};
  setScores = snap.setScores && typeof snap.setScores === "object" ? snap.setScores : createEmptySetScores();
  opponentStats = snap.opponentStats && typeof snap.opponentStats === "object" ? snap.opponentStats : createEmptyOpponentStats();
  history = Array.isArray(snap.history) ? snap.history : [];

  teamNames = snap.teamNames && typeof snap.teamNames === "object" ? snap.teamNames : { our: DEFAULT_OUR_TEAM_NAME, opp: DEFAULT_OPP_TEAM_NAME };

  // Pro state
  const ps = snap.proState && typeof snap.proState === "object" ? snap.proState : null;
  if (ps) {
    proState.serveTeam = (ps.serveTeam === "eux") ? "eux" : "nous";
    proState.autoRotate = (ps.autoRotate !== false);
    proState.autoLibero = (ps.autoLibero !== false);
    proState.showRallyBar = !!ps.showRallyBar;

    proState.liberoId = ps.liberoId || "";
    proState.liberoActive = !!ps.liberoActive;

    if (Array.isArray(ps.liberoTargetIds)) {
      proState.liberoTargetIds = [ (ps.liberoTargetIds[0] || ""), (ps.liberoTargetIds[1] || "") ];
    }

    proState.liberoReplacedId = ps.liberoReplacedId || "";
    proState.liberoReplacedPos = ps.liberoReplacedPos || "";



    // M√©moire de d√©cision lib√©ro (pour ne pas redemander)
    proState.liberoBackDecision = (ps.liberoBackDecision && typeof ps.liberoBackDecision === "object") ? ps.liberoBackDecision : {};
    // Migration ancienne version (liberoCentralId)
    if (!proState.liberoReplacedId && ps.liberoCentralId) {
      proState.liberoReplacedId = String(ps.liberoCentralId || "");
    }
  }

  // Persist
  setLocalStorageJSON(STORAGE_KEY, players);
  setLocalStorageJSON(STATS_KEY, stats);
  setLocalStorageJSON(SETS_KEY, setScores);
  setLocalStorageJSON(OPP_KEY, opponentStats);
  setLocalStorageJSON(HISTORY_KEY, history);
  setLocalStorageJSON(TEAM_KEY, teamNames);
  setLocalStorageJSON(PRO_KEY, proState);

  // Court
  if (snap.courtAssignments && typeof snap.courtAssignments === "object") {
    setLocalStorageJSON(COURT_KEY, snap.courtAssignments);
  }

  // Refresh UI
  window.location.reload();
  return;
}

function importMatchSnapshotFromText(txt){
  if (!txt || !txt.trim()) throw new Error("Colle un JSON de match dans le champ.");
  let snap;
  try { snap = JSON.parse(txt); } catch(e) { throw new Error("JSON invalide (copie incompl√®te ?)."); }
  applyMatchSnapshot(snap);
}

/* Drag pour Match I/O */
function makeMatchIOPanelDraggable() {
  const overlay = document.getElementById("matchio-overlay");
  const panel = document.getElementById("matchio-panel");
  const handle = document.getElementById("matchio-drag-handle");
  if (!overlay || !panel || !handle) return;

  let dragging = false;
  let startX = 0, startY = 0;
  let startLeft = 0, startTop = 0;

  // position initiale
  if (!panel.dataset.floatInit) {
    panel.style.position = "relative";
    panel.style.left = "0px";
    panel.style.top = "0px";
    panel.dataset.floatInit = "1";
  }

  const clamp = (v,min,max)=>Math.min(Math.max(v,min),max);

  function getXY(ev){
    if (ev.touches && ev.touches[0]) return {x: ev.touches[0].clientX, y: ev.touches[0].clientY};
    return {x: ev.clientX, y: ev.clientY};
  }

  function onDown(ev){
    ev.preventDefault();
    dragging = true;
    const xy=getXY(ev);
    startX = xy.x; startY = xy.y;
    const rect=panel.getBoundingClientRect();
    const orect=overlay.getBoundingClientRect();
    startLeft = rect.left - orect.left;
    startTop  = rect.top - orect.top;

    document.addEventListener("mousemove", onMove);
    document.addEventListener("mouseup", onUp);
    document.addEventListener("touchmove", onMove, {passive:false});
    document.addEventListener("touchend", onUp);
  }

  function onMove(ev){
    if (!dragging) return;
    ev.preventDefault();
    const xy=getXY(ev);
    const dx = xy.x - startX;
    const dy = xy.y - startY;

    const orect=overlay.getBoundingClientRect();
    const prect=panel.getBoundingClientRect();

    const maxLeft = orect.width - prect.width;
    const maxTop  = orect.height - prect.height;

    const left = clamp(startLeft + dx, 0, Math.max(0,maxLeft));
    const top  = clamp(startTop  + dy, 0, Math.max(0,maxTop));

    panel.style.position = "absolute";
    panel.style.left = left + "px";
    panel.style.top  = top  + "px";
  }

  function onUp(){
    dragging = false;
    document.removeEventListener("mousemove", onMove);
    document.removeEventListener("mouseup", onUp);
    document.removeEventListener("touchmove", onMove);
    document.removeEventListener("touchend", onUp);
  }

  handle.addEventListener("mousedown", onDown);
  handle.addEventListener("touchstart", onDown, {passive:false});
}

// ferme modal si clic sur fond sombre
document.addEventListener("click", (e) => {
  const overlay = document.getElementById("matchio-overlay");
  if (!overlay || overlay.style.display === "none") return;
  if (e.target === overlay) closeMatchIOModal();
});

/* --------- stockage joueurs ---------- */
    function loadPlayers() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try { players = JSON.parse(raw) || []; }
      catch(e){ players = []; }
    }
    function savePlayers() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
    }

    /* --------- stockage stats joueurs ---------- */
    function loadStats() {
      const raw = localStorage.getItem(STATS_KEY);
      if (!raw) return;
      try { stats = JSON.parse(raw) || {}; }
      catch(e){ stats = {}; }
    }
    function saveStats() {
      localStorage.setItem(STATS_KEY, JSON.stringify(stats));
    }
    function createEmptyStats() {
  const o = {};
  STAT_CATEGORIES.forEach(cat => {
    // Qualit√© (ne change pas le score)
    o[cat + "Plus"]  = 0;
    o[cat + "Minus"] = 0;
    // Issue (change le score)
    o[cat + "Point"] = 0;
    o[cat + "Fault"] = 0;
  });
  return o;
}
    function getPlayerSetStats(playerId, setNumber) {
      if (!stats[playerId]) stats[playerId] = {};
      if (!stats[playerId][setNumber]) stats[playerId][setNumber] = createEmptyStats();
      return stats[playerId][setNumber];
    }
    // --------- MODE RALLYE : logique centrale ----------
    let rallyCurrentCat = null;
    let rallyCurrentOutcome = null;

    function getOnCourtPlayers() {
      const ids = getSelectedIds();
      const idSet = new Set(ids.filter(Boolean));
      return players.filter(p => idSet.has(p.id));
    }

    /* ===== PRO MODE STATE (service / rotation / lib√©ro) ===== */
let proState = {
  serveTeam: "nous",     // "nous" | "eux"
  autoRotate: true,
  autoLibero: true,
  showRallyBar: false,   // bandeau rallye (facultatif)

  liberoId: "",          // playerId
  liberoActive: false,

  // Qui le lib√©ro remplace (1 ou 2 joueur¬∑euses au choix).
  // Si vide : fallback = tous les "centraux" d√©tect√©s par le r√¥le.
  liberoTargetIds: ["", ""],

  // M√©moire : qui le lib√©ro remplace actuellement (pour ressortir au bon moment)
  liberoReplacedId: "",
  liberoReplacedPos: "",

  // D√©cision "lib√©ro ou pas" pour une cible quand elle est en ligne arri√®re (m√©moire jusqu'√† ce qu'elle repasse devant)
  liberoBackDecision: {}
};

function loadProState() {
  try {
    const raw = localStorage.getItem(PRO_KEY);
    if (!raw) return;
    const s = JSON.parse(raw) || {};

    proState.serveTeam = (s.serveTeam === "eux") ? "eux" : "nous";
    proState.autoRotate = (s.autoRotate !== false);
    proState.autoLibero = (s.autoLibero !== false);
    proState.showRallyBar = !!s.showRallyBar;

    proState.liberoId = s.liberoId || "";
    proState.liberoActive = !!s.liberoActive;

    // Nouveaux champs (v17+)
    if (Array.isArray(s.liberoTargetIds)) {
      proState.liberoTargetIds = [
        (s.liberoTargetIds[0] || ""),
        (s.liberoTargetIds[1] || "")
      ];
    }

    proState.liberoReplacedId = s.liberoReplacedId || "";
    proState.liberoReplacedPos = s.liberoReplacedPos || "";


    // M√©moire de d√©cision lib√©ro (pour ne pas redemander)
    proState.liberoBackDecision = (s.liberoBackDecision && typeof s.liberoBackDecision === "object") ? s.liberoBackDecision : {};
    // Migration ancienne version (liberoCentralId)
    if (!proState.liberoReplacedId && s.liberoCentralId) {
      proState.liberoReplacedId = String(s.liberoCentralId || "");
    }
  } catch (e) {}
}

function saveProState() {
  try { localStorage.setItem(PRO_KEY, JSON.stringify(proState)); } catch (e) {}
}


/* ===== Annulation (appui long) + feedback visuel/sonore ===== */
let pointUndoStack = {}; // { setNumber: [ {team, meta, score, proState, court} ] }

function loadPointUndoStack(){
  try{
    const raw = localStorage.getItem(POINTUNDO_KEY);
    if(!raw) return;
    pointUndoStack = JSON.parse(raw) || {};
  }catch(e){}
}
function savePointUndoStack(){
  try{ localStorage.setItem(POINTUNDO_KEY, JSON.stringify(pointUndoStack || {})); }catch(e){}
}

function ensureTinyToast(){
  let el = document.getElementById("tiny-toast");
  if(el) return el;
  el = document.createElement("div");
  el.id = "tiny-toast";
  document.body.appendChild(el);
  return el;
}
let __toastTimer = null;
function showTinyToast(msg, ms){
  const el = ensureTinyToast();
  el.textContent = msg || "";
  el.classList.add("show");
  clearTimeout(__toastTimer);
  __toastTimer = setTimeout(()=>{ el.classList.remove("show"); }, ms || 900);
}

let __audioCtx = null;
function beep(freq, ms){
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if(!AudioCtx) return;
    if(!__audioCtx) __audioCtx = new AudioCtx();
    const ctx = __audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = freq || 660;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.18, ctx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + (ms||120)/1000);
    o.connect(g); g.connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + (ms||120)/1000 + 0.02);
  }catch(e){}
}
function vib(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms||30); }catch(e){} }

function flashBtn(btn, kind){
  if(!btn) return;
  const cls = (kind === "undo") ? "undone" : "tapped";
  btn.classList.add(cls);
  setTimeout(()=>btn.classList.remove(cls), 180);
}

function restoreCourtAssignments(map){
  if(!map) return;
  document.querySelectorAll(".court-pos").forEach(posDiv=>{
    const key = posDiv.dataset.pos || "";
    const select = posDiv.querySelector(".pos-select");
    if(!select) return;
    if(Object.prototype.hasOwnProperty.call(map, key)){
      select.value = map[key] || "";
      updatePositionJersey(select);
    }
  });
  saveCourtToStorage();
  renderBench();
  updateCourtWarningsForSet();
}

function pushPointSnapshot(team, meta){
  try{
    const s = getSetScore(currentSet);
    const snap = {
      set: currentSet,
      team: team,
      meta: meta || {},
      score: JSON.parse(JSON.stringify(s)),
      proState: JSON.parse(JSON.stringify(proState)),
      court: getCourtAssignments()
    };
    if(!pointUndoStack[currentSet]) pointUndoStack[currentSet] = [];
    pointUndoStack[currentSet].push(snap);
    // garde-fou
    if(pointUndoStack[currentSet].length > 80) pointUndoStack[currentSet].shift();
    savePointUndoStack();
  }catch(e){}
}

function undoLastPoint(expected){
  const stack = pointUndoStack[currentSet] || [];
  if(!stack.length) return false;
  const snap = stack[stack.length - 1];

  if(expected){
    if(expected.team && snap.team !== expected.team) return false;
    if(expected.playerId && (snap.meta && snap.meta.playerId) !== expected.playerId) return false;
    if(expected.cat && (snap.meta && snap.meta.cat) !== expected.cat) return false;
  }

  stack.pop();
  savePointUndoStack();

  // restore score
  setScores[currentSet] = JSON.parse(JSON.stringify(snap.score || createEmptySetScore()));
  // restore pro state (sans casser la r√©f√©rence)
  Object.assign(proState, snap.proState || {});
  saveProState();
  saveSetScores();

  // restore terrain
  restoreCourtAssignments(snap.court || {});

  renderProControlsUI();
  renderSetScore();
  renderDashboard();

  beep(520, 120);
  vib(40);
  showTinyToast("Annul√© ‚úÖ", 700);
  return true;
}

function decrementRallyStat(playerId, cat, outcome, btn){
  const s = getPlayerSetStats(playerId, currentSet);
  const o = normalizeOutcome(outcome);

  let keySuffix = "Plus";
  if(o === "minus") keySuffix = "Minus";
  if(o === "point") keySuffix = "Point";
  if(o === "fault") keySuffix = "Fault";
  const key = cat + keySuffix;

  if((s[key] || 0) <= 0){
    beep(300, 90);
    vib(20);
    showTinyToast("Rien √† annuler", 650);
    flashBtn(btn, "undo");
    return;
  }

  // si c'est un point/faute, on tente d'annuler proprement le dernier point (rotation + lib√©ro inclus)
  if(o === "point" || o === "fault"){
    const team = (o === "point") ? "nous" : "eux";
    const ok = undoLastPoint({ team });
    if(!ok){
      // fallback : on d√©cr√©mente le score sans rotation (mieux que rien)
      const sc = getSetScore(currentSet);
      if((sc[team] || 0) > 0) sc[team] -= 1;
      saveSetScores();
      renderSetScore();
      showTinyToast("Score -1 (sans rotation)", 900);
      beep(440, 110);
      vib(40);
    }
  }

  s[key] = Math.max(0, (s[key] || 0) - 1);

  saveStats();
  updateCourtWarningsForSet();
  renderDashboard();

  flashBtn(btn, "undo");
  beep(660, 110);
  vib(30);
}
/* ===== fin annulation + feedback ===== */


function setCourtPosition(posKey, playerId) {
  const posDiv = document.querySelector('.court-pos[data-pos="' + posKey + '"]');
  const select = posDiv ? posDiv.querySelector(".pos-select") : null;
  if (!select) return;
  select.value = playerId || "";
  updatePositionJersey(select);
}

function getPositionOfPlayer(playerId) {
  const map = getCourtAssignments();
  for (const k in map) {
    if (map[k] === playerId) return k;
  }
  return null;
}

function renderProControlsUI() {
  // Service buttons
  const bNous = document.getElementById("btn-serve-nous");
  const bEux  = document.getElementById("btn-serve-eux");
  if (bNous) bNous.classList.toggle("active", proState.serveTeam === "nous");
  if (bEux)  bEux.classList.toggle("active", proState.serveTeam === "eux");

  // Toggles
  const chkRot = document.getElementById("chk-auto-rotate");
  if (chkRot) chkRot.checked = !!proState.autoRotate;

  const chkLib = document.getElementById("chk-auto-libero");
  if (chkLib) chkLib.checked = !!proState.autoLibero;

  // Select lib√©ro
  const selLib = document.getElementById("select-libero-pro");
  if (selLib && selLib.value !== (proState.liberoId || "")) {
    selLib.value = proState.liberoId || "";
  }

  
// Rally bar toggle
const chkRally = document.getElementById("chk-rally-bar");
if (chkRally) chkRally.checked = !!proState.showRallyBar;
applyRallyBarVisibility();


  // Lib√©ro remplace (cibles)
  const t1 = document.getElementById("select-libero-target-1");
  const t2 = document.getElementById("select-libero-target-2");
  if (t1 || t2) {
    // Remplit/rafra√Æchit les options (si effectif change)
    fillLiberoTargetSelects();
    if (t1) t1.value = (proState.liberoTargetIds && proState.liberoTargetIds[0]) ? proState.liberoTargetIds[0] : "";
    if (t2) t2.value = (proState.liberoTargetIds && proState.liberoTargetIds[1]) ? proState.liberoTargetIds[1] : "";
  }

  // Badge lib√©ro actif
  const badge = document.getElementById("libero-active-badge");
  if (badge) {
    const on = !!proState.liberoActive;
    badge.style.display = on ? "inline-flex" : "none";
    if (on) {
      const repId = proState.liberoReplacedId || "";
      const rep = (players || []).find(p => p.id === repId);
      const repLabel = rep ? ((rep.number ? "#" + rep.number + " " : "") + (rep.name || "")) : "";
      badge.textContent = repLabel ? ("Lib√©ro sur le terrain ‚Ä¢ remplace " + repLabel) : "Lib√©ro sur le terrain";
    } else {
      badge.textContent = "Lib√©ro sur le terrain";
    }
  }
}

function applyRallyBarVisibility() {
  const bar = document.getElementById("rally-bar");
  const on = !!proState.showRallyBar;

  if (bar) bar.style.display = on ? "flex" : "none";

  // Indicateur visuel (non bloquant)
  const ind = document.getElementById("rally-indicator-fixed");
  if (ind) {
    ind.classList.toggle("on", on);
    ind.setAttribute("aria-hidden", on ? "false" : "true");
  }
}


function fillLiberoSelect() {
  const sel = document.getElementById("select-libero-pro");
  if (!sel) return;

  const current = proState.liberoId || "";
  sel.innerHTML = "";

  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "Lib√©ro : ‚Äî (d√©sactiv√©)";
  sel.appendChild(opt0);

  const liberos = (players || [])
    .filter(p => (p.inMatch !== false) && (String(p.role || "").toLowerCase().includes("lib")))
    .slice()
    .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

  liberos.forEach(p => {
    const o = document.createElement("option");
    o.value = p.id;
    o.textContent = (p.number ? "#" + p.number + " " : "") + (p.name || "");
    if (p.id === current) o.selected = true;
    sel.appendChild(o);
  });
}

function fillLiberoTargetSelects() {
  const sel1 = document.getElementById("select-libero-target-1");
  const sel2 = document.getElementById("select-libero-target-2");
  if (!sel1 && !sel2) return;

  const ids = (proState.liberoTargetIds && Array.isArray(proState.liberoTargetIds))
    ? proState.liberoTargetIds
    : ["", ""];

  const list = (players || [])
    .filter(p => (p.inMatch !== false))
    .slice()
    .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

  function fillOne(sel, currentVal, otherVal) {
    if (!sel) return;
    sel.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "‚Äî Aucun remplacement";
    sel.appendChild(opt0);

    list.forEach(p => {
      const o = document.createElement("option");
      o.value = p.id;
      o.textContent = (p.number ? "#" + p.number + " " : "") + (p.name || "") + (p.role ? " ‚Ä¢ " + p.role : "");
      // On √©vite juste la confusion : le lib√©ro ne remplace pas‚Ä¶ lui-m√™me
      if (p.id === (proState.liberoId || "")) o.disabled = true;
      // √âvite les doublons (#1 et #2)
      if (otherVal && p.id === otherVal) o.disabled = true;

      if (p.id === currentVal) o.selected = true;
      sel.appendChild(o);
    });
  }

  fillOne(sel1, ids[0] || "", ids[1] || "");
  fillOne(sel2, ids[1] || "", ids[0] || "");
}

function initProControls() {
  fillLiberoSelect();
  fillLiberoTargetSelects();
  renderProControlsUI();

  const bNous = document.getElementById("btn-serve-nous");
  const bEux  = document.getElementById("btn-serve-eux");
  if (bNous) bNous.onclick = () => {
    proState.serveTeam = "nous";
    saveProState();
    autoLiberoTick("serveTeamChange");
    renderProControlsUI();
  };
  if (bEux)  bEux.onclick  = () => {
    proState.serveTeam = "eux";
    saveProState();
    autoLiberoTick("serveTeamChange");
    renderProControlsUI();
  };

  const chkRot = document.getElementById("chk-auto-rotate");
  if (chkRot) chkRot.onchange = () => {
    proState.autoRotate = !!chkRot.checked;
    saveProState();
    renderProControlsUI();
  };

  const chkLib = document.getElementById("chk-auto-libero");
  if (chkLib) chkLib.onchange = () => {
    proState.autoLibero = !!chkLib.checked;
    saveProState();
    autoLiberoTick("toggleAutoLibero");
    renderProControlsUI();
  };

  const selLib = document.getElementById("select-libero-pro");
  if (selLib) selLib.onchange = () => {
    const oldLib = proState.liberoId || "";
    const newLib = selLib.value || "";
    proState.liberoId = newLib;

    // Si un lib√©ro √©tait sur le terrain et qu'on change/d√©sactive : on ressort proprement
    if (proState.liberoActive && oldLib && oldLib !== newLib) {
      const pos = getPositionOfPlayer(oldLib);
      if (pos && proState.liberoReplacedId) {
        setCourtPosition(pos, proState.liberoReplacedId);
      }
      proState.liberoActive = false;
      proState.liberoReplacedId = "";
      proState.liberoReplacedPos = "";
      refreshPositionSelects();
    }

    saveProState();
    fillLiberoTargetSelects();
    autoLiberoTick("liberoChanged");
    renderProControlsUI();
  };

  const t1 = document.getElementById("select-libero-target-1");
  if (t1) t1.onchange = () => {
    proState.liberoTargetIds = proState.liberoTargetIds || ["",""];
    proState.liberoTargetIds[0] = t1.value || "";
    saveProState();
    fillLiberoTargetSelects();
    autoLiberoTick("target1Changed");
    renderProControlsUI();
  };

  const t2 = document.getElementById("select-libero-target-2");
  if (t2) t2.onchange = () => {
    proState.liberoTargetIds = proState.liberoTargetIds || ["",""];
    proState.liberoTargetIds[1] = t2.value || "";
    saveProState();
    fillLiberoTargetSelects();
    autoLiberoTick("target2Changed");
    renderProControlsUI();
  };
}


function getLiberoTargetsResolved() {
  // Cibles explicites
  let targets = (proState.liberoTargetIds && Array.isArray(proState.liberoTargetIds))
    ? proState.liberoTargetIds.filter(Boolean)
    : [];

  // Fallback : tous les "centraux" d√©tect√©s par r√¥le
  if (!targets.length) {
    targets = (players || [])
      .filter(p => (p.inMatch !== false) && String(p.role || "").toLowerCase().includes("central"))
      .map(p => p.id);
  }

  // Unique + pas le lib√©ro
  const libId = proState.liberoId || "";
  const uniq = [];
  targets.forEach(id => {
    if (!id) return;
    if (id === libId) return;
    if (!uniq.includes(id)) uniq.push(id);
  });
  return uniq;
}

function isFrontPos(pos) { return (pos === "AG" || pos === "AC" || pos === "AD"); }
function isBackPos(pos)  { return (pos === "ARG" || pos === "ARC" || pos === "ARD"); }



function cleanupLiberoBackDecisions() {
  // Nettoie la m√©moire : une d√©cision n‚Äôest valable que tant que la cible reste en ligne arri√®re.
  if (!proState.liberoBackDecision || typeof proState.liberoBackDecision !== "object") {
    proState.liberoBackDecision = {};
    return;
  }
  const targets = (typeof getLiberoTargetsResolved === "function") ? getLiberoTargetsResolved() : [];
  const keep = {};
  (targets || []).forEach((id) => {
    if (!id) return;
    const pos = (typeof getPositionOfPlayer === "function") ? getPositionOfPlayer(id) : "";
    if (pos && isBackPos(pos)) keep[id] = proState.liberoBackDecision[id];
  });
  proState.liberoBackDecision = keep;
}

function forceLiberoOut() {
  if (!proState.liberoActive) return;
  const libId = proState.liberoId || "";
  if (!libId) return;

  const pos = getPositionOfPlayer(libId);
  if (!pos) {
    proState.liberoActive = false;
    proState.liberoReplacedId = "";
    proState.liberoReplacedPos = "";
    return;
  }

  if (proState.liberoReplacedId) {
    setCourtPosition(pos, proState.liberoReplacedId);
  }
  proState.liberoActive = false;
  proState.liberoReplacedId = "";
  proState.liberoReplacedPos = "";

  saveProState();
  refreshPositionSelects();
  renderProControlsUI();
}

function findLiberoEntryCandidate() {
  const libId = proState.liberoId || "";
  if (!libId) return null;

  const targets = getLiberoTargetsResolved();
  const backPositions = ["ARG","ARC","ARD"];

  for (const targetId of targets) {
    const pos = getPositionOfPlayer(targetId);
    if (!pos) continue;
    if (!backPositions.includes(pos)) continue;

    // Par d√©faut, on √©vite de mettre le lib√©ro en ARD quand NOUS sommes au service (√ßa ferait servir le lib√©ro)
    if (proState.serveTeam === "nous" && pos === "ARD") continue;

    return { targetId, pos };
  }
  return null;
}

function autoLiberoTick(reason, opts) {
  // S√©curit√© : si l'app n'est pas pr√™te
  if (typeof getPositionOfPlayer !== "function" || typeof setCourtPosition !== "function") return;

  // Si auto-lib√©ro OFF => on sort le lib√©ro s'il est actif
  if (!proState.autoLibero) {
    if (proState.liberoActive) forceLiberoOut();
    return;
  }

  const libId = proState.liberoId || "";
  if (!libId) {
    if (proState.liberoActive) forceLiberoOut();
    return;
  }

  // Si lib√©ro actif : il doit sortir s'il arrive en ligne avant OU s'il se retrouve en ARD au moment o√π NOUS servons.
  if (proState.liberoActive) {
    const pos = getPositionOfPlayer(libId);
    if (!pos) {
      proState.liberoActive = false;
      proState.liberoReplacedId = "";
      proState.liberoReplacedPos = "";
      saveProState();
      renderProControlsUI();
      return;
    }

    const mustExitFront = isFrontPos(pos);
    const mustExitServe = (proState.serveTeam === "nous" && pos === "ARD");

    if (mustExitFront || mustExitServe) {
      forceLiberoOut();
      return;
    }

    // Sinon : OK, il reste
    proState.liberoReplacedPos = pos;
    saveProState();
    renderProControlsUI();
    return;
  }

  // Lib√©ro inactif : on peut le faire entrer si une cible est en ligne arri√®re
  cleanupLiberoBackDecisions();

  const cand = findLiberoEntryCandidate();
  if (!cand) return;

  // M√©moire de d√©cision : on ne redemande PAS tant que cette cible reste derri√®re.
  proState.liberoBackDecision = (proState.liberoBackDecision && typeof proState.liberoBackDecision === "object") ? proState.liberoBackDecision : {};
  const previousDecision = proState.liberoBackDecision[cand.targetId];

  if (previousDecision === false) {
    // Coach a dit "non" -> on respecte, jusqu‚Äô√† ce que le/la joueur¬∑euse repasse devant.
    saveProState();
    renderProControlsUI();
    return;
  }

  if (previousDecision !== true) {
    // Pas encore d√©cid√© : on demande UNE fois (quand la cible est derri√®re).
    let ok = true;
    try{
      const target = (players||[]).find(p => p.id === cand.targetId);
      const tName = target ? (target.number ? (`#${target.number} ${target.name||""}`.trim()) : (target.name||"")) : "le joueur cibl√©";
      const posLabel = (cand.pos||"").toUpperCase();
      const msg = `Lib√©ro : remplacer ${tName} en ${posLabel} ?

` +
                  `Si tu cliques "Annuler" : on ne redemandera plus tant que ${tName} reste derri√®re.`;
      ok = window.confirm(msg);
    }catch(e){
      ok = true; // si confirm indispo => on continue
    }

    proState.liberoBackDecision[cand.targetId] = !!ok;
    saveProState();

    if (!ok) {
      renderProControlsUI();
      return;
    }
  }

  setCourtPosition(cand.pos, libId);
  proState.liberoActive = true;
  proState.liberoReplacedId = cand.targetId;
  proState.liberoReplacedPos = cand.pos;

  saveProState();
  refreshPositionSelects();
  renderProControlsUI();
}


function maybeAutoEnterLiberoOnServeLoss(meta) {
  autoLiberoTick("serveLoss", meta || {});
}

function maybeAutoExitLiberoIfFrontRow(meta) {
  autoLiberoTick("postRotate", meta || {});
}

function addPoint(team, meta) {
  // R√®gle : le score adverse & nos points doivent rester cliquables tout le temps.
  // On autorise donc les corrections m√™me si un set (ou le match) a d√©j√† √©t√© "marqu√© termin√©".
  const tw0 = computeSetsWon();
  const s0 = getSetScore(currentSet);

  // Si on modifie un set d√©j√† fini, on le "r√©-ouvre" et on recalculera la fin de set apr√®s le +1.
  if (s0 && s0.done) {
    s0.done = false;
    s0.winner = null;
    saveSetScores();
  }

  // Si le match √©tait √† 3 sets gagnants, on laisse corriger quand m√™me.
  // (la fin de match sera recalcul√©e via les gagnants de sets)
  pushPointSnapshot(team, meta || {});
  const s = getSetScore(currentSet);
  const prevServe = proState.serveTeam;

  s[team] = (s[team] || 0) + 1;

  // Auto-rotation (side-out)
  if (proState.autoRotate) {
    const sideOut = (team !== prevServe);
    if (sideOut) {
      proState.serveTeam = team;

      if (team === "nous") {
        // Nous gagnons le service => on tourne
        rotateCourtClockwise();
        // Si un lib√©ro arrive en zone avant, il sort
        maybeAutoExitLiberoIfFrontRow(meta || {});
      } else {
        // Eux gagnent le service => eux tournent (hors scope). Notre rotation ne bouge pas.
        // MAIS : si on vient de perdre le service apr√®s un service central, le lib√©ro peut entrer.
        if (prevServe === "nous") {
          maybeAutoEnterLiberoOnServeLoss(meta || {});
        }
      }
    }
  }

  // R√®gle de fin de set (25/15 + 2 pts d'√©cart) + match en 3 sets gagnants
  const winner = finalizeSetIfNeeded(currentSet);
  if (winner){
    const tw = computeSetsWon();
    const target = getSetTargetPoints(currentSet);
    try{
      // Petit feedback discret (sans casser la saisie)
      console.log(`[Set ${currentSet}] termin√©: ${winner} (${target} pts min, +2). Sets: nous ${tw.nous} - eux ${tw.eux}`);
    }catch(e){}

    // Auto passage au set suivant si le match n'est pas termin√©
    const matchDone = (tw.nous >= 3 || tw.eux >= 3);
    if (!matchDone){
      if (currentSet < 5){
        setCurrentSet(currentSet + 1);
      }
    } else {
      // On reste sur le set courant, on laisse le coach d√©cider (et on √©vite un popup agressif)
      // (Si tu veux un popup de fin de match, on pourra l'ajouter en option.)
    }
  }

  saveProState();
  saveSetScores();
  renderSetScore();
  renderDashboard();
}

/* ===== MODE RALLYE : stats 4 √©tats (+ / - / P / F) ===== */
function normalizeOutcome(outcome) {
  if (!outcome) return "plus";
  const o = String(outcome).toLowerCase();
  if (o === "p" || o === "point") return "point";
  if (o === "f" || o === "fault" || o === "faute") return "fault";
  if (o === "-" || o === "minus") return "minus";
  return "plus";
}

function addRallyStat(playerId, cat, outcome) {
  const s = getPlayerSetStats(playerId, currentSet);
  const o = normalizeOutcome(outcome);

  let keySuffix = "Plus";
  if (o === "minus") keySuffix = "Minus";
  if (o === "point") keySuffix = "Point";
  if (o === "fault") keySuffix = "Fault";

  const key = cat + keySuffix;
  s[key] = (s[key] || 0) + 1;

  saveStats();
  updateCourtWarningsForSet();
  renderDashboard();

  // Le score ne bouge QUE sur P/F
  if (o === "point") addPoint("nous", { source: "rally", playerId, cat });
  if (o === "fault") addPoint("eux",  { source: "rally", playerId, cat });
}
/* ===== PRO : ACTIONS DIRECTEMENT SUR LES JOUEUSES (terrain) ===== */
let proActionTarget = null;
let proActionOverlayInitialized = false;

function openProActionOverlay(playerId, cat) {
  const overlay = document.getElementById("pro-action-overlay");
  if (!overlay) return;

  const p = (players || []).find(x => x.id === playerId);
  const titleText = document.getElementById("pro-action-title-text");
  const labelMap = {
    service: "Service",
    reception: "R√©ception",
    passe: "Passe",
    attaque: "Attaque",
    bloc: "Bloc",
    defense: "D√©fense",
    relance: "Relance"
  };

  if (titleText) {
    titleText.textContent = (p ? (p.name || "") : "Joueur¬∑euse") + " ‚Äî " + (labelMap[cat] || cat);
  }

  proActionTarget = { playerId, cat };
  overlay.style.display = "flex";
}

function closeProActionOverlay() {
  const overlay = document.getElementById("pro-action-overlay");
  if (!overlay) return;
  overlay.style.display = "none";
  proActionTarget = null;
}

function initProActionOverlay() {
  if (proActionOverlayInitialized) return;
  const overlay = document.getElementById("pro-action-overlay");
  if (!overlay) return;

  const backdrop = document.getElementById("pro-action-backdrop");
  const btnClose = document.getElementById("pro-action-close");

  if (backdrop) backdrop.addEventListener("click", closeProActionOverlay);
  if (btnClose) btnClose.addEventListener("click", closeProActionOverlay);

  overlay.querySelectorAll(".pro-action-choice").forEach(btn => {
    btn.addEventListener("click", () => {
      if (!proActionTarget) return;
      const outcome = btn.dataset.outcome;
      addRallyStat(proActionTarget.playerId, proActionTarget.cat, outcome);
      closeProActionOverlay();
    });
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeProActionOverlay();
  });

  proActionOverlayInitialized = true;
}

function ensureProActionPads() {
  const skills = [
    { cat: "service",   label: "Srv" },
    { cat: "reception", label: "Rec" },
    { cat: "passe",     label: "Pas" },
    { cat: "attaque",   label: "Att" },
    { cat: "bloc",      label: "Blo" },
    { cat: "defense",   label: "Def" },
    { cat: "relance",   label: "Rel" }
  ];

  const outcomes = [
    { key: "plus",  label: "+" },
    { key: "minus", label: "-" },
    { key: "point", label: "P" },
    { key: "fault", label: "F" }
  ];

  document.querySelectorAll(".court-pos").forEach(posDiv => {
    // Remove old pad if any (legacy)
    const old = posDiv.querySelector(".pro-action-pad");
    if (old) old.remove();

    const pad = document.createElement("div");
    pad.className = "pro-action-pad";

    skills.forEach(s => {
      const row = document.createElement("div");
      row.className = "pro-skill-row";

      const lbl = document.createElement("div");
      lbl.className = "pro-skill-label";
      lbl.textContent = s.label;
      row.appendChild(lbl);

      outcomes.forEach(o => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "pro-out-btn";
        b.dataset.skill = s.cat;
        b.dataset.outcome = o.key;
        b.textContent = o.label;
row.appendChild(b);
      });

      pad.appendChild(row);
    });

    posDiv.appendChild(pad);
  });

  // Re-wire (click + appui long) apr√®s reconstruction du pad
  try { wireProButtons(); } catch(e) {}
}

// === Pro: boutons dans les tuiles (feedback + appui long 2s) ===
let __proPadDelegationDone = false;
const __proButtonsWired = new WeakSet();

function __proBtnContext(btn){
  const posDiv = btn.closest(".court-pos");
  if (!posDiv) return null;
  const sel = posDiv.querySelector(".pos-select");
  const playerId = sel ? (sel.value || "") : "";
  if (!playerId) return { error: "Choisis d‚Äôabord un¬∑e joueur¬∑euse sur ce poste." };
  return { playerId, skill: btn.dataset.skill, outcome: btn.dataset.outcome };
}

function wireProButtons(){
  const grid = document.getElementById("court-grid");
  if (!grid) return;

  const buttons = grid.querySelectorAll(".pro-out-btn");
  buttons.forEach((btn) => {
    if (__proButtonsWired.has(btn)) return;
    __proButtonsWired.add(btn);

    let timer = null;

    function clearPress(){
      if (timer) { clearTimeout(timer); timer = null; }
      btn.classList.remove("pressed");
    }

    function startPress(ev){
      // ignore clic droit / boutons autres
      if (ev && (ev.type === "mousedown" || ev.type === "pointerdown") && ev.button != null && ev.button !== 0) return;
      // √©vite double-d√©clenchement (PointerEvent + MouseEvent)
      if (ev && ev.type === "mousedown" && window.PointerEvent) return;
      if (ev && ev.type === "touchstart" && window.PointerEvent) return;
      btn.classList.add("pressed");
      if (timer) { clearTimeout(timer); timer = null; }

      timer = setTimeout(() => {
        timer = null;
        btn.dataset.lpConsumed = "1";
        const ctx = __proBtnContext(btn);
        if (ctx && ctx.error) { showTinyToast(ctx.error, 1100); beep(300, 120); vib(40); clearPress(); return; }
        if (!ctx) { clearPress(); return; }

        // d√©cr√©mente 1 action (bip + highlight g√©r√©s dedans)
        decrementRallyStat(ctx.playerId, ctx.skill, ctx.outcome, btn);
        clearPress();
      }, 2000);
    }

    // Pointer events (mobile + desktop)
    btn.addEventListener("pointerdown", startPress, { passive: true });
    btn.addEventListener("pointerup", clearPress, { passive: true });
    btn.addEventListener("pointercancel", clearPress, { passive: true });
    btn.addEventListener("pointerleave", clearPress, { passive: true });

    // Fallback
    btn.addEventListener("mousedown", startPress);
    btn.addEventListener("mouseup", clearPress);
    btn.addEventListener("mouseleave", clearPress);

    btn.addEventListener("touchstart", startPress, { passive: true });
    btn.addEventListener("touchend", clearPress, { passive: true });
    btn.addEventListener("touchcancel", clearPress, { passive: true });

    // Click normal => ajoute l‚Äôaction + flash (capture : √©vite les handlers h√©rit√©s)
    btn.addEventListener("click", (ev) => {
      // Si un long-press vient de d√©clencher l‚Äôannulation, on ignore le click
      if (btn.dataset.lpConsumed === "1") {
        btn.dataset.lpConsumed = "";
        ev.preventDefault();
        ev.stopImmediatePropagation();
        ev.stopPropagation();
        clearPress();
        return;
      }

      ev.preventDefault();
      ev.stopImmediatePropagation();
      ev.stopPropagation();

      const ctx = __proBtnContext(btn);
      if (ctx && ctx.error) {
        showTinyToast(ctx.error, 1100);
        beep(300, 120);
        vib(40);
        clearPress();
        return;
      }
      if (!ctx) { clearPress(); return; }

      addRallyStat(ctx.playerId, ctx.skill, ctx.outcome);
      flashBtn(btn, "tap");
      clearPress();
    }, true);
  });
}

function wireProActionPadDelegation(){
  // On garde le nom historique, mais on wire maintenant directement chaque bouton (plus fiable).
  if (__proPadDelegationDone) return;
  wireProButtons();
  __proPadDelegationDone = true;
}

// =====================================================================
// =====================================================================


    
// --- Rally Overlay wiring (robuste : fonctionne m√™me si le script est avant le HTML) ---
let __rallyOverlayInitDone = false;
function initRallyOverlayWiring() {
  if (__rallyOverlayInitDone) return;
  // On tente plusieurs fois : certains √©l√©ments peuvent ne pas exister au tout d√©but.
  const overlay = document.getElementById("rally-overlay");
  const panel   = document.getElementById("rally-overlay-panel");
  const handle  = document.getElementById("rally-drag-handle");
  const closeX  = document.getElementById("rally-close-x");
  const closeBtn= document.getElementById("rally-close-btn");
  const backdrop= document.getElementById("rally-overlay-backdrop");

  if (!overlay || !panel || !handle) return; // pas encore dans le DOM

  __rallyOverlayInitDone = true;

  if (closeX) closeX.onclick = closeRallyOverlay;
  if (closeBtn) closeBtn.onclick = closeRallyOverlay;
  if (backdrop) backdrop.onclick = closeRallyOverlay;

  // Esc pour fermer
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && overlay && overlay.style.display === "block") closeRallyOverlay();
  });

  
  // Issue selector (‚àí / P / F / +)
  try{
    document.querySelectorAll("#rally-issue-selector .rally-issue-btn").forEach((btn)=>{
      btn.addEventListener("click", (ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        setRallySelectedOutcome(btn.dataset.outcome);
      });
    });
  }catch(e){ /* no-op */ }
// D√©pla√ßable
  makeRallyPanelDraggable();
}

// S'assure que le wiring se fait quand le DOM est pr√™t
document.addEventListener("DOMContentLoaded", () => {
  // tente imm√©diatement + petit retry (au cas o√π la vue est inject√©e / reflow)
  initRallyOverlayWiring();
  setTimeout(initRallyOverlayWiring, 50);
  setTimeout(initRallyOverlayWiring, 250);
});




// ======== Rallye (copi√© du 4x4 Pro Stable) ========
function setRallyView(on){
  // Masque les √©l√©ments au-dessus du score pour gagner de la place (tablette).
  document.body.classList.toggle("rally-view", !!on);
}

function openRallyOverlay(cat, outcome) {
  initRallyOverlayWiring();

  const o = normalizeOutcome(outcome);

  // R√®gle 4x4 Pro :
  // - (+) / (-) = qualit√© : √ßa n'ajoute aucun point et le rallye reste ouvert (encha√Ænable).
  // - (P) / (F) = fin de rallye : √ßa met √† jour le score (nous / eux) et ferme le rallye.
  const isTerminal = (o === "point" || o === "fault");
  const isFlow = (o === "plus" || o === "minus");

  // Si un rallye est d√©j√† ouvert en mode "multi", on le garde ouvert tant qu'on reste sur (+/-).
  if (window.__rallyMode === "multi") {
    if (!isFlow) closeRallyOverlay(); // P/F -> on bascule en "single" (fin)
  }

  const overlay = document.getElementById("rally-overlay");
  const hintEl  = document.getElementById("rally-overlay-hint");
  const listEl  = document.getElementById("rally-player-list");
  const multiWrap = document.getElementById("rally-multi-wrap");
  const closeBtn = document.getElementById("rally-close-btn");
  const panel = document.getElementById("rally-overlay-panel");

  const titleEl = document.getElementById("rally-overlay-title");
  const subEl   = document.getElementById("rally-overlay-subtitle");

  // Multi = deux colonnes : (+) √† gauche / (-) √† droite (IDs historiques conserv√©s)
  const listPlus  = document.getElementById("rally-player-list-defense");
  const listMinus = document.getElementById("rally-player-list-passe");
  const hPlus  = multiWrap ? multiWrap.querySelector(".rally-col.def h4") : null;
  const hMinus = multiWrap ? multiWrap.querySelector(".rally-col.pass h4") : null;

  if (!overlay) return;

  const labelMap = {
    passe: "Passe",
    attaque: "Attaque",
    bloc: "Bloc",
    defense: "D√©fense",
    relance: "Relance",
    service: "Service",
    reception: "R√©ception"
  };
  const label = (labelMap[cat] || cat);

  // ---------- FIN DE RALLYE (P/F) : mode "single" ----------
  if (isTerminal || !isFlow) {
    window.__rallyMode = "single";
    window.__rallyCat = cat;
    window.__rallyOutcome = o;

    if (panel) {
      panel.dataset.cat = cat;
      panel.dataset.outcome = o;
      panel.dataset.mode = "single";
    }

    if (multiWrap) multiWrap.style.display = "none";
    if (listEl) listEl.style.display = "block";
    if (closeBtn) closeBtn.style.display = "none";

    if (titleEl) titleEl.textContent = "Rallye ‚Äî " + label;
    if (subEl) subEl.textContent = (o === "point") ? "P = point (fin de rallye)" : "F = faute (fin de rallye)";
    if (hintEl) hintEl.textContent = "Choisis la joueuse concern√©e pour valider.";

    const onCourt = getOnCourtPlayers();
    if (listEl) {
      listEl.innerHTML = "";
      if (!onCourt.length) {
        const msg = document.createElement("div");
        msg.textContent = "Aucune joueur¬∑euse sur le terrain. Renseigne les postes.";
        msg.style.fontSize = "12px";
        msg.style.color = "#f88";
        listEl.appendChild(msg);
      } else {
        onCourt.forEach((p) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "rally-player-btn";
          btn.innerHTML = `
            <span>${p.number || "-"}</span>
            <span style="flex:1; text-align:left;">${p.name || ""}</span>
            <span class="rally-count"></span>
          `;
          btn.addEventListener("click", () => {
            addRallyStat(p.id, cat, o);
            closeRallyOverlay(); // P/F = fin de rallye
          });
          listEl.appendChild(btn);
        });
      }
    }

    setRallyView(true);
    overlay.style.display = "block";
    return;
  }

  // ---------- RALLYE OUVERT (+/-) : mode "multi" ----------
  window.__rallyMode = "multi";
  window.__rallyCat = cat;
  window.__rallyOutcome = null;

  if (panel) {
    panel.dataset.cat = cat;
    panel.dataset.outcome = "flow";
    panel.dataset.mode = "multi";
  }

  if (listEl) listEl.style.display = "none";
  if (multiWrap) multiWrap.style.display = "flex";
  if (closeBtn) closeBtn.style.display = "block";

  if (titleEl) titleEl.textContent = "Rallye ‚Äî " + label;
  if (subEl) subEl.textContent = "Saisie + / - (le score ne bouge PAS). Ferme sur P/F ou via actions adverses.";
  if (hintEl) hintEl.textContent = "Tape un nom dans (+) ou (-). Tu peux encha√Æner autant que tu veux.";

  if (hPlus) hPlus.textContent = label + " (+)";
  if (hMinus) hMinus.textContent = label + " (-)";

  const onCourt = getOnCourtPlayers();

  // Compteurs par rallye, par skill, par signe (+/-)
  const counts = (window.__rallyCounts ||= {});
  if (!counts[cat]) counts[cat] = { plus: {}, minus: {} };
  const countsPlus = counts[cat].plus;
  const countsMinus = counts[cat].minus;

  function makeBtn(p, sign) {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "rally-player-btn";

    const count = (sign === "plus") ? (countsPlus[p.id] || 0) : (countsMinus[p.id] || 0);

    btn.innerHTML = `
      <span>${p.number || "-"}</span>
      <span style="flex:1; text-align:left;">${p.name || ""}</span>
      <span class="rally-count">${count ? ("x" + count) : ""}</span>
    `;

    btn.addEventListener("click", () => {
      addRallyStat(p.id, cat, sign); // (+/-) = qualit√©, aucun point
      if (sign === "plus") countsPlus[p.id] = (countsPlus[p.id] || 0) + 1;
      else countsMinus[p.id] = (countsMinus[p.id] || 0) + 1;

      const cEl = btn.querySelector(".rally-count");
      if (cEl) {
        const newCount = (sign === "plus") ? countsPlus[p.id] : countsMinus[p.id];
        cEl.textContent = newCount ? ("x" + newCount) : "";
      }
    });

    return btn;
  }

  if (listPlus) listPlus.innerHTML = "";
  if (listMinus) listMinus.innerHTML = "";

  if (!onCourt.length) {
    const msg = document.createElement("div");
    msg.textContent = "Aucune joueur¬∑euse sur le terrain. Renseigne les postes.";
    msg.style.fontSize = "12px";
    msg.style.color = "#f88";
    if (listPlus) listPlus.appendChild(msg.cloneNode(true));
    if (listMinus) listMinus.appendChild(msg);
  } else {
    onCourt.forEach((p) => {
      if (listPlus) listPlus.appendChild(makeBtn(p, "plus"));
      if (listMinus) listMinus.appendChild(makeBtn(p, "minus"));
    });
  }

  setRallyView(true);
  overlay.style.display = "block";
}

/* =========================
   Rallye overlay (matrix 4 rubriques)
   ========================= */
function setRallySelectedOutcome(outcome) {
  const o = normalizeOutcome(outcome) || "plus";
  const allowed = ["plus", "minus", "point", "fault"];
  const sel = allowed.includes(o) ? o : "plus";
  window.__rallySelectedOutcome = sel;

  // Active button state
  document.querySelectorAll("#rally-issue-selector .rally-issue-btn").forEach((b) => {
    const bo = normalizeOutcome(b.dataset.outcome);
    b.classList.toggle("active", bo === sel);
  });

  // Refresh counts display if overlay is open
  const overlay = document.getElementById("rally-overlay");
  if (overlay && overlay.style.display === "block") {
    renderRallyMatrixPlayers();
  }
}

function openRallyMatrixOverlay(prefSkill, prefOutcome) {
  initRallyOverlayWiring();
  // En mode Rallye, on passe en vue compacte (score + stats adverses)
  setRallyView(true);


  const overlay = document.getElementById("rally-overlay");
  const panel   = document.getElementById("rally-overlay-panel");
  const titleEl = document.getElementById("rally-overlay-title");
  const subEl   = document.getElementById("rally-overlay-subtitle");
  const matrixWrap = document.getElementById("rally-matrix-wrap");
  const listEl = document.getElementById("rally-player-list"); // legacy (si pr√©sent)

  if (!overlay || !panel) return;

  window.__rallyMode = "matrix";
  panel.dataset.mode = "matrix";
  panel.dataset.cat = "matrix";

  if (titleEl) titleEl.textContent = "Rallye";
  if (subEl) subEl.textContent = "Passe ‚Ä¢ Attaque ‚Ä¢ D√©fense ‚Ä¢ Relance";

  // On masque l'ancien mode, si jamais il existe encore dans une autre variante
  if (listEl) listEl.style.display = "none";
  if (matrixWrap) matrixWrap.style.display = "block";

  // Default outcome
  setRallySelectedOutcome(prefOutcome || window.__rallySelectedOutcome || "plus");

  // Render players
  renderRallyMatrixPlayers();

  setRallyView(true);
  overlay.style.display = "block";

  // Petit focus visuel sur une rubrique (si ouvert depuis un raccourci)
  if (prefSkill && panel.querySelector) {
    const card = panel.querySelector('.rally-matrix-card[data-skill="' + prefSkill + '"]');
    if (card) {
      card.classList.add("flash");
      setTimeout(() => card.classList.remove("flash"), 450);
    }
  }
}

function renderRallyMatrixPlayers() {
  const cats = ["passe", "attaque", "defense", "relance"];
  const onCourt = getOnCourtPlayers ? getOnCourtPlayers() : [];
  const out = normalizeOutcome(window.__rallySelectedOutcome || "plus");

  const counts = (window.__rallyCounts ||= {});
  cats.forEach((cat) => {
    if (!counts[cat]) counts[cat] = { plus: {}, minus: {} };
  });

  function fillList(cat) {
    const list = document.getElementById("rally-player-list-" + cat);
    if (!list) return;

    list.innerHTML = "";

    if (!onCourt.length) {
      const msg = document.createElement("div");
      msg.textContent = "Aucune joueur¬∑euse sur le terrain. Renseigne les postes.";
      msg.style.fontSize = "12px";
      msg.style.color = "#f88";
      list.appendChild(msg);
      return;
    }

    onCourt.forEach((p) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "rally-player-btn";

      const showCount = (out === "plus" || out === "minus");
      let c = 0;
      if (showCount) {
        c = (out === "plus") ? (counts[cat].plus[p.id] || 0) : (counts[cat].minus[p.id] || 0);
      }

      btn.innerHTML = `
        <span>${p.number || "-"}</span>
        <span style="flex:1; text-align:left;">${p.name || ""}</span>
        <span class="rally-count">${c ? ("x" + c) : ""}</span>
      `;

      btn.addEventListener("click", () => {
        const o = normalizeOutcome(window.__rallySelectedOutcome || "plus");

        addRallyStat(p.id, cat, o);

        // (+/-) = qualit√© : on reste ouvert + compteur par rubrique
        if (o === "plus" || o === "minus") {
          if (o === "plus") counts[cat].plus[p.id] = (counts[cat].plus[p.id] || 0) + 1;
          else counts[cat].minus[p.id] = (counts[cat].minus[p.id] || 0) + 1;

          const cEl = btn.querySelector(".rally-count");
          if (cEl) {
            const newCount = (o === "plus") ? counts[cat].plus[p.id] : counts[cat].minus[p.id];
            cEl.textContent = newCount ? ("x" + newCount) : "";
          }
          return;
        }

        // (P/F) = fin de rallye : score + fermeture
        closeRallyOverlay();
      });

      // Clic droit = d√©cr√©mente de 1 (correction rapide)
      btn.addEventListener("contextmenu", (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();

        const o = normalizeOutcome(window.__rallySelectedOutcome || "plus");

        // (+/-) : on d√©cr√©mente le compteur visuel + la stat, et on reste ouvert
        if (o === "plus" || o === "minus") {
          const store = (o === "plus") ? counts[cat].plus : counts[cat].minus;
          const prevC = (store[p.id] || 0);
          if (prevC <= 0) {
            try { beep(220, 70); } catch(e) {}
            try { vib(15); } catch(e) {}
            return;
          }

          store[p.id] = Math.max(0, prevC - 1);
          addRallyStat(p.id, cat, o, -1);

          const cEl = btn.querySelector(".rally-count");
          if (cEl) {
            const newCount = store[p.id] || 0;
            cEl.textContent = newCount ? ("x" + newCount) : "";
          }
          return;
        }

        // (P/F) : correction -1 (stat + score) sans fermer l‚Äôoverlay
        addRallyStat(p.id, cat, o, -1);
      });

      list.appendChild(btn);
    });
  }

  cats.forEach(fillList);
}



    function closeRallyOverlay() {
  const overlay = document.getElementById("rally-overlay");
  if (overlay) overlay.style.display = "none";
  setRallyView(false);
  window.__rallyMode = null;
  window.__rallyCat = null;
  window.__rallyOutcome = null;
  window.__rallyCounts = {};
}

    
// ======== /Rallye ========
/* --------- stockage scores sets ---------- */
    function loadSetScores() {
      const raw = localStorage.getItem(SETS_KEY);
      if (!raw) return;
      try { setScores = JSON.parse(raw) || {}; }
      catch(e){ setScores = {}; }
    }
    function saveSetScores() {
      localStorage.setItem(SETS_KEY, JSON.stringify(setScores));
    }
        function createEmptySetScore() {
      return {
        nous: 0,
        eux: 0,
        tmTech: 0, // temps morts techniques (communs)
        tmNous: 0, // temps morts pour notre √©quipe
        tmEux: 0   // temps morts pour l'adversaire
      };
    }

    /* ===== R√àGLES OFFICIELLES DE SCORE (Volley) =====
       - Match en 3 sets gagnants (max 5 sets)
       - Sets 1‚Üí4 : 25 points, 2 points d'√©cart minimum
       - Set 5 (tie-break) : 15 points, 2 points d'√©cart minimum
    */
    function getSetTargetPoints(setNumber){
      return (Number(setNumber) === 5) ? 15 : 25;
    }
    function getOtherTeam(team){ return team === "nous" ? "eux" : "nous"; }

    // Set 5 (tie-break) seulement si on arrive √† 2-2 en sets (ou si le set 5 a d√©j√† commenc√©)
    function isSet5Allowed(){
      const tw = computeSetsWon();
      const set5 = setScores && setScores[5] ? setScores[5] : null;
      const set5Started = !!(set5 && ((set5.nous||0) > 0 || (set5.eux||0) > 0 || set5.done));
      return set5Started || (tw.nous === 2 && tw.eux === 2);
    }

    function getLastPlayedSet(){
      let last = 1;
      for (let i=1;i<=5;i++){
        const s = setScores && setScores[i] ? setScores[i] : null;
        if (!s) continue;
        const has = (s.done) || ((s.nous||0)>0) || ((s.eux||0)>0) || ((s.tmTech||0)>0) || ((s.tmNous||0)>0) || ((s.tmEux||0)>0);
        if (has) last = i;
      }
      return last;
    }

    function getMaxAllowedSet(){
      const tw = computeSetsWon();
      const matchDone = (tw.nous >= 3 || tw.eux >= 3);
      if (matchDone) return Math.max(getLastPlayedSet(), currentSet || 1);
      return isSet5Allowed() ? 5 : 4;
    }

    function ensureSetMeta(setNumber){
      const s = getSetScore(setNumber);
      if (typeof s.done !== "boolean") s.done = false;
      if (!s.winner) s.winner = null;
      if (!s.target) s.target = getSetTargetPoints(setNumber);
      return s;
    }

    function isSetWon(setNumber){
      const s = ensureSetMeta(setNumber);
      const target = getSetTargetPoints(setNumber);
      const a = Number(s.nous||0), b = Number(s.eux||0);
      if (a >= target || b >= target){
        if (Math.abs(a-b) >= 2){
          return (a > b) ? "nous" : "eux";
        }
      }
      return null;
    }

    function computeSetsWon(){
      let wn = 0, we = 0;
      for (let i=1;i<=5;i++){
        const w = isSetWon(i) || (setScores[i] && setScores[i].winner) || null;
        if (w === "nous") wn++;
        if (w === "eux") we++;
      }
      return { nous: wn, eux: we };
    }

    function finalizeSetIfNeeded(setNumber){
      const s = ensureSetMeta(setNumber);
      if (s.done) return null;
      const w = isSetWon(setNumber);
      if (!w) return null;
      s.done = true;
      s.winner = w;
      s.target = getSetTargetPoints(setNumber);
      return w;
    }



    function getSetScore(setNumber) {
      if (!setScores[setNumber]) setScores[setNumber] = createEmptySetScore();
      return setScores[setNumber];
    }

    /* --------- stockage stats adverses ---------- */
    function loadOpponentStats() {
      const raw = localStorage.getItem(OPP_KEY);
      if (!raw) return;
      try { opponentStats = JSON.parse(raw) || {}; }
      catch(e){ opponentStats = {}; }
    }
    function saveOpponentStats() {
      localStorage.setItem(OPP_KEY, JSON.stringify(opponentStats));
    }
    function createEmptyOpponentStats() {
      const o = {};
      OPP_CATEGORIES.forEach(cat => {
        o[cat + "Plus"] = 0;
        o[cat + "Minus"] = 0;
      });
      // D√©tail des fautes adverses directes (point pour nous)
      o.errService = 0;
      o.errAttaque = 0;
      o.errBloc = 0;
      o.errAutre = 0;
      return o;
    }
    function getOpponentSetStats(setNumber) {
      if (!opponentStats[setNumber]) opponentStats[setNumber] = createEmptyOpponentStats();
      return opponentStats[setNumber];
    }

    /* --------- historique ---------- */
    function loadHistory() {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return;
      try { historyMatches = JSON.parse(raw) || []; }
      catch(e){ historyMatches = []; }
    }
    function saveHistory() {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(historyMatches));
    }
        /* --------- stockage terrain (positions) ---------- */
    function loadCourtFromStorage() {
      const raw = localStorage.getItem(COURT_KEY);
      if (!raw) return {};
      try {
        return JSON.parse(raw) || {};
      } catch (e) {
        return {};
      }
    }

    function saveCourtToStorage() {
      const map = getCourtAssignments();
      try {
        localStorage.setItem(COURT_KEY, JSON.stringify(map));
      } catch (e) {
        // silencieux, on ne bloque pas l'app si le stockage √©choue
      }
    }

    function applyCourtFromStorage() {
      const saved = loadCourtFromStorage();
      if (!saved) return;

      // on ne garde que les IDs encore existants
      const validIds = new Set(players.map(p => p.id));

      document.querySelectorAll(".court-pos").forEach(posDiv => {
        const posKey = posDiv.dataset.pos || "";
        const select = posDiv.querySelector(".pos-select");
        if (!select) return;

        const savedId = saved[posKey];
        if (savedId && validIds.has(savedId)) {
          select.value = savedId;
        }

        updatePositionJersey(select);
      });

      renderBench();
      updateCourtWarningsForSet();
    }

    /* --------- noms d‚Äô√©quipes ---------- */
    function loadTeamNames() {
      const raw = localStorage.getItem(TEAM_KEY);
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw) || {};
        teamNames.our = parsed.our || DEFAULT_OUR_TEAM_NAME;
        teamNames.opp = parsed.opp || DEFAULT_OPP_LABEL;
      } catch (e) {
        teamNames.our = DEFAULT_OUR_TEAM_NAME;
        teamNames.opp = DEFAULT_OPP_LABEL;
      }
    }

    function saveTeamNames() {
      localStorage.setItem(TEAM_KEY, JSON.stringify({
        our: teamNames.our || "",
        opp: teamNames.opp || ""
      }));
    }

    function getOurTeamName() {
      return (teamNames.our && teamNames.our.trim()) || DEFAULT_US_LABEL;
    }

    function getOppTeamName() {
      return (teamNames.opp && teamNames.opp.trim()) || DEFAULT_OPP_LABEL;
    }

       function updateTeamNamesUI() {
      const our = getOurTeamName();
      const opp = getOppTeamName();

      const titleEl = document.getElementById("app-title");
      if (titleEl) {
        if (teamNames.our && teamNames.our.trim()) {
          titleEl.textContent = teamNames.our.trim();
        } else {
          titleEl.textContent = DEFAULT_OUR_TEAM_NAME;
        }
      }

      const inpOur = document.getElementById("team-name-input");
      if (inpOur && inpOur.value !== (teamNames.our || "")) {
        inpOur.value = teamNames.our || "";
      }

      const inpOpp = document.getElementById("opponent-name-input");
      if (inpOpp && inpOpp.value !== (teamNames.opp || "")) {
        inpOpp.value = teamNames.opp || "";
      }

      const lblNous = document.getElementById("score-label-nous");
      if (lblNous) {
        lblNous.textContent = our;
      }

      const lblAdv = document.getElementById("score-label-adv");
      if (lblAdv) {
        lblAdv.textContent = opp;
      }

      const dashNameUs = document.getElementById("dash-team-name-us");
      if (dashNameUs) {
        dashNameUs.textContent = our;
      }

      const dashNameOpp = document.getElementById("dash-team-name-opponent");
      if (dashNameOpp) {
        dashNameOpp.textContent = opp;
      }

      const oppTitle = document.getElementById("opponent-title");
      if (oppTitle) {
        if (opp) {
          oppTitle.textContent = "Stats adversaires ‚Äì " + opp;
        } else {
          oppTitle.textContent = "Stats adversaires";
        }
      }

      // Noms dans le panneau "Temps morts"
      const tmNousName = document.getElementById("tm-nous-name");
      if (tmNousName) {
        tmNousName.textContent = our;
      }

      const tmEuxName = document.getElementById("tm-eux-name");
      if (tmEuxName) {
        tmEuxName.textContent = opp;
      }

      try {
        if (our) {
          document.title = "Stats volley ‚Äì " + our;
        } else {
          document.title = DEFAULT_OUR_TEAM_NAME;
        }
      } catch (e) {}
    }

    /* --------- export / import configuration ---------- */
    function exportConfigToTextarea() {
      const textarea = document.getElementById("config-json");
      if (!textarea) return;

      // on prend l'effectif, les noms d'√©quipes et la compo terrain actuelle
      const payload = {
        version: "stat2match-volley_v1.3",
        generatedAt: new Date().toISOString(),
        teamNames: {
          our: teamNames.our || "",
          opp: teamNames.opp || ""
        },
        players: players || [],
        court: (typeof getCourtAssignments === "function")
          ? getCourtAssignments()
          : {}
      };

      textarea.value = JSON.stringify(payload, null, 2);
      textarea.focus();
      textarea.select();
    }

    function importConfigFromTextarea() {
      const textarea = document.getElementById("config-json");
      if (!textarea) return;

      const raw = textarea.value.trim();
      if (!raw) {
        alert("Colle d‚Äôabord une configuration √† importer dans la zone de texte.");
        return;
      }

      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch (e) {
        alert("Texte invalide. Assure-toi de coller un JSON complet.");
        return;
      }

      

      if (Array.isArray(parsed.players)) {
        players = parsed.players;
        savePlayers();
      }

      // Noms d‚Äô√©quipes
      if (parsed.teamNames) {
        teamNames.our = parsed.teamNames.our || teamNames.our;
        teamNames.opp = parsed.teamNames.opp || teamNames.opp;
        saveTeamNames();
      }

      // Compo terrain
      if (parsed.court && typeof parsed.court === "object") {
        try {
          localStorage.setItem(COURT_KEY, JSON.stringify(parsed.court));
        } catch (e) {
          // on ignore si stockage impossible
        }
      }

      // On rafra√Æchit l‚ÄôUI
      renderRoster();
      applyCourtFromStorage();
      updateTeamNamesUI();

  ;

      // Pro : rafra√Æchir UI terrain
      renderProControlsUI();
      ensureProActionPads();
      wireProActionPadDelegation();
alert("Configuration import√©e. Effectif, noms d‚Äô√©quipes et terrain ont √©t√© mis √† jour.");
    }

    /* --------- utils ---------- */
        function colorClass(color) {
       return {
         blue: "c-blue",
         green: "c-green",
         red: "c-red",
         yellow: "c-yellow",
         purple: "c-purple",
         orange: "c-orange",
         teal: "c-teal",
         pink: "c-pink"
       }[color] || "c-blue";
     }


    function deepClone(obj) {
      return JSON.parse(JSON.stringify(obj || {}));
    }
    // Copie de secours pour les navigateurs / contextes o√π navigator.clipboard ne marche pas
    function fallbackCopy(textarea) {
      if (!textarea) {
        alert("S√©lectionne le texte et copie-le manuellement.");
        return;
      }

      try {
        textarea.focus();
        textarea.select();

        const ok = document.execCommand("copy");
        if (ok) {
          alert("Texte copi√©, tu peux le coller dans WhatsApp / mail.");
        } else {
          alert("S√©lectionne le texte et copie-le manuellement.");
        }
      } catch (e) {
        alert("S√©lectionne le texte et copie-le manuellement.");
      }

      // Met √† jour les distinctions (liste + suggestions) sans forcer si l'utilisateur a choisi
      if (typeof refreshAwardsUI === "function") refreshAwardsUI();

    }

       /* --------- rendu effectif ---------- */
    function renderRoster() {
      const list = document.getElementById("player-list");
      if (!list) return;
      list.innerHTML = "";

      const sorted = (players || []).slice().sort((a, b) =>
        (a.name || "").localeCompare(b.name || "")
      );

      sorted.forEach((p) => {
        const li = document.createElement("li");
        li.className = "player-item";

        const main = document.createElement("div");
        main.className = "player-main";
        main.onclick = () => openPlayerStats(p.id);

        const badge = document.createElement("div");
        badge.className = "badge-jersey " + colorClass(p.color);
        badge.textContent = p.number || "-";

        const info = document.createElement("div");
        let line = p.name || "";
        if (p.role) line += " ¬∑ " + p.role;
        if (p.license) line += " ¬∑ Lic. " + p.license;
        info.textContent = line;

        main.appendChild(badge);
        main.appendChild(info);

        const actions = document.createElement("div");
        actions.className = "player-actions";

        // ‚úÖ coche : dans l'effectif de match ou non
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.title = "Inclure dans l'effectif de match";
        chk.checked = p.inMatch !== false; // undefined => true par d√©faut

        // on √©vite que le clic sur la case ouvre la fiche stats
        chk.onclick = (ev) => {
          ev.stopPropagation();
        };

        chk.onchange = (ev) => {
          ev.stopPropagation();
          p.inMatch = chk.checked;
          savePlayers();

          // si on enl√®ve la joueur¬∑euse du match, on la retire aussi du terrain
          if (!p.inMatch) {
            document.querySelectorAll(".pos-select").forEach((sel) => {
              if (sel.value === p.id) {
                sel.value = "";
                updatePositionJersey(sel);
              }
            });
            if (typeof saveCourtToStorage === "function") {
              saveCourtToStorage();
            }
          }

          // on met √† jour banc + listes terrain
          refreshPositionSelects();
          renderBench();
          refreshAwardsSelectors();
        };

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn-edit";
        btnEdit.textContent = "‚úèÔ∏è";
        btnEdit.onclick = (ev) => {
          ev.stopPropagation();
          fillFormForEdit(p.id);
        };

        const btnDelete = document.createElement("button");
        btnDelete.className = "btn-delete";
        btnDelete.textContent = "üóëÔ∏è";
        btnDelete.onclick = (ev) => {
          ev.stopPropagation();
          deletePlayer(p.id);
        };

        actions.appendChild(chk);
        actions.appendChild(btnEdit);
        actions.appendChild(btnDelete);

        li.appendChild(main);
        li.appendChild(actions);
        list.appendChild(li);
      });

      refreshPositionSelects();
      renderBench();
      refreshAwardsSelectors();
    }

  function refreshAwardsSelectors() {
  const mvpSelect     = document.getElementById("select-mvp");
  const supportSelect = document.getElementById("select-best-support");
  const blockSelect   = document.getElementById("select-best-block");
  if (!mvpSelect && !supportSelect && !blockSelect) return;

  function fillSelect(select) {
    if (!select) return;
    const current = select.value;
    select.innerHTML = "";

    const optNone = document.createElement("option");
    optNone.value = "";
    optNone.textContent = "‚Äî Aucune ‚Äî";
    select.appendChild(optNone);

    players
      .slice()
      .sort((a, b) => (a.name || "").localeCompare(b.name || ""))
      .forEach(p => {
        const o = document.createElement("option");
        o.value = p.id;
        o.textContent =
          (p.number ? "#" + p.number + " " : "") + (p.name || "");
        if (current && current === p.id) o.selected = true;
        select.appendChild(o);
      });
  }

  fillSelect(mvpSelect);
  fillSelect(supportSelect);
  fillSelect(blockSelect);
}


   function fillFormForEdit(id) {
  const p = players.find((x) => x.id === id);
  if (!p) return;
  document.getElementById("player-id").value = p.id;
  document.getElementById("player-name").value = p.name || "";
  document.getElementById("player-number").value = p.number || "";
  document.getElementById("player-license").value = p.license || "";
  document.getElementById("player-role").value = p.role || "";
  document.getElementById("player-color").value = p.color || "blue";
  const chk = document.getElementById("player-in-match");
  if (chk) chk.checked = (p.inMatch !== false); // undefined => true par d√©faut
}



    function deletePlayer(id) {
      if (!confirm("Supprimer cette joueur¬∑euse ?")) return;
      players = players.filter((p) => p.id !== id);
      savePlayers();
      renderRoster();
    }

    /* --------- terrain / banc ---------- */
    function getSelectedIds() {
      return Array.from(document.querySelectorAll(".pos-select"))
        .map((s) => s.value)
        .filter((v) => v);
    }
function getCourtAssignments() {
  const map = {};
  document.querySelectorAll(".court-pos").forEach((posDiv) => {
    const key = posDiv.dataset.pos || "";
    const select = posDiv.querySelector(".pos-select");
    map[key] = select ? select.value : "";
  });
  return map;
}
function rotateCourtClockwise() {
  const order = ["AG", "AC", "AD", "ARD", "ARC", "ARG"];

  const assignments = getCourtAssignments();

  const rotated = { ...assignments };
  for (let i = 0; i < order.length; i++) {
    const from = order[i];
    const to = order[(i + 1) % order.length]; // poste suivant (sens horaire)
    rotated[to] = assignments[from] || "";
  }

  applyCourtRotation(rotated);
}

function rotateCourtCounterClockwise() {
  const order = ["AG", "AC", "AD", "ARD", "ARC", "ARG"];

  const assignments = getCourtAssignments();

  const rotated = { ...assignments };
  for (let i = 0; i < order.length; i++) {
    const from = order[i];
    const to = order[(i - 1 + order.length) % order.length]; // poste pr√©c√©dent (sens inverse)
    rotated[to] = assignments[from] || "";
  }

  applyCourtRotation(rotated);
}

// fonction commune pour appliquer la rotation
function applyCourtRotation(rotated) {
  document.querySelectorAll(".court-pos").forEach((posDiv) => {
    const key = posDiv.dataset.pos || "";
    const select = posDiv.querySelector(".pos-select");
    if (!select) return;

    if (key in rotated) {
      select.value = rotated[key] || "";
      updatePositionJersey(select);
    }
  });

  if (typeof renderBench === "function") {
    renderBench();
  }
  if (typeof updateCourtWarningsForSet === "function") {
    updateCourtWarningsForSet();
  }
  if (typeof saveCourtToStorage === "function") {
    saveCourtToStorage();
  }
  if (typeof refreshPositionSelects === "function") {
    refreshPositionSelects();
  }
}


     function refreshPositionSelects() {
      // Qui est d√©j√† sur le terrain ?
      const assignments = getCourtAssignments();
      const usedIds = new Set(Object.values(assignments).filter((v) => v));

      const selects = document.querySelectorAll(".pos-select");
      selects.forEach((select) => {
        const posDiv = select.closest(".court-pos");
        const posKey = posDiv ? posDiv.dataset.pos || "" : "";
        const current = posKey ? assignments[posKey] || "" : select.value;

        // On reconstruit la liste des options
        select.innerHTML = "";
        const optEmpty = document.createElement("option");
        optEmpty.value = "";
        optEmpty.textContent = "- Vide -";
        select.appendChild(optEmpty);

        // üëâ seulement les joueur¬∑euses s√©lectionn√©¬∑es pour ce match
        const matchPlayers = (players || [])
          .filter((p) => p.inMatch !== false)
          .slice()
          .sort((a, b) => (a.name || "").localeCompare(b.name || ""));

        matchPlayers.forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent =
            (p.number ? "#" + p.number + " " : "") + (p.name || "");

          if (p.id === current) {
            opt.selected = true; // elle reste √† ce poste
          } else if (usedIds.has(p.id)) {
            opt.disabled = true;
            opt.textContent += " (sur le terrain)";
          }

          select.appendChild(opt);
        });

        updatePositionJersey(select);

        // Quand on change une joueur¬∑euse
        select.onchange = (e) => {
          e.stopPropagation();
          updatePositionJersey(select);
          renderBench();
          updateCourtWarningsForSet();
          if (typeof saveCourtToStorage === "function") {
            saveCourtToStorage();
          }
          // On recharge les listes pour la r√®gle "une fois max"
          refreshPositionSelects();
        };

        if (posDiv) {
          posDiv.onclick = (ev) => {
            if (ev.target.tagName === "SELECT") return;
            const id = select.value;
            if (id) openPlayerStats(id);
          };
        }
      });
    }

    function updatePositionJersey(select) {
      const posDiv = select.parentElement;
      const jersey = posDiv.querySelector(".pos-jersey");
      if (!jersey) return;
      const id = select.value;

      // reset
      jersey.innerHTML = "";
      jersey.className = "pos-jersey";
      jersey.style.background = "";

      if (!id) {
        jersey.textContent = "‚Äî";
        jersey.style.background = "rgba(0,0,0,0.1)";
        return;
      }

      const p = players.find((x) => x.id === id);
      if (!p) return;

      jersey.className = "pos-jersey " + colorClass(p.color);
      const name = document.createElement("span");
      name.textContent = p.name || "";
      name.className = "name";

      const role = document.createElement("span");
      role.textContent = p.role || "";      jersey.appendChild(name);
      if (p.role) jersey.appendChild(role);
    }
    function renderBench() {
      const selectedIds = new Set(getSelectedIds());
      const benchDiv = document.getElementById("bench-list");
      if (!benchDiv) return;
      benchDiv.innerHTML = "";

      // üëâ seulement les joueur¬∑euses coch√©s "dans l‚Äôeffectif du match"
      const matchPlayers = (players || [])
        .filter(p => p.inMatch !== false)
        .slice()
        .sort((a, b) => (a.name || "").localeCompare(b.name || ""));

      matchPlayers
        .filter((p) => !selectedIds.has(p.id))  // pas d√©j√† sur le terrain
        .forEach((p) => {
          const div = document.createElement("div");
          div.className = "bench-player";

          // clic sur le banc ‚Üí fiche stats
          div.onclick = () => {
            if (!p.id) return;
            openPlayerStats(p.id);
          };

          const badge = document.createElement("div");
          badge.className = "badge-jersey " + colorClass(p.color);
          badge.textContent = p.number || "-";

          const name = document.createElement("span");
          name.textContent = p.name || "";

          div.appendChild(badge);
          div.appendChild(name);
          benchDiv.appendChild(div);
        });
    }


    /* --------- halo rouge selon delta set ---------- */
    function updateCourtWarningsForSet() {
  document.querySelectorAll(".court-pos").forEach(pos => {
    pos.classList.remove("danger-delta");
    const select = pos.querySelector(".pos-select");
    if (!select) return;
    const id = select.value;
    if (!id) return;
    const s = stats[id] && stats[id][currentSet];
    if (!s) return;

    let totalFaults = 0;
    let totalPoints = 0;
    STAT_CATEGORIES.forEach(cat => {
      totalFaults += (s[cat + "Fault"] || 0);
      totalPoints += (s[cat + "Point"] || 0);
    });

    const delta = totalPoints - totalFaults;
    if (delta <= NEG_DELTA_THRESHOLD) {
      pos.classList.add("danger-delta");
    }
  });
  // MAJ des contr√¥les pro (listes lib√©ro + cibles)
  if (typeof fillLiberoSelect === "function") fillLiberoSelect();
  if (typeof fillLiberoTargetSelects === "function") fillLiberoTargetSelects();
  if (typeof renderProControlsUI === "function") renderProControlsUI();

  // Auto-lib√©ro peut d√©pendre de la rotation / des postes
  if (typeof autoLiberoTick === "function") autoLiberoTick("refreshPositionSelects");

}


    /* --------- sets ---------- */
    function initSetButtonsMain() {
      document.querySelectorAll(".set-btn-main").forEach(btn => {
        mainSetButtons.push(btn);
        btn.addEventListener("click", () => {
          setCurrentSet(parseInt(btn.dataset.set, 10));
        });
      });
    }
    function initSetButtonsStats() {
      document.querySelectorAll(".set-btn-stats").forEach(btn => {
        statsSetButtons.push(btn);
        btn.addEventListener("click", () => {
          setCurrentSet(parseInt(btn.dataset.set, 10));
        });
      });
    }
    function initSetButtonsDashboard() {
      document.querySelectorAll(".set-btn-dashboard").forEach(btn => {
        dashboardSetButtons.push(btn);
        btn.addEventListener("click", () => {
          setCurrentSet(parseInt(btn.dataset.set, 10));
        });
      });
    }

    function updateSetButtons() {
      const maxAllowed = getMaxAllowedSet();
      mainSetButtons.forEach(b => {
        const sn = parseInt(b.dataset.set, 10);
        b.classList.toggle("active", sn === currentSet);
        const enabled = (sn <= maxAllowed);
        b.disabled = !enabled;
        b.classList.toggle("is-disabled", !enabled);
        b.setAttribute("aria-disabled", enabled ? "false" : "true");
      });
      statsSetButtons.forEach(b => {
        const sn = parseInt(b.dataset.set, 10);
        b.classList.toggle("active", sn === currentSet);
        const enabled = (sn <= maxAllowed);
        b.disabled = !enabled;
        b.classList.toggle("is-disabled", !enabled);
        b.setAttribute("aria-disabled", enabled ? "false" : "true");
      });
      dashboardSetButtons.forEach(b => {
        const sn = parseInt(b.dataset.set, 10);
        b.classList.toggle("active", sn === currentSet);
        const enabled = (sn <= maxAllowed);
        b.disabled = !enabled;
        b.classList.toggle("is-disabled", !enabled);
        b.setAttribute("aria-disabled", enabled ? "false" : "true");
      });
    }

    function setCurrentSet(n) {
      const next = parseInt(n, 10);
      if (!Number.isFinite(next) || next < 1 || next > 5) return;

      // Set 5 verrouill√© tant qu'on n'est pas √† 2-2 (sauf si d√©j√† commenc√©)
      if (next === 5 && !isSet5Allowed()) {
        alert("Le set 5 (tie-break) n‚Äôest disponible que si le match est √† 2‚Äì2 en sets.");
        return;
      }

      const maxAllowed = getMaxAllowedSet();
      if (next > maxAllowed) return;

      currentSet = next;
      updateSetButtons();
      renderSetScore();
      renderOpponentStats();
      if (currentStatsPlayerId) renderStatsForCurrent();
      if (typeof initDiagnosticsToggle === 'function') if (typeof initDiagnosticsToggle === 'function') initDiagnosticsToggle();
      renderDashboard();
      updateCourtWarningsForSet();
    }
/* --------- score du set ---------- */
           function renderTimeouts() {
      const s = getSetScore(currentSet);

      let tmTech = s.tmTech || 0;
      let tmNous = s.tmNous || 0;
      let tmEux = s.tmEux || 0;

      // On borne entre 0 et 2
      if (tmTech < 0) tmTech = 0;
      if (tmTech > 2) tmTech = 2;
      if (tmNous < 0) tmNous = 0;
      if (tmNous > 2) tmNous = 2;
      if (tmEux < 0) tmEux = 0;
      if (tmEux > 2) tmEux = 2;

      s.tmTech = tmTech;
      s.tmNous = tmNous;
      s.tmEux = tmEux;

      const techSpan = document.getElementById("tm-tech-count");
      const ourSpan  = document.getElementById("tm-nous-count");
      const oppSpan  = document.getElementById("tm-eux-count");

      if (techSpan) techSpan.textContent = tmTech + "/2";
      if (ourSpan)  ourSpan.textContent  = tmNous + "/2";
      if (oppSpan)  oppSpan.textContent  = tmEux + "/2";

      // Mise √† jour visuelle des pastilles
      const updateDots = (type, count) => {
        const dots = document.querySelectorAll('.tm-dot[data-tm-type="' + type + '"]');
        dots.forEach((btn, index) => {
          if (index < count) {
            btn.classList.add("tm-used");
          } else {
            btn.classList.remove("tm-used");
          }
        });
      };

      updateDots("tech", tmTech);
      updateDots("nous", tmNous);
      updateDots("eux", tmEux);
    }


    function renderSetScore() {
      const s = getSetScore(currentSet);
      const labelEl = document.getElementById("score-set-label");
      const valNous = document.querySelector('.score-value[data-team="nous"]');
      const valEux = document.querySelector('.score-value[data-team="eux"]');

      if (labelEl) {
        labelEl.textContent = "(set " + currentSet + ")";
      }
      if (valNous) {
        valNous.textContent = s.nous;
      }
      if (valEux) {
        valEux.textContent = s.eux;
      }

      renderOpponentPointPanel();
      renderOpponentFaultPanel();

      renderTimeouts();
    }


        function initScoreControls() {
      const scoreSec = document.getElementById("score-section");
      if (!scoreSec) {
        return;
      }

      scoreSec.addEventListener("click", function (e) {
        const plusBtn = e.target.closest(".score-btn-plus");
        const minusBtn = e.target.closest(".score-btn-minus");
        const valueSpan = e.target.closest(".score-value");
        const tmBtn = e.target.closest("button[data-tm-type]");

        // Gestion du score + / -
        if (plusBtn || minusBtn) {
          const btn = plusBtn || minusBtn;
          const team = btn.dataset.team;
          const s = getSetScore(currentSet);

          if (plusBtn) {
            s[team] = (s[team] || 0) + 1;
          } else {
            s[team] = Math.max(0, (s[team] || 0) - 1);
          }

          saveSetScores();
          renderSetScore();
          renderDashboard();
          return;
        }

        // Correction du score en cliquant sur le nombre
        if (valueSpan) {
          const team = valueSpan.dataset.team;
          const s = getSetScore(currentSet);
          const current = s[team] || 0;
          const labelScore = team === "nous" ? "notre score" : "score adverse";
          const input = prompt(
            "Corriger " + labelScore + " (set " + currentSet + ")",
            String(current)
          );

          if (input === null) {
            return;
          }

          const val = parseInt(input, 10);
          if (!Number.isNaN(val) && val >= 0) {
            s[team] = val;
            saveSetScores();
            renderSetScore();
            renderDashboard();
          }
          return;
        }

               

        if (tmBtn) {
          const s = getSetScore(currentSet);
          const type = tmBtn.dataset.tmType;        // "tech" | "nous" | "eux"
          const dir = tmBtn.dataset.tmDir || null;  // "plus" | "minus" (anciens boutons)
          const indexStr = tmBtn.dataset.tmIndex || null; // "1" | "2" pour les pastilles

          let key;
          if (type === "tech") {
            key = "tmTech";
          } else if (type === "nous") {
            key = "tmNous";
          } else {
            key = "tmEux";
          }

          let val = s[key] || 0;

          // Nouveau mode : pastilles √† cocher (data-tm-index)
          if (indexStr !== null) {
            const usedClass = "tm-used";
            const alreadyUsed = tmBtn.classList.contains(usedClass);

            if (alreadyUsed) {
              // On "rend" ce temps mort
              val = Math.max(0, val - 1);
              tmBtn.classList.remove(usedClass);
            } else {
              if (val < 2) {
                val = val + 1;
                tmBtn.classList.add(usedClass);
              }
            }

            s[key] = val;
            saveSetScores();
            renderTimeouts();
            return;
          }

          // Ancien mode +/- (au cas o√π tu remets des boutons plus tard)
          if (dir) {
            const delta = dir === "plus" ? 1 : -1;
            val = val + delta;

            if (val < 0) val = 0;
            if (val > 2) val = 2;

            s[key] = val;
            saveSetScores();
            renderTimeouts();
          }
          return;
        }

      });
    }


    /* --------- stats adversaires ---------- */
   function renderOpponentStats() {
  const s = getOpponentSetStats(currentSet);

  // S√©lecteur du label de set adversaire (si pr√©sent)
  const setLabel = document.getElementById("opponent-set-label");
  if (setLabel) {
    setLabel.textContent = "(set " + currentSet + ")";
  }

  // Mise √† jour des valeurs + / - dans la liste
  document.querySelectorAll("#opponent-stats-list .stat-row").forEach(row => {
    const cat = row.dataset.ocat;
    const minusSpan = row.querySelector(".opp-value-minus");
    const plusSpan  = row.querySelector(".opp-value-plus");

    if (minusSpan) {
      minusSpan.textContent = s[cat + "Minus"] || 0;
    }
    if (plusSpan) {
      plusSpan.textContent  = s[cat + "Plus"]  || 0;
    }
  });
}


    function initOpponentControls() {
      const container = document.getElementById("opponent-stats-list");
      if (!container) return;
      container.addEventListener("click", function(e) {
        const btn = e.target.closest("button[data-type]");
        const valueSpan = e.target.closest(".opp-value-minus, .opp-value-plus");
        const s = getOpponentSetStats(currentSet);

        if (btn) {
          const type = btn.dataset.type;
          const row = btn.closest(".stat-row");
          const cat = row.dataset.ocat;
          const key = cat + (type === "plus" ? "Plus" : "Minus");
          s[key] = (s[key] || 0) + 1;
          saveOpponentStats();
          renderOpponentStats();
          renderDashboard();
          return;
        }

        if (valueSpan) {
          const row = valueSpan.closest(".stat-row");
          const cat = row.dataset.ocat;
          const isPlus = valueSpan.classList.contains("opp-value-plus");
          const key = cat + (isPlus ? "Plus" : "Minus");
          const current = s[key] || 0;
          const labelRow = row.querySelector(".stat-label").textContent.trim();
          const typeLabel = (cat === "cadeaux")
            ? "points"
            : (isPlus ? "points pour eux" : "points pour nous");
          const input = prompt("Corriger " + labelRow + " (" + typeLabel + ", set " + currentSet + ")", current);
          if (input === null) return;
          const val = parseInt(input, 10);
          if (!Number.isNaN(val) && val >= 0) {
            s[key] = val;
            saveOpponentStats();
            renderOpponentStats();
            renderDashboard();
          }
        }
      });
    }

    
    /* --------- Point adverse : panneau rapide (niveau 1 + niveau 2) ---------- */
    function renderOpponentPointPanel() {
      const panel = document.getElementById("opp-point-panel");
      if (!panel) return;

      const teamEl = document.getElementById("opppt-team");
      const valEl  = document.getElementById("opppt-score-val");
      const s = getSetScore(currentSet);

      if (teamEl) teamEl.textContent = (teamNames && teamNames.opp) ? (teamNames.opp || "Adversaire") : "Adversaire";
      if (valEl)  valEl.textContent  = String(s.eux || 0);
    }

    function incOpponentTaggedPoint(tag) {
      // 1) Score match
      addPoint("eux", { kind: "oppPoint", level: 2, tag: tag || "autre" });

      // 2) Stats adverses (si dispo : servicePlus / blocPlus / pointsPlus)
      const st = getOpponentSetStats(currentSet);
      let cat = "points";
      if (tag === "service") cat = "service";
      if (tag === "bloc") cat = "bloc";

      const keyPlus = cat + "Plus";
      st[keyPlus] = (st[keyPlus] || 0) + 1;
      saveOpponentStats();
      renderOpponentStats();

      // UI
      renderOpponentPointPanel();
      renderOpponentFaultPanel();
      renderDashboard();
    }

    /* --------- Fautes adverses directes : panneau rapide (point pour nous) ---------- */
    function renderOpponentFaultPanel() {
      const panel = document.getElementById("opp-fault-panel");
      if (!panel) return;

      const teamEl = document.getElementById("oppft-team");
      const valEl  = document.getElementById("oppft-score-val");
      const s = getSetScore(currentSet);

      if (teamEl) teamEl.textContent = (teamNames && teamNames.us) ? (teamNames.us || "Nous") : "Nous";
      if (valEl)  valEl.textContent  = String(s.nous || 0);

      const st = getOpponentSetStats(currentSet);
      const map = {
        service: st.errService || 0,
        attaque: st.errAttaque || 0,
        bloc: st.errBloc || 0,
        autre: st.errAutre || 0
      };
      panel.querySelectorAll("[data-oppft-count]").forEach(el => {
        const k = el.getAttribute("data-oppft-count");
        el.textContent = String(map[k] ?? 0);
      });
    }

    function incOpponentDirectFault(tag) {
      const t = (tag || "autre");

      // 1) Score match (point pour nous) + rotation/serve auto si besoin
      addPoint("nous", { kind: "oppFault", level: 2, tag: t });

      // 2) Stats adverses : d√©tail + total
      const st = getOpponentSetStats(currentSet);

      if (t === "service") {
        st.errService = (st.errService || 0) + 1;
        // On note aussi la faute au service dans "Services : fautes"
        st.serviceMinus = (st.serviceMinus || 0) + 1;
      } else if (t === "attaque") {
        st.errAttaque = (st.errAttaque || 0) + 1;
        st.cadeauxPlus = (st.cadeauxPlus || 0) + 1;
      } else if (t === "bloc") {
        st.errBloc = (st.errBloc || 0) + 1;
        st.cadeauxPlus = (st.cadeauxPlus || 0) + 1;
      } else {
        st.errAutre = (st.errAutre || 0) + 1;
        st.cadeauxPlus = (st.cadeauxPlus || 0) + 1;
      }

      saveOpponentStats();
      renderOpponentStats();
      renderOpponentFaultPanel();
      renderDashboard();
    }

    function initOpponentFaultPanel() {
      const panel = document.getElementById("opp-fault-panel");
      if (!panel) return;

      panel.addEventListener("click", function(e) {
        const btn = e.target.closest("[data-oppft]");
        const tagBtn = e.target.closest("[data-oppft-tag]");
        if (!btn && !tagBtn) return;

        // Score neutre pour nous (+ / -) ‚Äî correction rapide
        if (btn) {
          const kind = btn.dataset.oppft;

          if (kind === "plus") {
            addPoint("nous", { kind: "oppFault", level: 1, tag: "neutre" });
            renderOpponentFaultPanel();
            return;
          }

          if (kind === "minus") {
            // Correction simple (sans rollback complet du service/rotation)
            const s = getSetScore(currentSet);
            s.nous = Math.max(0, (s.nous || 0) - 1);
            saveSetScores();
            renderSetScore();
            renderOpponentFaultPanel();
            renderDashboard();
            return;
          }
        }

        // Tag de la faute adverse => point pour nous + d√©tail
        if (tagBtn) {
          incOpponentDirectFault(tagBtn.dataset.oppftTag);
        }
      });

      renderOpponentFaultPanel();
    }



    function initOpponentPointPanel() {
      const panel = document.getElementById("opp-point-panel");
      if (!panel) return;

      panel.addEventListener("click", function(e) {
        const btn = e.target.closest("[data-opppt]");
        const tagBtn = e.target.closest("[data-opppt-tag]");
        if (!btn && !tagBtn) return;

        // Niveau 1 : score neutre adverse (+ / -)
        if (btn) {
          const kind = btn.dataset.opppt;

          if (kind === "plus") {
            addPoint("eux", { kind: "oppPoint", level: 1, tag: "neutre" });
            // (niveau 1 : volontairement pas de stat adverse associ√©e)
            renderOpponentPointPanel();
      renderOpponentFaultPanel();
            return;
          }

          if (kind === "minus") {
            // Correction simple (sans rollback complet du service/rotation)
            const s = getSetScore(currentSet);
            s.eux = Math.max(0, (s.eux || 0) - 1);
            saveSetScores();
            renderSetScore();
            renderOpponentPointPanel();
      renderOpponentFaultPanel();
            renderDashboard();
            return;
          }
        }

        // Niveau 2 : point adverse tagg√©
        if (tagBtn) {
          incOpponentTaggedPoint(tagBtn.dataset.oppptTag);
        }
      });

      // premier render
      renderOpponentPointPanel();
      renderOpponentFaultPanel();
    }


function initOpponentPanelsToggle() {
  const btn = document.getElementById("btn-toggle-opp-panels");
  const wrap = document.getElementById("opp-panels-wrap");
  if (!btn || !wrap) return;

  const KEY = "s2m_pro6x6_opp_panels_collapsed";
  let collapsed = localStorage.getItem(KEY);
  // par d√©faut: pli√© pour ne pas surcharger l'√©cran match
  if (collapsed === null) collapsed = "1";

  function apply() {
    const isCollapsed = collapsed === "1";
    wrap.classList.toggle("is-collapsed", isCollapsed);
    wrap.setAttribute("aria-hidden", isCollapsed ? "true" : "false");
    btn.setAttribute("aria-expanded", isCollapsed ? "false" : "true");
    btn.textContent = isCollapsed ? "‚ö° D√©tails" : "‚ö° Masquer";
    btn.classList.toggle("is-open", !isCollapsed);
  }

  apply();

  btn.addEventListener("click", () => {
    collapsed = (collapsed === "1") ? "0" : "1";
    localStorage.setItem(KEY, collapsed);
    apply();
  });
}




    /* --------- vue stats joueur¬∑euse ---------- */
    function openPlayerStats(playerId) {
      const p = players.find(x => x.id === playerId);
      if (!p) return;
      // Si la joueuse n'a aucune stat, on bascule sur la premi√®re joueuse qui en a
      try{
        if(!_playerHasAnyStats(playerId)){
          const list = _playersWithStats();
          if(list.length){ playerId = list[0].id; }
        }
      }catch(e){}
      currentStatsPlayerId = playerId;
      const p2 = players.find(x => x.id === currentStatsPlayerId);
      document.getElementById("stats-player-title").textContent =
        "Statistiques : " + (p2 && p2.number ? "#" + p2.number + " " : "") + (p2 && p2.name ? p2.name : "");

      updateSetButtons();
      try{ _initStatsPlayerNav(); _syncStatsPlayerSelect(); }catch(e){}
      renderStatsForCurrent();
      try{ _syncStatsPlayerSelect(); }catch(e){}

      document.getElementById("main-view").style.display = "none";
      document.getElementById("stats-container").style.display = "block";
    }

    
    /* --- Stats: ne naviguer que parmi les joueuses avec stats --- */
    function _playerHasAnyStats(pid){
      try{
        const all = stats && stats[pid];
        if(!all) return false;
        for(let set=1; set<=5; set++){
          const s = all[set];
          if(!s) continue;
          for(const cat of STAT_CATEGORIES){
            const keys = [cat+"Plus", cat+"Minus", cat+"Point", cat+"Fault"];
            for(const k of keys){
              if((s[k]||0) !== 0) return true;
            }
          }
        }
      }catch(e){}
      return false;
    }

    function _playersWithStats(){
      try{
        return (players||[]).filter(p => _playerHasAnyStats(p.id));
      }catch(e){ return []; }
    }

    function _formatPlayerLabel(p){
      if(!p) return "";
      const num = p.number ? "#" + p.number + " " : "";
      return (num + (p.name||"")).trim();
    }

    function _syncStatsPlayerSelect(){
      const sel = document.getElementById("stats-player-select");
      const wrap = document.getElementById("stats-player-nav");
      if(!sel || !wrap) return;

      const list = _playersWithStats();
      // Si aucune stat, on cache la nav (et on garde la fiche visible)
      if(list.length === 0){
        wrap.style.display = "none";
        return;
      }
      wrap.style.display = "flex";

      // Remplit le select si besoin
      const wanted = list.map(p => String(p.id)).join("|");
      if(sel.dataset._wanted !== wanted){
        sel.innerHTML = "";
        list.forEach(p => {
          const opt = document.createElement("option");
          opt.value = String(p.id);
          opt.textContent = _formatPlayerLabel(p);
          sel.appendChild(opt);
        });
        sel.dataset._wanted = wanted;
      }

      // Positionne la valeur courante (si possible)
      if(currentStatsPlayerId && list.some(p => p.id === currentStatsPlayerId)){
        sel.value = String(currentStatsPlayerId);
      }else{
        // Si on ouvre une joueuse sans stats, on bascule sur la premi√®re dispo
        currentStatsPlayerId = list[0].id;
        sel.value = String(currentStatsPlayerId);
      }

      // Active/d√©sactive prev/next
      const btnPrev = document.getElementById("btn-stats-prev");
      const btnNext = document.getElementById("btn-stats-next");
      if(btnPrev) btnPrev.disabled = (list.length < 2);
      if(btnNext) btnNext.disabled = (list.length < 2);
    }

    function _gotoStatsOffset(delta){
      const list = _playersWithStats();
      if(list.length === 0) return;
      const ids = list.map(p=>p.id);
      let idx = ids.indexOf(currentStatsPlayerId);
      if(idx < 0) idx = 0;
      idx = (idx + delta + ids.length) % ids.length;
      openPlayerStats(ids[idx]);
    }

    function _initStatsPlayerNav(){
      const sel = document.getElementById("stats-player-select");
      const btnPrev = document.getElementById("btn-stats-prev");
      const btnNext = document.getElementById("btn-stats-next");
      if(btnPrev && !btnPrev.dataset.bound){
        btnPrev.addEventListener("click", ()=>_gotoStatsOffset(-1));
        btnPrev.dataset.bound = "1";
      }
      if(btnNext && !btnNext.dataset.bound){
        btnNext.addEventListener("click", ()=>_gotoStatsOffset(1));
        btnNext.dataset.bound = "1";
      }
      if(sel && !sel.dataset.bound){
        sel.addEventListener("change", ()=>{
          const pid = sel.value;
          if(pid) openPlayerStats(pid);
        });
        sel.dataset.bound = "1";
      }
    }

function buildPlayerReportText(playerId) {
  const p = (players || []).find(x => x && x.id === playerId) || {};
  const who = ((p.number ? ("#" + p.number + " ") : "") + (p.name || "Joueur¬∑euse")).trim();

  const usName  = (typeof getOurTeamName === "function" ? getOurTeamName() : (document.getElementById("team-name-input")?.value || "Nous"));
  const oppName = (typeof getOppTeamName === "function" ? getOppTeamName() : (document.getElementById("opponent-name-input")?.value || "Adversaire"));

  const setNum = (typeof currentSet !== "undefined" && currentSet) ? currentSet : 1;
  const sc = (typeof getSetScore === "function") ? getSetScore(setNum) : {nous:0,eux:0};
  const scoreLine = `${usName} ${sc.nous || 0} ‚Äî ${sc.eux || 0} ${oppName}`;

  const safeN = (v)=> Number.isFinite(+v) ? (+v) : 0;
  const pct = (n,d)=> d ? Math.round((n/d)*100) : 0;

  const statsAllSets = (stats && stats[playerId]) ? stats[playerId] : {};
  const setStats = statsAllSets[setNum] || {};

  // Accumulate set + match
  const acc = (source)=>{
    const a = {};
    (STAT_CATEGORIES || []).forEach(cat=>{
      a[cat] = {
        plus:  safeN(source[cat+"Plus"]),
        minus: safeN(source[cat+"Minus"]),
        point: safeN(source[cat+"Point"]),
        fault: safeN(source[cat+"Fault"])
      };
    });
    return a;
  };
  const setAcc = acc(setStats);

  const matchAcc = {};
  (STAT_CATEGORIES || []).forEach(cat=> matchAcc[cat] = {plus:0,minus:0,point:0,fault:0});
  for(let s=1;s<=5;s++){
    const ss = statsAllSets[s];
    if(!ss) continue;
    (STAT_CATEGORIES || []).forEach(cat=>{
      matchAcc[cat].plus  += safeN(ss[cat+"Plus"]);
      matchAcc[cat].minus += safeN(ss[cat+"Minus"]);
      matchAcc[cat].point += safeN(ss[cat+"Point"]);
      matchAcc[cat].fault += safeN(ss[cat+"Fault"]);
    });
  }

  const sumAcc = (A)=>{
    const tot = {plus:0,minus:0,point:0,fault:0,att:0,delta:0,impact:0};
    (STAT_CATEGORIES || []).forEach(cat=>{
      const v=A[cat]||{plus:0,minus:0,point:0,fault:0};
      tot.plus += safeN(v.plus);  tot.minus += safeN(v.minus);
      tot.point += safeN(v.point); tot.fault += safeN(v.fault);
    });
    tot.att = tot.plus + tot.minus;
    tot.delta = tot.plus - tot.minus;
    tot.impact = tot.point - tot.fault; // P-F + points/fautes directes
    return tot;
  };
  const setTot = sumAcc(setAcc);
  const matchTot = sumAcc(matchAcc);

  // Team aggregates (only players with stats)
  const teamAcc = (scopeSet)=>{
    const t = {};
    (STAT_CATEGORIES||[]).forEach(cat=> t[cat] = {plus:0,minus:0,point:0,fault:0});
    (players||[]).forEach(pl=>{
      if(!pl || !pl.id) return;
      const all = stats?.[pl.id] || {};
      const src = scopeSet ? (all[setNum] || null) : all;
      if(scopeSet){
        const ss = src; if(!ss) return;
        (STAT_CATEGORIES||[]).forEach(cat=>{
          t[cat].plus  += safeN(ss[cat+"Plus"]);
          t[cat].minus += safeN(ss[cat+"Minus"]);
          t[cat].point += safeN(ss[cat+"Point"]);
          t[cat].fault += safeN(ss[cat+"Fault"]);
        });
      } else {
        for(let s=1;s<=5;s++){
          const ss = all[s]; if(!ss) continue;
          (STAT_CATEGORIES||[]).forEach(cat=>{
            t[cat].plus  += safeN(ss[cat+"Plus"]);
            t[cat].minus += safeN(ss[cat+"Minus"]);
            t[cat].point += safeN(ss[cat+"Point"]);
            t[cat].fault += safeN(ss[cat+"Fault"]);
          });
        }
      }
    });
    return sumAcc(t);
  };
  const teamSetTot = teamAcc(true);
  const teamMatchTot = teamAcc(false);

  // Top strengths / leaks (set)
  const catName = (c)=> (typeof prettyCatName==="function" ? prettyCatName(c) : (c||""));
  let bestConv = {cat:null,v:-1}, bestEff={cat:null,v:-1}, worstF={cat:null,v:-1};
  (STAT_CATEGORIES||[]).forEach(cat=>{
    const v=setAcc[cat]||{plus:0,minus:0,point:0,fault:0};
    const a=(safeN(v.plus)+safeN(v.minus));
    const eff=a? pct(v.plus,a) : -1;
    const conv=a? pct(v.point,a) : -1;
    const fr=a? pct(v.fault,a) : -1;
    if(conv>bestConv.v) bestConv={cat,v:conv};
    if(eff>bestEff.v) bestEff={cat,v:eff};
    if(fr>worstF.v) worstF={cat,v:fr};
  });

  const lines = [];
  lines.push(`üìä ${who}`);
  lines.push(`Set ${setNum} ‚Äî ${scoreLine}`);
  lines.push("");

  // Set summary
  lines.push("üß≠ Lecture rapide (set)");
  lines.push(`‚Ä¢ Impact (P/F) : ${setTot.point} points ‚Ä¢ ${setTot.fault} fautes ‚Üí Œî ${setTot.impact}`);
  lines.push(`‚Ä¢ Bilan +/- : +${setTot.plus} / -${setTot.minus} ‚Üí Œî ${setTot.delta}`);
  lines.push(`‚Ä¢ Taux : efficacit√© ${pct(setTot.plus,setTot.att)}% ‚Ä¢ conversion ${pct(setTot.point,setTot.att)}% ‚Ä¢ fautes/tentatives ${pct(setTot.fault,setTot.att)}%`);
  lines.push(`‚Ä¢ Contrib. au score : ${pct(setTot.point, sc.nous||0)}% des points marqu√©s ‚Ä¢ ${pct(setTot.fault, sc.eux||0)}% des points conc√©d√©s`);
  lines.push("");

  // Comparison vs team (set)
  lines.push("‚öñÔ∏è Par rapport √† l‚Äô√©quipe (set)");
  const dEff = pct(setTot.plus,setTot.att) - pct(teamSetTot.plus,teamSetTot.att);
  const dConv = pct(setTot.point,setTot.att) - pct(teamSetTot.point,teamSetTot.att);
  const dF = pct(setTot.fault,setTot.att) - pct(teamSetTot.fault,teamSetTot.att);
  lines.push(`‚Ä¢ Efficacit√© : ${pct(setTot.plus,setTot.att)}% (${dEff>=0?"+":""}${dEff} vs √©quipe)`);
  lines.push(`‚Ä¢ Conversion : ${pct(setTot.point,setTot.att)}% (${dConv>=0?"+":""}${dConv} vs √©quipe)`);
  lines.push(`‚Ä¢ Fautes/T : ${pct(setTot.fault,setTot.att)}% (${dF>=0?"+":""}${dF} vs √©quipe)`);
  lines.push("");

  // Highlights
  lines.push("‚úÖ Points d‚Äôappui (set)");
  if(bestConv.cat) lines.push(`‚Ä¢ Meilleure conversion : ${catName(bestConv.cat)} (${bestConv.v}%)`);
  if(bestEff.cat) lines.push(`‚Ä¢ Meilleure efficacit√© : ${catName(bestEff.cat)} (${bestEff.v}%)`);
  if(setTot.point===0 && setTot.att===0) lines.push("‚Ä¢ Aucune tentative enregistr√©e : pense √† saisir les actions pour rendre le diagnostic fiable.");
  lines.push("");

  lines.push("‚ö†Ô∏è Axe prioritaire (set)");
  if(worstF.cat && worstF.v>0) lines.push(`‚Ä¢ Robinet de fautes : ${catName(worstF.cat)} (${worstF.v}% de fautes sur ses tentatives)`);
  else lines.push("‚Ä¢ Pas de ‚Äúrobinet‚Äù net sur ce set ‚Äî garde l‚Äôaccent sur la r√©gularit√©.");
  lines.push("");

  // Match summary (context)
  let matchUs=0, matchOpp=0;
  for(let i=1;i<=5;i++){
    const scc = (typeof getSetScore === "function") ? getSetScore(i) : {nous:0,eux:0};
    matchUs += (scc.nous||0); matchOpp += (scc.eux||0);
  }

  lines.push("üèÅ Contexte match");
  lines.push(`‚Ä¢ Impact (match) : ${matchTot.point} points ‚Ä¢ ${matchTot.fault} fautes ‚Üí Œî ${matchTot.impact}`);
  lines.push(`‚Ä¢ Contrib. match : ${pct(matchTot.point, matchUs)}% des points marqu√©s ‚Ä¢ ${pct(matchTot.fault, matchOpp)}% des points conc√©d√©s`);
  lines.push(`‚Ä¢ Taux (match) : efficacit√© ${pct(matchTot.plus,matchTot.att)}% ‚Ä¢ conversion ${pct(matchTot.point,matchTot.att)}% ‚Ä¢ fautes/tentatives ${pct(matchTot.fault,matchTot.att)}%`);
  lines.push("");

  // Footer
  lines.push("‚Äî");
  lines.push("Stat2Match 6x6 PRO ¬∑ Rapport individuel");

  return lines.join("\n");
}

// Lecture intelligente (storytelling) ‚Äî m√™me logique que la 4x4 Pro
function renderPlayerSmartRead(playerId){
  const host = document.getElementById("player-smart-read-body");
  if(!host) return;

  const p = (players || []).find(x => x.id === playerId);
  if(!p){ host.innerHTML = ""; return; }

  // --- helpers (safe) ---
  function esc(s){ return (typeof escapeHTML === "function") ? escapeHTML(String(s ?? "")) : String(s ?? ""); }
  function catName(cat){
    const map = {attaque:"Attaque", service:"Service", bloc:"Bloc", reception:"R√©ception", defense:"D√©fense", passe:"Passe", relance:"Relance"};
    return map[cat] || cat;
  }
  function sumAccFromSetStats(st){
    const acc = {};
    STAT_CATEGORIES.forEach(cat=>{
      acc[cat] = {
        plus:  (st?.[cat+"Plus"]  || 0),
        minus: (st?.[cat+"Minus"] || 0),
        point: (st?.[cat+"Point"] || 0),
        fault: (st?.[cat+"Fault"] || 0),
      };
    });
    return acc;
  }
  function totalsFromAcc(acc){
    let plus=0, minus=0, point=0, fault=0;
    STAT_CATEGORIES.forEach(cat=>{
      const v = acc[cat] || {};
      plus  += (v.plus  || 0);
      minus += (v.minus || 0);
      point += (v.point || 0);
      fault += (v.fault || 0);
    });
    const attempts = plus + minus;
    return {plus, minus, attempts, point, fault, net: point - fault};
  }
  function pct(n,d){
    if(!d) return 0;
    return Math.round((n/d)*100);
  }
  function fmtPct(n){ return `${Math.max(0, Math.min(100, Math.round(n || 0)))}%`; }

  // --- build per set + match accumulators ---
  const setStatsRaw = getPlayerSetStats(playerId, currentSet) || {};
  const setAcc = sumAccFromSetStats(setStatsRaw);

  const played = _playedSetsList();
  const matchAcc = {};
  STAT_CATEGORIES.forEach(cat => matchAcc[cat] = {plus:0, minus:0, point:0, fault:0});
  (played || []).forEach(s=>{
    const st = getPlayerSetStats(playerId, s) || {};
    STAT_CATEGORIES.forEach(cat=>{
      matchAcc[cat].plus  += (st[cat+"Plus"]  || 0);
      matchAcc[cat].minus += (st[cat+"Minus"] || 0);
      matchAcc[cat].point += (st[cat+"Point"] || 0);
      matchAcc[cat].fault += (st[cat+"Fault"] || 0);
    });
  });

  const setTot   = totalsFromAcc(setAcc);
  const matchTot = totalsFromAcc(matchAcc);

  // team context (same scope)
  const teamSet   = (typeof _computeTeamTotalsForSets === "function") ? _computeTeamTotalsForSets([currentSet]) : null;
  const teamMatch = (typeof _computeTeamTotalsForSets === "function") ? _computeTeamTotalsForSets(played) : null;

  // opponent context
  const oppMatch = (typeof _computeOpponentTotalsForSets === "function") ? _computeOpponentTotalsForSets(played) : null;

  // choose a meaningful scope for narrative
  const scopeLabel = (currentSet ? `Set ${currentSet}` : "Set");
  const hasAny = (setTot.attempts + setTot.point + setTot.fault) > 0 || (matchTot.attempts + matchTot.point + matchTot.fault) > 0;
  if(!hasAny){
    host.innerHTML = `
      <div class="pro-read">
        <div class="pro-read-title">Lecture intelligente</div>
        <p class="pro-read-lead">Aucune action n‚Äôa encore √©t√© saisie pour ${esc(p.name)}. D√®s que tu ajoutes des <strong>+</strong>, <strong>‚àí</strong>, <strong>P</strong> ou <strong>F</strong>, Stat2Match te g√©n√®re une lecture ‚Äúcoach‚Äù claire et fiable.</p>
      </div>`;
    return;
  }

  // find key levers / risks (set scope first, else match)
  function bestWorstFromAcc(acc){
    let best = {cat:null, net:-9999, eff:0, t:0};
    let worst= {cat:null, net: 9999, eff:0, t:0};
    let mostFault = {cat:null, v:0};
    let mostPoint = {cat:null, v:0};
    STAT_CATEGORIES.forEach(cat=>{
      const v = acc[cat] || {plus:0,minus:0,point:0,fault:0};
      const t = (v.plus||0)+(v.minus||0);
      const net = (v.point||0)-(v.fault||0);
      const eff = t ? pct((v.plus||0), t) : 0;
      if((v.point||0) > mostPoint.v) mostPoint = {cat, v:(v.point||0)};
      if((v.fault||0) > mostFault.v) mostFault = {cat, v:(v.fault||0)};
      if(t >= 3){ // PRO threshold to avoid noise
        if(net > best.net) best = {cat, net, eff, t};
        if(net < worst.net) worst = {cat, net, eff, t};
      }
    });
    return {best, worst, mostFault, mostPoint};
  }

  const sigSet   = bestWorstFromAcc(setAcc);
  const sigMatch = bestWorstFromAcc(matchAcc);

  function buildNarrative(label, tot, sig, teamCtx){
    const eff = tot.attempts ? pct(tot.plus, tot.attempts) : 0;
    const transfo = tot.attempts ? pct(tot.point, tot.attempts) : 0;
    const fRate = tot.attempts ? pct(tot.fault, tot.attempts) : 0;

    const shareP = teamCtx?.totalPoint ? pct(tot.point, teamCtx.totalPoint) : null;
    const shareF = teamCtx?.totalFault ? pct(tot.fault, teamCtx.totalFault) : null;

    // headline
    let head = "";
    if(tot.net >= 3) head = `Impact positif : tu fais gagner plus de points que tu n‚Äôen conc√®des.`;
    else if(tot.net <= -3) head = `Impact n√©gatif : tu conc√®des trop de points par rapport √† ce que tu apportes.`;
    else head = `Impact √©quilibr√© : ta contribution est proche de l‚Äô√©quilibre.`;

    // lever / leak
    const lever = (sig.best?.cat && sig.best.net > 0) ? `${catName(sig.best.cat)} (net +${sig.best.net}, efficacit√© ${sig.best.eff}%)` : null;
    const leak  = (sig.worst?.cat && sig.worst.net < 0) ? `${catName(sig.worst.cat)} (net ${sig.worst.net}, efficacit√© ${sig.worst.eff}%)` : null;

    const mostFaultTxt = (sig.mostFault?.cat && sig.mostFault.v>0) ? `${sig.mostFault.v} faute${sig.mostFault.v>1?"s":""} sur ${catName(sig.mostFault.cat)}` : null;
    const mostPointTxt = (sig.mostPoint?.cat && sig.mostPoint.v>0) ? `${sig.mostPoint.v} point${sig.mostPoint.v>1?"s":""} via ${catName(sig.mostPoint.cat)}` : null;

    // priority (PRO, actionable)
    let priority = "";
    if(tot.fault >= 3 && fRate >= 18) priority = `Priorit√© : r√©duire les fautes (objectif : ‚àí2 fautes) ‚Äî tu changes directement la dynamique.`;
    else if(tot.attempts >= 6 && transfo < 25) priority = `Priorit√© : augmenter la transformation (P). Tu fais les bonnes choses, mais tu ne ‚Äúconvertis‚Äù pas assez.`;
    else if(tot.attempts >= 6 && eff < 55) priority = `Priorit√© : s√©curiser la qualit√© d‚Äôex√©cution (+/‚àí). Une meilleure efficacit√© te donne plus de ballons jouables.`;
    else priority = `Priorit√© : consolider ton meilleur levier, sans ajouter de fautes.`;

    // team context sentence
    let teamLine = "";
    if(shareP !== null || shareF !== null){
      const pPart = (shareP !== null) ? `‚âà ${shareP}% des points (P) de l‚Äô√©quipe` : "";
      const fPart = (shareF !== null) ? `‚âà ${shareF}% des points conc√©d√©s (F)` : "";
      const join = (pPart && fPart) ? " et " : "";
      teamLine = `√Ä l‚Äô√©chelle de l‚Äô√©quipe, tu repr√©sentes ${pPart}${join}${fPart}.`;
    }

    // render
    return `
      <div class="pro-read-block">
        <div class="pro-read-subtitle">${esc(label)}</div>

        <p class="pro-read-lead">${esc(head)}</p>

        <div class="pro-kpi-row">
          <span class="pro-pill">Tentatives : <strong>${tot.attempts}</strong></span>
          <span class="pro-pill">Efficacit√© : <strong>${fmtPct(eff)}</strong></span>
          <span class="pro-pill">Transformation : <strong>${fmtPct(transfo)}</strong></span>
          <span class="pro-pill">Fautes/T : <strong>${fmtPct(fRate)}</strong></span>
          <span class="pro-pill">Impact net (P‚àíF) : <strong>${tot.net}</strong></span>
        </div>

        <div class="pro-read-grid">
          <div class="pro-card good">
            <div class="pro-card-title">‚úÖ Ce qui marche</div>
            <p>${esc(mostPointTxt ? `Ton apport le plus ‚Äúdirect‚Äù : ${mostPointTxt}.` : `Ton jeu apporte de la valeur d√®s que tu multiplies les tentatives.`)}</p>
            <p class="muted">${esc(lever ? `Ton meilleur levier actuel : ${lever}.` : `Continue de saisir : ton meilleur levier sera identifi√© d√®s que le volume d‚Äôactions est suffisant.`)}</p>
          </div>

          <div class="pro-card bad">
            <div class="pro-card-title">‚ö†Ô∏è Ce qui co√ªte</div>
            <p>${esc(mostFaultTxt ? `Le robinet de points conc√©d√©s : ${mostFaultTxt}.` : `Peu de fautes directes sur cette s√©quence.`)}</p>
            <p class="muted">${esc(leak ? `Secteur √† s√©curiser en priorit√© : ${leak}.` : `Aucun secteur tr√®s n√©gatif d√©tect√© (volume suffisant requis).`)}</p>
          </div>

          <div class="pro-card prio">
            <div class="pro-card-title">üéØ Priorit√© coach</div>
            <p>${esc(priority)}</p>
            <p class="muted">${esc(teamLine || "Objectif : √™tre d√©cisif¬∑ve sans ‚Äúoffrir‚Äù de points √† l‚Äôadversaire.")}</p>
          </div>
        </div>
      </div>
    `;
  }

  // Build full read with 2 sections: Set + Match
  const html = `
    <div class="pro-read">
      <div class="pro-read-title">Lecture intelligente (PRO)</div>
      <div class="pro-read-note">Lecture bas√©e sur les <strong>+</strong>, <strong>‚àí</strong>, <strong>P</strong> et <strong>F</strong>. Les comparaisons ‚ÄúPRO‚Äù n‚Äôapparaissent que si le volume est suffisant (‚â• 3 tentatives par secteur).</div>
      ${buildNarrative(scopeLabel, setTot, sigSet, teamSet)}
      <div class="pro-sep"></div>
      ${buildNarrative(`Match (sets jou√©s : ${(played||[]).length})`, matchTot, sigMatch, teamMatch)}
      ${oppMatch ? `
        <div class="pro-read-block">
          <div class="pro-read-subtitle">Lecture face √† l‚Äôadversaire</div>
          <p class="pro-read-lead">
            L‚Äôadversaire nous a donn√© <strong>${oppMatch.cadeaux || 0}</strong> point${(oppMatch.cadeaux||0)>1?"s":""} ‚Äúgratuits‚Äù (cadeaux).
            En parall√®le, tes fautes directes sur le match sont √† <strong>${matchTot.fault}</strong>.
          </p>
          <p class="muted">
            Id√©e simple : si tes fautes passent sous la barre des ‚Äúcadeaux‚Äù, tu aides l‚Äô√©quipe √† reprendre le contr√¥le du match.
          </p>
        </div>` : ``}
    </div>
  `;

  host.innerHTML = html;
}
function renderPlayerDiagnostics(playerId){
  const host = document.getElementById("player-diagnostics");
  if(!host) return;

  // Safe helpers
  const safeN = (v)=> (Number.isFinite(+v) ? +v : 0);
  const pct = (n,d)=> (d>0 ? Math.round((n/d)*100) : 0);
  const clamp = (x,min,max)=> Math.max(min, Math.min(max,x));

  // Category labels (no surprises)
  const catName = (cat)=>{
    const map = {
      attaque:"Attaque",
      service:"Service",
      reception:"R√©ception",
      passe:"Passe",
      defense:"D√©fense",
      bloc:"Bloc",
      relance:"Relance"
    };
    return map[cat] || (cat ? (cat.charAt(0).toUpperCase()+cat.slice(1)) : "‚Äî");
  };

  // Read stats buckets
  const statsAllSets = stats[playerId] || {};
  const setStats = statsAllSets[currentSet] || {};

  // Aggregate one bucket (set or match)
  function buildAcc(source){
    const acc = {};
    STAT_CATEGORIES.forEach(cat=>{
      acc[cat] = {
        plus:  safeN(source[cat+"Plus"]),
        minus: safeN(source[cat+"Minus"]),
        point: safeN(source[cat+"Point"]),
        fault: safeN(source[cat+"Fault"])
      };
    });
    return acc;
  }
  const setAcc = buildAcc(setStats);

  // Build match accumulator from sets 1..5
  const matchAcc = {};
  STAT_CATEGORIES.forEach(cat=>{
    matchAcc[cat] = {plus:0,minus:0,point:0,fault:0};
  });
  for(let s=1;s<=5;s++){
    const ss = statsAllSets[s];
    if(!ss) continue;
    STAT_CATEGORIES.forEach(cat=>{
      matchAcc[cat].plus  += safeN(ss[cat+"Plus"]);
      matchAcc[cat].minus += safeN(ss[cat+"Minus"]);
      matchAcc[cat].point += safeN(ss[cat+"Point"]);
      matchAcc[cat].fault += safeN(ss[cat+"Fault"]);
    });
  }

  function totals(acc){
    return STAT_CATEGORIES.reduce((o,cat)=>{
      const v = acc[cat] || {};
      o.plus  += safeN(v.plus);
      o.minus += safeN(v.minus);
      o.point += safeN(v.point);
      o.fault += safeN(v.fault);
      return o;
    }, {plus:0,minus:0,point:0,fault:0});
  }

  function badgeClassEff(eff){
    // PRO thresholds (stricter)
    if(eff >= 70) return "good";
    if(eff >= 55) return "info";
    if(eff >= 40) return "warn";
    return "bad";
  }
  function badgeClassErr(er){
    // PRO thresholds (stricter)
    if(er <= 8) return "good";
    if(er <= 12) return "info";
    if(er <= 18) return "warn";
    return "bad";
  }
  function badgeClassConv(cv){
    // Conversion (P/T) in PRO mode
    if(cv >= 50) return "good";
    if(cv >= 35) return "info";
    if(cv >= 25) return "warn";
    return "bad";
  }

  function tableHTML(acc){
    // find best conversion and worst error rate among categories with volume
    let bestConv={cat:null,v:-1}, worstErr={cat:null,v:-1}, bestEff={cat:null,v:-1};
    STAT_CATEGORIES.forEach(cat=>{
      const v=acc[cat]; const att = safeN(v.plus)+safeN(v.minus);
      if(att<=0) return;
      const conv = pct(safeN(v.point), att);
      const err  = pct(safeN(v.fault), att);
      const eff  = pct(safeN(v.plus), att);
      if(conv>bestConv.v) bestConv={cat,v:conv};
      if(err>worstErr.v) worstErr={cat,v:err};
      if(eff>bestEff.v) bestEff={cat,v:eff};
    });

    let rows = "";
    STAT_CATEGORIES.forEach(cat=>{
      const v=acc[cat]; const plus=safeN(v.plus), minus=safeN(v.minus), point=safeN(v.point), fault=safeN(v.fault);
      const att = plus+minus;
      const eff = pct(plus, att);
      const conv= pct(point, att);
      const err = pct(fault, att);
      const dPF = point - fault;
      const vol = att;

      // small markers
      const mark = (cat===bestConv.cat) ? "üèÅ" : (cat===worstErr.cat ? "üö®" : (cat===bestEff.cat ? "‚úÖ" : ""));
      rows += `
        <tr>
          <td>${escapeHTML(catName(cat))} ${mark}</td>
          <td>${vol}</td>
          <td>${plus}</td>
          <td>${minus}</td>
          <td>${point}</td>
          <td>${fault}</td>
          <td>${eff}%</td>
          <td>${conv}%</td>
          <td>${err}%</td>
          <td>${dPF}</td>
        </tr>`;
    });

    return `
      <table class="diag-table">
        <thead>
          <tr>
            <th>Rubrique</th>
            <th>T</th>
            <th>+</th>
            <th>-</th>
            <th>P</th>
            <th>F</th>
            <th>Eff.</th>
            <th>Transfo</th>
            <th>F/T</th>
            <th>P-F</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="diag-row-hint">
        Lecture rapide : <b>Eff.</b> = +/(+‚àí) ¬∑ <b>Transfo</b> = P/(+‚àí) ¬∑ <b>F/T</b> = F/(+‚àí) ¬∑ <b>P-F</b> = impact net.<br/>
        L√©gende : üèÅ meilleure transfo ¬∑ ‚úÖ meilleure efficacit√© ¬∑ üö® plus gros robinet de fautes.
      </div>`;
  }

  function cardHTML(title, acc){
    const tot = totals(acc);
    const att = tot.plus + tot.minus;
    const eff = pct(tot.plus, att);
    const conv= pct(tot.point, att);
    const err = pct(tot.fault, att);
    const net = tot.point - tot.fault;

    const effCls = badgeClassEff(eff);
    const errCls = badgeClassErr(err);
    const convCls = badgeClassConv(conv);

    return `
      <div class="diag-card">
        <h4>${escapeHTML(title)}</h4>
        <div class="diag-kpis">
          <span class="diag-pill info">Tentatives: <b>${att}</b></span>
          <span class="diag-pill ${effCls}">Efficacit√©: <b>${eff}%</b></span>
          <span class="diag-pill ${convCls}">Transfo: <b>${conv}%</b></span>
          <span class="diag-pill ${errCls}">Fautes/T: <b>${err}%</b></span>
          <span class="diag-pill ${net>=0 ? "good":"bad"}">Impact net (P‚àíF): <b>${net}</b></span>
        </div>
        ${tableHTML(acc)}
      </div>`;
  }

  // If no volume at all, keep it simple
  const totSet = totals(setAcc);
  const totAtt = totSet.plus + totSet.minus;
  if(totAtt===0 && (totSet.point+totSet.fault)===0){
    host.innerHTML = `
      <div class="diag-head">
        <h3>Diagnostic (taux & efficacit√©)</h3>
        <p class="diag-sub">Saisis quelques actions (+ / - / P / F) pour obtenir des taux fiables.</p>
      </div>
      <div class="diag-card">
        <h4>Set ${escapeHTML(String(currentSet))}</h4>
        <div class="diag-row-hint">Pour l‚Äôinstant : pas assez de volume pour calculer des taux.</div>
      </div>`;
    return;
  }

  host.innerHTML = `
    <div class="diag-head">
      <h3>Diagnostic (taux & efficacit√©)</h3>
      <p class="diag-sub">M√™me logique que ton dashboard : on transforme les +/‚àí/P/F en taux actionnables.</p>
    </div>
    <div class="diag-grid">
      ${cardHTML("Set " + currentSet, setAcc)}
      ${cardHTML("Match", matchAcc)}
    </div>`;
}


function _playedSetsList() {
      const arr = [];
      for (let s = 1; s <= 5; s++) {
        const sc = getSetScore(s);
        if ((sc.nous || 0) + (sc.eux || 0) > 0) arr.push(s);
      }
      return arr;
    }

      

    function renderStatsForCurrent() {
  if (!currentStatsPlayerId) return;

  const p = players.find(x => x.id === currentStatsPlayerId);
  const nameEl = document.getElementById("player-stats-name");
  if (nameEl) nameEl.textContent = p ? (p.name || "") : "";

  const setEl = document.getElementById("player-summary-set");
  if (setEl) setEl.textContent = String(currentSet);

  const s = getPlayerSetStats(currentStatsPlayerId, currentSet);

  // lignes de stats
  document.querySelectorAll("#stats-list .stat-row").forEach(row => {
    const cat = row.dataset.cat;
    if (!cat) return;

    const minusSpan = row.querySelector(".stat-value-minus");
    const plusSpan  = row.querySelector(".stat-value-plus");
    const pointSpan = row.querySelector(".stat-value-point");
    const faultSpan = row.querySelector(".stat-value-fault");

    if (minusSpan) minusSpan.textContent = String(s[cat + "Minus"] || 0);
    if (plusSpan)  plusSpan.textContent  = String(s[cat + "Plus"] || 0);
    if (pointSpan) pointSpan.textContent = String(s[cat + "Point"] || 0);
    if (faultSpan) faultSpan.textContent = String(s[cat + "Fault"] || 0);
  });

  // totaux (impact score = P/F)
  let totalFaults = 0;
  let totalPoints = 0;

  STAT_CATEGORIES.forEach(cat => {
    totalFaults += (s[cat + "Fault"] || 0);
    totalPoints += (s[cat + "Point"] || 0);
  });

  const delta = totalPoints - totalFaults;

  const elF = document.getElementById("player-total-fautes");
  const elP = document.getElementById("player-total-points");
  const elD = document.getElementById("player-delta");

  if (elF) elF.textContent = String(totalFaults);
  if (elP) elP.textContent = String(totalPoints);
  if (elD) elD.textContent = String(delta);

  // contribution au score (set)
  const setScore = getSetScore(currentSet);
  const usPts = setScore.nous || 0;
  const oppPts = setScore.eux || 0;

  const pctSetPts = usPts ? Math.round((totalPoints / usPts) * 100) : 0;
  const pctSetFaults = oppPts ? Math.round((totalFaults / oppPts) * 100) : 0;

  const elPctSetPts = document.getElementById("player-pct-set-points");
  const elPctSetFaults = document.getElementById("player-pct-set-fautes");
  if (elPctSetPts) elPctSetPts.textContent = pctSetPts + "%";
  if (elPctSetFaults) elPctSetFaults.textContent = pctSetFaults + "%";

  // contribution match
  let matchUs = 0;
  let matchOpp = 0;
  for (let i = 1; i <= 5; i++) {
    const sc = getSetScore(i);
    matchUs += sc.nous || 0;
    matchOpp += sc.eux || 0;
  }

  const statsAllSets = stats[currentStatsPlayerId] || {};
  let matchPoints = 0;
  let matchFaults = 0;

  for (let i = 1; i <= 5; i++) {
    const ss = statsAllSets[i];
    if (!ss) continue;
    STAT_CATEGORIES.forEach(cat => {
      matchPoints += (ss[cat + "Point"] || 0);
      matchFaults += (ss[cat + "Fault"] || 0);
    });
  }

  const pctMatchPts = matchUs ? Math.round((matchPoints / matchUs) * 100) : 0;
  const pctMatchFaults = matchOpp ? Math.round((matchFaults / matchOpp) * 100) : 0;

  const elPctMatchPts = document.getElementById("player-pct-match-points");
  const elPctMatchFaults = document.getElementById("player-pct-match-fautes");
  if (elPctMatchPts) elPctMatchPts.textContent = pctMatchPts + "%";
  if (elPctMatchFaults) elPctMatchFaults.textContent = pctMatchFaults + "%";

  // Rapport texte
  if (typeof updatePlayerShareText === "function") {
    updatePlayerShareText();
  }

  // Affiche et branche le bouton Diagnostic (PRO)
  try {
    const row = document.querySelector(".diag-toggle-row");
    if (row) row.style.display = "flex";
    if (typeof initDiagnosticsToggle === "function") if (typeof initDiagnosticsToggle === 'function') initDiagnosticsToggle();
  } catch(e) {}

  // Diagnostics (taux & efficacit√©) + storytelling
  try { renderPlayerDiagnostics(currentStatsPlayerId); } catch(e) {}
  try { renderPlayerSmartRead(currentStatsPlayerId); } catch(e) {}
  try { _syncStatsPlayerSelect(); } catch(e) {}
}

    /* --------- STATS JOUEUSE : contr√¥les ---------- */
function initStatsControls() {
  const statsList = document.getElementById("stats-list");
  if (!statsList) return;

  statsList.addEventListener("click", (e) => {
    const row = e.target.closest(".stat-row");
    if (!row) return;
    const cat = row.dataset.cat;
    if (!cat) return;

    if (!currentPlayerId) {
      alert("S√©lectionne d‚Äôabord une joueur¬∑euse (Effectif / Terrain).");
      return;
    }

    // Boutons
    const btn = e.target.closest("button");
    if (btn) {
      const type = btn.dataset.type; // plus / minus / point / fault
      if (!type) return;
      addRallyStat(currentPlayerId, cat, type);
      renderStatsForCurrent();
      return;
    }

    // Clic direct sur le chiffre -> √©dition
    const span = e.target.closest(".stat-value");
    if (!span) return;

    let type = "plus";
    if (span.classList.contains("stat-value-minus")) type = "minus";
    if (span.classList.contains("stat-value-plus"))  type = "plus";
    if (span.classList.contains("stat-value-point")) type = "point";
    if (span.classList.contains("stat-value-fault")) type = "fault";

    const s = getPlayerSetStats(currentPlayerId, currentSet);
    const suffix =
      type === "minus" ? "Minus" :
      type === "point" ? "Point" :
      type === "fault" ? "Fault" : "Plus";

    const key = cat + suffix;
    const cur = s[key] || 0;

    const raw = prompt("Nouvelle valeur pour " + cat + " (" + type.toUpperCase() + ") :", String(cur));
    if (raw === null) return;

    const v = Math.max(0, parseInt(raw, 10) || 0);
    s[key] = v;
    saveStats();
    updateCourtWarningsForSet();
    renderDashboard();
    renderStatsForCurrent();
  });
}

  const btnBack = document.getElementById("btn-back");
  if (btnBack) {
    btnBack.addEventListener("click", function() {
      const statsContainer = document.getElementById("stats-container");
      const mainView = document.getElementById("main-view");
      if (statsContainer) statsContainer.style.display = "none";
      if (mainView) mainView.style.display = "block";
    });
  }

  const btnCopy = document.getElementById("btn-player-report-copy");
  const btnShare = document.getElementById("btn-player-report-share");
  const btnWA    = document.getElementById("btn-player-report-wa");
  const btnTG    = document.getElementById("btn-player-report-tg");
  const btnPrint = document.getElementById("btn-player-report-print");

  function getCurrentPlayerReportText() {
    const area = document.getElementById("player-report-text");
    const preview = document.getElementById("player-report-preview");
    if (!area) return "";
    // Toujours r√©g√©n√©rer √† partir des stats (tous sets) pour √©viter les infos p√©rim√©es
    if (currentStatsPlayerId) {
      area.value = buildPlayerReportText(currentStatsPlayerId);
    }
    const val = area.value || "";
    if (preview) {
      preview.innerHTML = val.trim() ? prettyReportHTML(val) : "";
    }
    return val;
  }

  if (btnCopy) {
    btnCopy.addEventListener("click", function() {
      const txt = getCurrentPlayerReportText();
      if (!txt.trim()) {
        alert("Aucun rapport √† copier (s√©lectionne une joueur¬∑euse).");
        return;
      }
      copyTextToClipboard(txt, "Rapport individuel copi√© ‚úÖ");
    });
  }

  if (btnShare) {
    btnShare.addEventListener("click", function() {
      const txt = getCurrentPlayerReportText();
      if (!txt.trim()) {
        alert("Aucun rapport √† partager (s√©lectionne une joueur¬∑euse).");
        return;
      }
      shareTextSmart("Stat2Match ‚Äì Rapport individuel", txt, "Rapport copi√© ‚úÖ");
    });
  }

  if (btnWA) {
    btnWA.addEventListener("click", function() {
      const txt = getCurrentPlayerReportText();
      if (!txt.trim()) {
        alert("Aucun rapport √† envoyer (s√©lectionne une joueur¬∑euse).");
        return;
      }
      openShareWhatsApp(txt);
    });
  }

  if (btnTG) {
    btnTG.addEventListener("click", function() {
      const txt = getCurrentPlayerReportText();
      if (!txt.trim()) {
        alert("Aucun rapport √† envoyer (s√©lectionne une joueur¬∑euse).");
        return;
      }
      openShareTelegram(txt);
    });
  }

  if (btnPrint) {
    btnPrint.addEventListener("click", function() {
      const txt = getCurrentPlayerReportText();
      if (!txt.trim()) {
        alert("Aucun rapport √† imprimer (s√©lectionne une joueur¬∑euse).");
        return;
      }
      const p = players.find(x => x.id === currentStatsPlayerId);
      const who = p ? ((p.number ? "#" + p.number + " " : "") + (p.name || "")) : "Joueur¬∑euse";
      openPrintableTextPage("Stat2Match ‚Äì Rapport individuel", who, txt);
    });
  }


    /* --------- DASHBOARD ---------- */
    

// ===== Storytelling dashboard (port√© de la 4x4 Pro Stable) =====
function _isSetCompleted(setNumber) {
      const sc = getSetScore(setNumber);
      const a = sc.nous || 0;
      const b = sc.eux  || 0;
      const threshold = (setNumber === 5) ? 15 : 25;
      return (Math.max(a, b) >= threshold) && (Math.abs(a - b) >= 2);
    }

function _computeTeamTotalsForSets(setsList) {
      const acc = {};
      STAT_CATEGORIES.forEach(cat => {
        acc[cat] = { plus: 0, minus: 0, point: 0, fault: 0 };
      });

      let totalPlus = 0, totalMinus = 0, totalPoint = 0, totalFault = 0;

      for (const pid in stats) {
        const perPlayerSets = stats[pid];
        if (!perPlayerSets) continue;

        (setsList || []).forEach(setNumber => {
          const s = perPlayerSets[setNumber];
          if (!s) return;
          STAT_CATEGORIES.forEach(cat => {
            const plus  = s[cat + "Plus"]  || 0;
            const minus = s[cat + "Minus"] || 0;
            const point = s[cat + "Point"] || 0;
            const fault = s[cat + "Fault"] || 0;
            acc[cat].plus  += plus;
            acc[cat].minus += minus;
            acc[cat].point += point;
            acc[cat].fault += fault;

            totalPlus  += plus;
            totalMinus += minus;
            totalPoint += point;
            totalFault += fault;
          });
        });
      }

      return { acc, totalPlus, totalMinus, totalPoint, totalFault };
    }

function _computeOpponentTotalsForSets(setsList) {
      const out = {
        serviceFautes: 0, servicePoints: 0, blocPoints: 0, cadeaux: 0,
        pointsPourNous: 0, pointsPourEux: 0,
        errService: 0, errAttaque: 0, errBloc: 0, errAutre: 0
      };
      (setsList || []).forEach(setNumber => {
        const os = getOpponentSetStats(setNumber);
        out.serviceFautes += (os.serviceMinus || 0);
        out.servicePoints += (os.servicePlus  || 0);
        out.blocPoints    += (os.blocPlus     || 0);
        out.cadeaux       += (os.cadeauxPlus  || 0);
        out.pointsPourNous+= (os.pointsMinus  || 0);
        out.pointsPourEux += (os.pointsPlus   || 0);
        out.errService    += (os.errService   || 0);
        out.errAttaque    += (os.errAttaque   || 0);
        out.errBloc       += (os.errBloc      || 0);
        out.errAutre      += (os.errAutre     || 0);
      });
      out.totalFault = (out.errService||0) + (out.errAttaque||0) + (out.errBloc||0) + (out.errAutre||0);
      return out;
    }

function _effPct(plus, minus){
      plus = (+plus)||0; minus = (+minus)||0;
      const denom = plus + minus;
      if(!denom) return NaN;
      return plus/denom;
    }

function _fmtPct(x) {
      if (!isFinite(x)) return "‚Äî";
      return Math.round(x * 100) + "%";
    }

function escapeHTML(str) {
      // Safe minimal HTML escaping for any text we inject into innerHTML
      str = (str === null || str === undefined) ? "" : String(str);
      return str.replace(/[&<>"']/g, (ch) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[ch]));
    }



function prettyReportHTML(text, opts){
      // Transforme un texte (rapport) en HTML lisible (sans d√©pendances).
      // - respecte la s√©curit√© via escapeHTML
      // - supporte : titres, s√©parateurs, listes, badges simples
      opts = opts || {};
      const raw = (text === null || text === undefined) ? "" : String(text);
      const lines = raw.replace(/\r/g, "").split("\n");
      const out = [];
      let inList = false;

      const flushList = () => { if (inList) { out.push("</ul>"); inList = false; } };

      const pushP = (htmlLine) => { flushList(); out.push(`<p>${htmlLine}</p>`); };

      // Heuristique titre: premi√®re ligne courte ou ligne qui commence par emoji/titre
      const firstNonEmptyIdx = lines.findIndex(l => l.trim().length);
      if (firstNonEmptyIdx >= 0) {
        const first = lines[firstNonEmptyIdx].trim();
        if (first.length <= 60 || /^([üèêüèÜ‚úÖ‚ö†Ô∏èüéØüìå‚≠êÔ∏èüß†üß©])/.test(first)) {
          // on affiche comme titre, puis on saute cette ligne du parsing normal
          out.push(`<div class="pr-title">${escapeHTML(first)}</div>`);
          lines[firstNonEmptyIdx] = "";
        }
      }

      lines.forEach((ln) => {
        const t = (ln || "").trim();
        if (!t) { flushList(); return; }

        // S√©parateurs visuels
        if (/^[-‚Äì‚Äî]{3,}$/.test(t) || t === "‚Ä¢ ‚Ä¢ ‚Ä¢") {
          flushList();
          out.push('<hr class="pr-hr" />');
          return;
        }

        // Lignes "chip" : "Set 1 : ..." ou "Match : ..." etc
        if (/^(Set\s*\d+|Match|Score|MVP|Priorit√©|Ce qui marche|Ce qui co√ªte|Tendance|Tendances)\s*[:Ôºö]/i.test(t)) {
          flushList();
          const parts = t.split(/[:Ôºö]/);
          const head = escapeHTML(parts.shift().trim());
          const rest = escapeHTML(parts.join(":").trim());
          out.push(`<div class="pr-chip"><span class="pr-tag">${head}</span><span>${rest}</span></div>`);
          return;
        }

        // Listes (‚Ä¢ / - / *)
        if (/^([‚Ä¢\-*])\s+/.test(t)) {
          if (!inList) { out.push("<ul>"); inList = true; }
          out.push(`<li>${escapeHTML(t.replace(/^([‚Ä¢\-*])\s+/, ""))}</li>`);
          return;
        }

        // Paragraphe normal (autorise "‚Äî" etc)
        pushP(escapeHTML(t));
      });

      flushList();

      const body = out.join("\n");
      return `<div class="pretty-report">${body}</div>`;
    }


function _catLabel(cat) {
      const map = { attaque:"Attaque", service:"Service", bloc:"Bloc", reception:"R√©ception", defense:"D√©fense", passe:"Passe", relance:"Relance" };
      return map[cat] || cat;
    }

function _who(pObj) {
        if (!pObj || !pObj.player) return "‚Äî";
        const p = pObj.player;
        const n = p.number ? ("#" + p.number + " ") : "";
        return n + (p.name || "");
      }

function _bestPlayerByMetric(getMetricFn) {
      const inMatch = (players || []).filter(p => p && p.id && (p.inMatch !== false) && p.name);
      let best = null, bestVal = -Infinity;
      inMatch.forEach(p => {
        let val = 0;
        const sets = _playedSetsList();
        sets.forEach(s => {
          const st = getPlayerSetStats(p.id, s);
          val += (getMetricFn(st) || 0);
        });
        if (val > bestVal) { bestVal = val; best = p; }
      });
      return { player: best, value: bestVal };
    }

function renderGlobalMatchRead() {
      const host = document.getElementById("dash-read-body");
      if (!host) return;

      const played = _playedSetsList();
      if (!played.length) {
        host.innerHTML = '<div class="story-wrap"><div class="story-topline"><div class="story-icon">‚ÑπÔ∏è</div><div class="story-main"><div class="story-title">Lecture coach</div><p class="story-sub">Aucun point saisi : joue un peu le match, puis reviens ici.</p></div></div></div>';
        return;
      }

      // Score sets + points match
      let setsWonUs = 0, setsWonThem = 0;
      let ptsUs = 0, ptsThem = 0;

      played.forEach(s => {
        const sc = getSetScore(s);
        const a = sc.nous || 0, b = sc.eux || 0;
        ptsUs += a; ptsThem += b;

        if (_isSetCompleted(s)) {
          if (a > b) setsWonUs++; else if (b > a) setsWonThem++;
        }
      });

      const leadPts = ptsUs - ptsThem;
      const deltaPtsStr = (leadPts >= 0 ? "+" : "") + leadPts;

      // Team +/-/impact
      const team = _computeTeamTotalsForSets(played);
      const opp  = _computeOpponentTotalsForSets(played);

      // Find key drivers
      let worstFaultCat = null, worstFaultVal = -1;
      let bestPointCat  = null, bestPointVal  = -1;
      let worstMinusCat = null, worstMinusVal = -1;
      let bestDeltaCat  = null, bestDeltaVal  = -Infinity;

      STAT_CATEGORIES.forEach(cat => {
        const v = team.acc[cat] || { plus:0, minus:0, point:0, fault:0 };
        if (v.fault > worstFaultVal) { worstFaultVal = v.fault; worstFaultCat = cat; }
        if (v.point > bestPointVal)  { bestPointVal = v.point; bestPointCat = cat; }
        if (v.minus > worstMinusVal) { worstMinusVal = v.minus; worstMinusCat = cat; }

        const delta = (v.plus || 0) - (v.minus || 0);
        if (delta > bestDeltaVal) { bestDeltaVal = delta; bestDeltaCat = cat; }
      });

      const bestDeltaStr  = (bestDeltaVal >= 0 ? "+" : "") + bestDeltaVal;
      const worstDeltaVal = worstMinusCat ? (((team.acc[worstMinusCat]?.plus||0) - (team.acc[worstMinusCat]?.minus||0)) || 0) : 0;
      const worstDeltaStr = (worstDeltaVal >= 0 ? "+" : "") + worstDeltaVal;

      const nameUs  = (getOurTeamName && getOurTeamName()) || "Nous";
      const nameOpp = (getOppTeamName && getOppTeamName()) || (opponentTeamName || opponent || "Eux");

      const oppGifts = Number(opp?.totalFault || 0);
      const ourGifts = Number(team?.totalFault || 0);

      const lines = [];
      lines.push('<div class="story-wrap">');

      // Topline
      lines.push(
        '<div class="story-topline">' +
          '<div class="story-icon">üé¨</div>' +
          '<div class="story-main">' +
            '<div class="story-title">Lecture coach ‚Äì le ‚Äúpourquoi‚Äù du score</div>' +
            `<p class="story-sub"><strong>${escapeHTML(nameUs)}</strong> ${ptsUs} - ${ptsThem} <strong>${escapeHTML(nameOpp)}</strong> (<strong>${deltaPtsStr}</strong>) ¬∑ Sets : <strong>${setsWonUs}-${setsWonThem}</strong></p>` +
            '<div class="story-kpis">' +
              `<span class="story-kpi">‚úÖ P : <strong>${team.totalPoint || 0}</strong></span>` +
              `<span class="story-kpi">‚ö†Ô∏è F : <strong>${team.totalFault || 0}</strong></span>` +
              `<span class="story-kpi">Œî √©quipe : <strong>${(team.totalPlus||0)-(team.totalMinus||0)}</strong></span>` +
              `<span class="story-kpi">Cadeaux eux : <strong>${oppGifts}</strong></span>` +
            '</div>' +
          '</div>' +
        '</div>'
      );

      // Cards
      lines.push('<div class="story-grid">');

      // 1) Ce qui marche
      if (bestPointCat) {
        const bp = bestPointVal || 0;
        lines.push(
          `<div class="story-card good"><h4><span class="story-badge">‚úÖ</span>Ce qui marche</h4>` +
          `<p>Ton <strong>moteur points (P)</strong> c‚Äôest <strong>${_catLabel(bestPointCat)}</strong> (<strong>${bp}</strong> pts). ` +
          `Et ton meilleur <strong>diff√©rentiel (+/‚àí)</strong> est <strong>${_catLabel(bestDeltaCat)}</strong> (Œî <strong>${bestDeltaStr}</strong>).</p>` +
          `<div class="mini">Plan A quand √ßa chauffe : recr√©er des situations o√π <strong>${_catLabel(bestPointCat)}</strong> finit le point.</div>` +
          `</div>`
        );
      } else {
        lines.push(
          `<div class="story-card good"><h4><span class="story-badge">‚úÖ</span>Ce qui marche</h4>` +
          `<p>Pas assez de donn√©es pour isoler un ‚Äúmoteur points‚Äù. Continue √† saisir quelques rallyes.</p></div>`
        );
      }

      // 2) Ce qui co√ªte
      if (worstFaultCat) {
        const wf = worstFaultVal || 0;
        lines.push(
          `<div class="story-card bad"><h4><span class="story-badge">‚ö†Ô∏è</span>Ce qui co√ªte</h4>` +
          `<p>Le <strong>robinet de points donn√©s (F)</strong> c‚Äôest <strong>${_catLabel(worstFaultCat)}</strong> (<strong>${wf}</strong> fautes). ` +
          `La zone √† s√©curiser en <strong>+ / ‚àí</strong> est <strong>${_catLabel(worstMinusCat || worstFaultCat)}</strong> (Œî <strong>${worstDeltaStr}</strong>).</p>` +
          `<div class="mini">C‚Äôest souvent ce qui fait basculer un set quand les scores se resserrent.</div>` +
          `</div>`
        );
      }

      // 3) Priorit√© (actionnable)
      const target = Math.min(5, (worstFaultVal > 0 ? worstFaultVal : 0));
      if (target > 0 && worstFaultCat) {
        lines.push(
          `<div class="story-card prio"><h4><span class="story-badge">üéØ</span>Priorit√©</h4>` +
          `<p>R√®gle simple : <strong>tu coupes d‚Äôabord les points donn√©s</strong>, puis tu amplifies ton meilleur levier.</p>` +
          `<div class="mini">Objectif concret : enlever <strong>${target}</strong> erreurs sur <strong>${_catLabel(worstFaultCat)}</strong> ‚Üí tu changes la dynamique du set.</div>` +
          `</div>`
        );
      } else {
        lines.push(
          `<div class="story-card prio"><h4><span class="story-badge">üéØ</span>Priorit√©</h4>` +
          `<p>Pour l‚Äôinstant, l‚Äôobjectif est de saisir plus d‚Äôactions pour faire ressortir une priorit√© claire.</p></div>`
        );
      }

      // 4) Eux (cadeaux)
      lines.push(
        `<div class="story-card neutral"><h4><span class="story-badge">üëÄ</span>Eux</h4>` +
        `<p>Erreurs directes adverses (points gratuits) : <strong>${oppGifts}</strong>. √Ä mettre en face de nos fautes : <strong>${ourGifts}</strong>.</p>` +
        `<div class="mini">Si tu descends tes <strong>F</strong> sous leurs cadeaux, tu reprends le contr√¥le.</div>` +
        `</div>`
      );

      // 5) Tendances (awards)
      const _pLabel = (p) => {
        if (!p) return "‚Äî";
        const j = (p.number ?? p.jersey ?? p.jerseyNumber ?? p.num ?? "");
        const jTxt = j ? ("#" + j + " ") : "";
        return jTxt + escapeHTML(p.name || "");
      };

      const mvp      = _bestPlayerByMetric(st => ((st.plus||0)-(st.minus||0)));
      const bestAtt  = _bestPlayerByMetric(st => (st.attaquePoint||0));
      const bestBloc = _bestPlayerByMetric(st => (st.blocPoint||0));
      const bestRec  = _bestPlayerByMetric(st => (st.receptionPlus||0) - (st.receptionMinus||0));
      const bestDef  = _bestPlayerByMetric(st => (st.defensePlus||0) - (st.defenseMinus||0));
      const bestPasse= _bestPlayerByMetric(st => (st.passePlus||0) - (st.passeMinus||0));

      const mvpName  = mvp?.player ? _pLabel(mvp.player) : "‚Äî";
      const attName  = bestAtt?.player ? _pLabel(bestAtt.player) : "‚Äî";
      const blocName = bestBloc?.player? _pLabel(bestBloc.player) : "‚Äî";
      const recName  = bestRec?.player ? _pLabel(bestRec.player) : "‚Äî";
      const defName  = bestDef?.player ? _pLabel(bestDef.player) : "‚Äî";
      const pasName  = bestPasse?.player? _pLabel(bestPasse.player) : "‚Äî";

      lines.push(
        `<div class="story-card trophy"><h4><span class="story-badge">üèÜ</span>Tendances</h4>` +
        `<p>Si on arr√™tait maintenant : MVP (Œî) <strong>${mvpName}</strong> ¬∑ Attaque <strong>${attName}</strong> ¬∑ Bloc <strong>${blocName}</strong> ¬∑ R√©cep <strong>${recName}</strong> ¬∑ D√©f <strong>${defName}</strong> ¬∑ Passe <strong>${pasName}</strong>.</p>` +
        `<div class="mini">Ces tendances bougent d√®s que tu corriges les zones ‚Äú‚ö†Ô∏è‚Äù.</div>` +
        `</div>`
      );

      lines.push('</div>'); // story-grid
      lines.push('</div>'); // story-wrap
      host.innerHTML = lines.join("");
    }
// ===== Fin storytelling dashboard =====

function renderDashboard() {
      const score = getSetScore(currentSet);
      document.getElementById("dash-score-set-label").textContent = "Set " + currentSet;
      document.getElementById("dash-score-nous").textContent = score.nous || 0;
      document.getElementById("dash-score-eux").textContent  = score.eux || 0;

      const acc = {};
      STAT_CATEGORIES.forEach(cat => {
        acc[cat + "Plus"]  = 0;
        acc[cat + "Minus"] = 0;
        acc[cat + "Point"] = 0;
        acc[cat + "Fault"] = 0;
      });
      let totalPoints = 0;
      let totalFaults = 0;

      for (const pid in stats) {
        const sets = stats[pid];
        if (!sets) continue;
        const s = sets[currentSet];
        if (!s) continue;
        STAT_CATEGORIES.forEach(cat => {
          const plus  = s[cat + "Plus"]  || 0;
          const minus = s[cat + "Minus"] || 0;
          const point = s[cat + "Point"] || 0;
          const fault = s[cat + "Fault"] || 0;
          acc[cat + "Plus"]  += plus;
          acc[cat + "Minus"] += minus;
          acc[cat + "Point"] += point;
          acc[cat + "Fault"] += fault;
          totalPoints += point;
          totalFaults += fault;
        });
      }

      const body = document.getElementById("dash-team-body");
      body.innerHTML = "";
      const namesMap = {
        attaque: "Attaque",
        service: "Service",
        bloc:    "Bloc",
        reception: "R√©ception",
        defense: "D√©fense",
        passe: "Passe"
      };
      STAT_CATEGORIES.forEach(cat => {
        const row = document.createElement("div");
        row.className = "stat-row";
        const label = document.createElement("div");
        label.className = "stat-label";
        label.textContent = namesMap[cat] || cat;

        const controls = document.createElement("div");
        controls.className = "stat-controls";

        const minusSpan = document.createElement("span");
        minusSpan.className = "stat-value";
        minusSpan.textContent = acc[cat + "Minus"] || 0;

        const sep = document.createElement("span");
        sep.className = "stat-sep";
        sep.textContent = "- / +";

        const plusSpan = document.createElement("span");
        plusSpan.className = "stat-value";
        plusSpan.textContent = acc[cat + "Plus"] || 0;

        const sep2 = document.createElement("span");
        sep2.className = "stat-sep";
        sep2.textContent = " ¬∑ ";

        const faultSpan = document.createElement("span");
        faultSpan.className = "stat-value";
        faultSpan.textContent = acc[cat + "Fault"] || 0;

        const sep3 = document.createElement("span");
        sep3.className = "stat-sep";
        sep3.textContent = " F / P ";

        const pointSpan = document.createElement("span");
        pointSpan.className = "stat-value";
        pointSpan.textContent = acc[cat + "Point"] || 0;

        controls.appendChild(minusSpan);
        controls.appendChild(sep);
        controls.appendChild(plusSpan);
        controls.appendChild(sep2);
        controls.appendChild(faultSpan);
        controls.appendChild(sep3);
        controls.appendChild(pointSpan);

        row.appendChild(label);
        row.appendChild(controls);
        body.appendChild(row);
      });

      const totalRow = document.createElement("div");
      totalRow.className = "stat-row";
      const totalLabel = document.createElement("div");
      totalLabel.className = "stat-label";
      totalLabel.textContent = "TOTAL (impact score)";
      const totalControls = document.createElement("div");
      totalControls.className = "stat-controls";

      const tMinus = document.createElement("span");
      tMinus.className = "stat-value";
      tMinus.textContent = totalFaults;

      const tSep = document.createElement("span");
      tSep.className = "stat-sep";
      tSep.textContent = "F / P (impact total du set)";

      const tPlus = document.createElement("span");
      tPlus.className = "stat-value";
      tPlus.textContent = totalPoints;

      totalControls.appendChild(tMinus);
      totalControls.appendChild(tSep);
      totalControls.appendChild(tPlus);

      totalRow.appendChild(totalLabel);
      totalRow.appendChild(totalControls);
      body.appendChild(totalRow);

      document.getElementById("dash-team-set-label").textContent = currentSet;

            const os = getOpponentSetStats(currentSet);

      const elServFautes = document.getElementById("dash-opp-service-fautes");
      const elServPts    = document.getElementById("dash-opp-service-points");
      const elBlocPts    = document.getElementById("dash-opp-bloc-points");
      const elCad        = document.getElementById("dash-opp-cadeaux");
      const elPNous      = document.getElementById("dash-opp-points-pourNous");
      const elPEux       = document.getElementById("dash-opp-points-pourEux");
      const elSetLabel   = document.getElementById("dash-opp-set-label");
      const elTotFautes  = document.getElementById("dash-total-fautes-pour-eux");

      if (elServFautes) elServFautes.textContent = os.serviceMinus || 0;
      if (elServPts)    elServPts.textContent    = os.servicePlus  || 0;
      if (elBlocPts)    elBlocPts.textContent    = os.blocPlus     || 0;
      if (elCad)        elCad.textContent        = os.cadeauxPlus  || 0;
      if (elPNous)      elPNous.textContent      = os.pointsMinus  || 0;
      if (elPEux)       elPEux.textContent       = os.pointsPlus   || 0;
      if (elSetLabel)   elSetLabel.textContent   = currentSet;

      const totalFautesPourEux = totalFaults;
      if (elTotFautes) elTotFautes.textContent = totalFautesPourEux;


// --- Comparatif (nous vs eux) ---
const elOurPos = document.getElementById("dash-our-pos");
const elOurNeg = document.getElementById("dash-our-neg");
const elOppPos = document.getElementById("dash-opp-pos");
const elOppNeg = document.getElementById("dash-opp-neg");
const elImpactTheirs = document.getElementById("dash-impact-theirs");
const elImpactOurs   = document.getElementById("dash-impact-ours");

const ourPosVal = totalPoints;
const ourNegVal = totalFaults;

const oppPosVal = (os.servicePlus||0) + (os.blocPlus||0) + (os.pointsPlus||0);
const oppNegVal = (os.serviceMinus||0) + (os.cadeauxPlus||0) + (os.pointsMinus||0);

if (elOurPos) elOurPos.textContent = ourPosVal;
if (elOurNeg) elOurNeg.textContent = ourNegVal;
if (elOppPos) elOppPos.textContent = oppPosVal;
if (elOppNeg) elOppNeg.textContent = oppNegVal;

const impactTheirsPct = score.eux ? Math.round(100 * (ourNegVal / score.eux)) : 0;
const impactOursPct   = score.nous ? Math.round(100 * (oppNegVal / score.nous)) : 0;
if (elImpactTheirs) elImpactTheirs.textContent = impactTheirsPct + "%";
if (elImpactOurs)   elImpactOurs.textContent   = impactOursPct + "%";

// --- Highlights (top Œî / soutien / attaque / fautes) ---
const hiBody = document.getElementById("dash-highlights-body");
if (hiBody && typeof getSetHighlights === "function") {
  hiBody.innerHTML = "";

  const hi = getSetHighlights(currentSet);
  const getName = (id) => (players||[]).find(x => x.id === id)?.name || id || "‚Äî";

  const mkRow = (labelText) => {
    const row = document.createElement("div");
    row.className = "dash-hl-row";
    const l = document.createElement("div");
    l.className = "dash-hl-label";
    l.textContent = labelText;
    const v = document.createElement("div");
    v.className = "dash-hl-val";
    row.appendChild(l);
    row.appendChild(v);
    hiBody.appendChild(row);
    return v;
  };

  const addPills = (container, list, key, pillClass, signPlus=false) => {
    const items = (list||[]).slice(0,3);
    if (!items.length) { container.textContent = "‚Äî"; return; }
    container.innerHTML = "";
    items.forEach((x, i) => {
      const pill = document.createElement("span");
      pill.className = "dash-pill " + pillClass;
      const val = Number(x[key]||0);
      const sval = signPlus && val>=0 ? ("+"+val) : String(val);
      pill.textContent = `${getName(x.id)} ${sval}`;
      container.appendChild(pill);
    });
  };

  const v1 = mkRow("Top Œî (impact net)");
  addPills(v1, hi.topDelta, "delta", "pink", true);

  const v2 = mkRow("Top soutien (d√©fense+ + r√©cep+)");
  addPills(v2, hi.topSupport, "support", "green", false);

  const v3 = mkRow("Top attaque (points attaque+)");
  addPills(v3, hi.topAttack, "attack", "orange", false);

  const v4 = mkRow("Fautes √† surveiller");
  addPills(v4, hi.topFaults, "minus", "blue", false);
}


// =========================
// Diagnostics toggle (PRO)
// =========================
function initDiagnosticsToggle(){
  const btn = document.getElementById('btn-toggle-diagnostics');
  const box = document.getElementById('player-diagnostics');
  if(!btn) return;
  if(btn.__bound) return;
  btn.__bound = true;

  const hasModal = !!document.getElementById('diag-modal');
  const key = 's2m_diag_open';
  const read = ()=>{ try { return localStorage.getItem(key) === '1'; } catch(e){ return false; } };
  const write = (v)=>{ try { localStorage.setItem(key, v ? '1':'0'); } catch(e){} };

  // If the Diagnostics modal exists, we use it (most reliable UX, always visible).
  // Otherwise, fallback to the inline collapsible panel.
  if(hasModal && typeof window.openDiagnosticsPRO === "function"){
    btn.textContent = 'üìä Diagnostic (PRO)';
    btn.addEventListener('click', ()=>{
      try{
        const pid = (typeof currentStatsPlayerId !== "undefined" && currentStatsPlayerId) ? currentStatsPlayerId : null;
        window.openDiagnosticsPRO(pid);
      }catch(e){ console.warn("openDiagnosticsPRO error:", e); }
    });
    return;
  }

  // Inline fallback (older builds)
  if(!box) return;

  const apply = (open)=>{
    box.style.display = open ? 'block' : 'none';
    box.classList.toggle('is-collapsed', !open);
    btn.classList.toggle('active', open);
    btn.textContent = open ? 'üìä Diagnostic (PRO) ‚Äî masquer' : 'üìä Diagnostic (PRO)';

    // Populate diagnostics only when opened (safe + avoids heavy render loops)
    if(open){
      try{
        const pid = (typeof currentStatsPlayerId !== "undefined" && currentStatsPlayerId) ? currentStatsPlayerId : null;
        if (pid && typeof renderPlayerDiagnostics === 'function') renderPlayerDiagnostics(pid);
      }catch(e){ console.warn("renderPlayerDiagnostics error:", e); }
      try{ box.scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}
    }
  };

  apply(read());

  btn.addEventListener('click', ()=>{
    const open = (box.style.display === 'none' || box.classList.contains('is-collapsed'));
    apply(open);
    write(open);
  });
}


// Distinctions auto (pr√©-s√©lection + suggestions)
renderGlobalMatchRead();

      if (typeof refreshAwardsUI === "function") refreshAwardsUI();


    }

          
    /* --------- DISTINCTIONS AUTO (6x6) ---------- */

    function getInMatchPlayers() {
      return (players || []).filter(p => p && p.name && (p.inMatch !== false));
    }

    function getPlayerTotalsForSet(playerId, setNumber) {
      const s = getPlayerSetStats(playerId, setNumber);
      let plus = 0, minus = 0;
      STAT_CATEGORIES.forEach(cat => {
        plus  += (s[cat + "Plus"]  || 0);
        minus += (s[cat + "Minus"] || 0);
      });
      const delta = plus - minus;

      const attaquePlus  = s.attaquePlus  || 0, attaqueMinus  = s.attaqueMinus  || 0;
      const blocPlus     = s.blocPlus     || 0, blocMinus     = s.blocMinus     || 0;
      const defensePlus  = s.defensePlus  || 0;
      const receptionPlus= s.receptionPlus|| 0;

      return {
        plus, minus, delta,
        attaquePlus, attaqueMinus,
        blocPlus, blocMinus,
        supportPlus: defensePlus + receptionPlus
      };
    }

    function computeAutoAwards(setNumber) {
      const cand = getInMatchPlayers();
      const rows = cand.map(p => ({ p, t: getPlayerTotalsForSet(p.id, setNumber) }));

      // MVP: max actions +, delta strictement positif
      const mvpRow = rows
        .filter(r => (r.t.delta > 0))
        .sort((a,b) => (b.t.plus - a.t.plus) || (b.t.delta - a.t.delta))[0];

      // Best block: max blocPlus
      const bestBlockRow = rows
        .sort((a,b) => (b.t.blocPlus - a.t.blocPlus) || (b.t.delta - a.t.delta))[0];

      // Best attack: max attaquePlus, id√©alement delta attaque positif (tie-break)
      const bestAttackRow = rows
        .sort((a,b) => (b.t.attaquePlus - a.t.attaquePlus) || (( (b.t.attaquePlus - b.t.attaqueMinus) - (a.t.attaquePlus - a.t.attaqueMinus) )))[0];

      // Best support: max (defense+ + reception+)
      const bestSupportRow = rows
        .sort((a,b) => (b.t.supportPlus - a.t.supportPlus) || (b.t.delta - a.t.delta))[0];

      return {
        mvp: mvpRow?.p || null,
        mvpMeta: mvpRow?.t || null,
        bestBlock: bestBlockRow?.p || null,
        bestBlockMeta: bestBlockRow?.t || null,
        bestAttack: bestAttackRow?.p || null,
        bestAttackMeta: bestAttackRow?.t || null,
        bestSupport: bestSupportRow?.p || null,
        bestSupportMeta: bestSupportRow?.t || null
      };
    }

    function fillAwardSelect(selectEl) {
      if (!selectEl) return;
      const prev = selectEl.value;
      const locked = selectEl.dataset.locked === "1";

      // Keep first option
      const firstOpt = selectEl.querySelector("option[value='']") || selectEl.querySelector("option");
      selectEl.innerHTML = "";
      const optNone = document.createElement("option");
      optNone.value = "";
      optNone.textContent = "‚Äî Aucune ‚Äî";
      selectEl.appendChild(optNone);

      getInMatchPlayers().forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = (p.number ? (p.number + " ") : "") + p.name;
        selectEl.appendChild(opt);
      });

      if (locked && prev) {
        selectEl.value = prev;
      }
    }

    function applyAutoAwardToSelect(selectEl, playerObj) {
      if (!selectEl) return;
      const locked = selectEl.dataset.locked === "1";
      if (locked) return; // l'utilisateur a choisi manuellement
      selectEl.value = playerObj ? playerObj.id : "";
    }

    function wireAwardSelectLock(selectEl) {
      if (!selectEl) return;
      if (selectEl.dataset.wired === "1") return;
      selectEl.dataset.wired = "1";
      selectEl.addEventListener("change", () => {
        selectEl.dataset.locked = "1";
      });
    }

    function refreshAwardsUI() {
      const mvpSel   = document.getElementById("select-mvp");
      const blkSel   = document.getElementById("select-best-block");
      const atkSel   = document.getElementById("select-best-attack");
      const supSel   = document.getElementById("select-best-support");

      fillAwardSelect(mvpSel);
      fillAwardSelect(blkSel);
      fillAwardSelect(atkSel);
      fillAwardSelect(supSel);

      wireAwardSelectLock(mvpSel);
      wireAwardSelectLock(blkSel);
      wireAwardSelectLock(atkSel);
      wireAwardSelectLock(supSel);

      const sug = computeAutoAwards(currentSet);

      // Preselect if not manually overridden
      applyAutoAwardToSelect(mvpSel, sug.mvp);
      applyAutoAwardToSelect(blkSel, sug.bestBlock);
      applyAutoAwardToSelect(atkSel, sug.bestAttack);
      applyAutoAwardToSelect(supSel, sug.bestSupport);

      // Hints
      const mvpHint = document.getElementById("mvp-suggestion");
      const blkHint = document.getElementById("best-block-suggestion");
      const atkHint = document.getElementById("best-attack-suggestion");
      const supHint = document.getElementById("best-support-suggestion");

      if (mvpHint) {
        if (!sug.mvp) mvpHint.textContent = "Suggestion auto : aucune (Œî doit √™tre positif).";
        else mvpHint.textContent = `Suggestion auto : ${sug.mvp.name} ‚Äî Actions+ ${sug.mvpMeta.plus} | Actions- ${sug.mvpMeta.minus} | Œî ${sug.mvpMeta.delta}`;
      }
      if (blkHint) {
        if (!sug.bestBlock) blkHint.textContent = "Suggestion auto : aucune.";
        else blkHint.textContent = `Suggestion auto : ${sug.bestBlock.name} ‚Äî Bloc+ ${sug.bestBlockMeta.blocPlus}`;
      }
      if (atkHint) {
        if (!sug.bestAttack) atkHint.textContent = "Suggestion auto : aucune.";
        else {
          const dAtk = (sug.bestAttackMeta.attaquePlus - sug.bestAttackMeta.attaqueMinus);
          atkHint.textContent = `Suggestion auto : ${sug.bestAttack.name} ‚Äî Attaque+ ${sug.bestAttackMeta.attaquePlus} | Œî attaque ${dAtk}`;
        }
      }
      if (supHint) {
        if (!sug.bestSupport) supHint.textContent = "Suggestion auto : aucune.";
        else supHint.textContent = `Suggestion auto : ${sug.bestSupport.name} ‚Äî D√©fense+ + R√©cep+ = ${sug.bestSupportMeta.supportPlus}`;
      }
    }


/* --------- ARCHIVER MATCH + R√âSUM√âS ---------- */

    function computeMatchScoresFromSnapshot(setScoresSnapshot) {
      let ourMatchPts = 0;
      let oppMatchPts = 0;
      setScoresSnapshot = setScoresSnapshot || {};
      for (const sn in setScoresSnapshot) {
        const sc = setScoresSnapshot[sn];
        if (!sc) continue;
        ourMatchPts += sc.nous || 0;
        oppMatchPts += sc.eux || 0;
      }
      return { ourMatchPts, oppMatchPts };
    }
function computeOpponentTotalsFromSnapshot(opponentStatsSnapshot) {
  const totals = {};
  OPP_CATEGORIES.forEach(cat => {
    totals[cat] = { plus: 0, minus: 0 };
  });
  opponentStatsSnapshot = opponentStatsSnapshot || {};
  for (const sn in opponentStatsSnapshot) {
    const st = opponentStatsSnapshot[sn] || {};
    OPP_CATEGORIES.forEach(cat => {
      totals[cat].plus  += st[cat + "Plus"]  || 0;
      totals[cat].minus += st[cat + "Minus"] || 0;
    });
  }
  return totals;
}
function computeOurTeamTotalsFromSnapshot(statsSnapshot) {
  const totals = {};
  STAT_CATEGORIES.forEach(cat => {
    totals[cat] = { plus: 0, minus: 0 };
  });

  statsSnapshot = statsSnapshot || {};

  for (const pid in statsSnapshot) {
    const sets = statsSnapshot[pid] || {};
    for (const sn in sets) {
      const st = sets[sn] || {};
      STAT_CATEGORIES.forEach(cat => {
        totals[cat].plus  += st[cat + "Plus"]  || 0;
        totals[cat].minus += st[cat + "Minus"] || 0;
      });
    }
  }

  return totals;
}

    function findPlayerNameFromSnapshot(playersSnapshot, playerId) {
      if (!playerId) return "";
      const arr = playersSnapshot || [];
      const p = arr.find(pl => pl.id === playerId);
      if (!p) return "";
      return (p.number ? "#" + p.number + " " : "") + (p.name || "");
    }

    // R√©sum√© long (WhatsApp / mail)
 function buildMatchSummaryText(entry) {
  const {
    label,
    opponent,
    createdAt,
    playersSnapshot,
    statsSnapshot,
    setScoresSnapshot,
    opponentStatsSnapshot,
    mvpId,
    bestSupportId,
    bestBlockerId,
    ourTeamName,
    opponentTeamName
  } = entry;

  const dateStr = createdAt
    ? new Date(createdAt).toLocaleString("fr-FR", {
        dateStyle: "short",
        timeStyle: "short"
      })
    : "";

  const { ourMatchPts, oppMatchPts } =
    computeMatchScoresFromSnapshot(setScoresSnapshot || {});

  const nameUs =
    (ourTeamName && ourTeamName.trim()) || getOurTeamName();
  const nameOpp =
    (opponentTeamName && opponentTeamName.trim()) ||
    (opponent && opponent.trim()) ||
    getOppTeamName();

  let text = "";

  // En-t√™te du match
  text += (label || "Match") + "\n";
  if (dateStr) text += "Date : " + dateStr + "\n";
  if (nameOpp && nameOpp.trim()) {
    text += "Adversaire : " + nameOpp.trim() + "\n";
  }
  text +=
    "Score final : " +
    nameUs +
    " " +
    ourMatchPts +
    " - " +
    oppMatchPts +
    " " +
    nameOpp +
    "\n\n";

  // Score par set
  const setLines = [];
  const scoresSnap = setScoresSnapshot || {};
  for (let i = 1; i <= 5; i++) {
    const sc = scoresSnap[i];
    if (!sc) continue;
    if ((sc.nous || 0) === 0 && (sc.eux || 0) === 0) continue;
    setLines.push(
      `Set ${i} : ${nameUs} ${sc.nous || 0} - ${sc.eux || 0} ${nameOpp}`
    );
  }
  if (setLines.length > 0) {
    text +=
      "Score par set :\n" + setLines.map(l => "  ‚Ä¢ " + l).join("\n") + "\n\n";
  }

  // Stats adverses (agr√©g√©es sur tout le match)
  const oppTotals = computeOpponentTotalsFromSnapshot(opponentStatsSnapshot || {});

  text += "Statistiques de l'√©quipe adverse :\n";
  text +=
    `  ‚Ä¢ Services : ${oppTotals.service.minus} fautes / ` +
    `${oppTotals.service.plus} points directs\n`;
  text +=
    `  ‚Ä¢ Bloc : ${oppTotals.bloc.plus} points marqu√©s au bloc\n`;
  text +=
    `  ‚Ä¢ Cadeaux : ${oppTotals.cadeaux.plus} points offerts √† notre √©quipe\n`;
  text +=
    `  ‚Ä¢ Points (hors service) : ${oppTotals.points.minus} points pour nous / ` +
    `${oppTotals.points.plus} points pour eux\n\n`;

  // üî• Stats g√©n√©rales de notre √©quipe (AVANT les fiches joueur¬∑euses)
  const ourTotals = computeOurTeamTotalsFromSnapshot(statsSnapshot || {});
  const catLabels = {
    attaque:  "Attaque",
    service:  "Service",
    bloc:     "Bloc",
    reception:"R√©ception",
    defense:  "D√©fense",
    passe:    "Passe"
  };

  let teamPlus = 0;
  let teamMinus = 0;

  STAT_CATEGORIES.forEach(cat => {
    const plus  = ourTotals[cat].plus;
    const minus = ourTotals[cat].minus;
    if (POINT_CATEGORIES.includes(cat))  teamPlus  += plus;
    if (FAULT_CATEGORIES.includes(cat))  teamMinus += minus;
  });

  const teamDelta    = teamPlus - teamMinus;
  const teamDeltaStr = (teamDelta > 0 ? "+" : "") + teamDelta;

  const pctTeamPoints =
    ourMatchPts > 0 ? Math.round(100 * teamPlus / ourMatchPts) : 0;
  const pctTeamFautes =
    oppMatchPts > 0 ? Math.round(100 * teamMinus / oppMatchPts) : 0;

  text += "Statistiques g√©n√©rales de notre √©quipe :\n";
  STAT_CATEGORIES.forEach(cat => {
    const plus  = ourTotals[cat].plus;
    const minus = ourTotals[cat].minus;
    const deltaCat = plus - minus;
    const deltaCatStr = (deltaCat > 0 ? "+" : "") + deltaCat;
    const labelCat = catLabels[cat] || cat;
    text +=
      `  ‚Ä¢ ${labelCat} : ${plus} pts / ${minus} fautes (Œî ${deltaCatStr})\n`;
  });

  text +=
    `  ‚Ä¢ Total √©quipe : ${teamPlus} pts / ${teamMinus} fautes (Œî ${teamDeltaStr})\n`;
  text +=
    `  ‚Ä¢ Impact global : ${pctTeamPoints}% de nos points / ` +
    `${pctTeamFautes}% des points adverses (sur nos fautes)\n\n`;

  // Distinctions individuelles
  const mvpName     = findPlayerNameFromSnapshot(playersSnapshot, mvpId);
  const supportName = findPlayerNameFromSnapshot(playersSnapshot, bestSupportId);
  const blockerName = findPlayerNameFromSnapshot(playersSnapshot, bestBlockerId);

  if (mvpName || supportName || blockerName) {
    const parts = [];
    if (mvpName)     parts.push(`MVP : ${mvpName}`);
    if (supportName) parts.push(`Meilleur soutien : ${supportName}`);
    if (blockerName) parts.push(`Meilleur¬∑e bloqueur¬∑euse : ${blockerName}`);
    text += "Distinctions : " + parts.join(" | ") + "\n\n";
  }

  // Statistiques d√©taill√©es par joueur¬∑euse
  text += "Statistiques d√©taill√©es par joueur¬∑euse :\n";

  const ps = (playersSnapshot || []).slice().sort((a, b) =>
    (a.name || "").localeCompare(b.name || "")
  );

   ps.forEach(p => {
    const pStatsAllSets = (statsSnapshot && statsSnapshot[p.id]) || {};
    const perCat = {};
    STAT_CATEGORIES.forEach(cat => {
      perCat[cat] = { plus: 0, minus: 0 };
    });

    // cumul sur tous les sets pour cette joueur¬∑euse
    for (const sn in pStatsAllSets) {
      const st = pStatsAllSets[sn] || {};
      STAT_CATEGORIES.forEach(cat => {
        perCat[cat].plus  += st[cat + "Plus"]  || 0;
        perCat[cat].minus += st[cat + "Minus"] || 0;
      });
    }

    let plusMatch = 0;
    let minusMatch = 0;
    POINT_CATEGORIES.forEach(cat => {
      plusMatch  += perCat[cat].plus;
    });
    FAULT_CATEGORIES.forEach(cat => {
      minusMatch += perCat[cat].minus;
    });

    // ‚ö†Ô∏è si la joueur¬∑euse n'a ni point ni faute ‚Üí on NE L'AFFICHE PAS
    if (plusMatch === 0 && minusMatch === 0) {
      return; // on passe √† la suivante
    }

    const delta = plusMatch - minusMatch;
    const deltaStr = (delta > 0 ? "+" : "") + delta;

    const pctMatchPoints =
      ourMatchPts > 0 ? Math.round((100 * plusMatch) / ourMatchPts) : 0;
    const pctMatchFautes =
      oppMatchPts > 0 ? Math.round((100 * minusMatch) / oppMatchPts) : 0;

    const header =
      (p.number ? "#" + p.number + " " : "") + (p.name || "Sans nom");

    text += `\n- ${header}\n`;

    // d√©tail par secteur
    STAT_CATEGORIES.forEach(cat => {
      const plus  = perCat[cat].plus;
      const minus = perCat[cat].minus;
      const deltaCat = plus - minus;
      const deltaCatStr = (deltaCat > 0 ? "+" : "") + deltaCat;
      const labelCat = catLabels[cat] || cat;
      text +=
        `    ${labelCat} : ${plus} pts / ${minus} fautes (Œî ${deltaCatStr})\n`;
    });

    text +=
      `    Total : ${plusMatch} pts / ${minusMatch} fautes (Œî ${deltaStr})\n`;
    text +=
      `    Impact match : ${pctMatchPoints}% de nos points / ` +
      `${pctMatchFautes}% de leurs points\n`;
  });


  text += "\nFin du rapport.";
  return text.trim();
}



    // R√©sum√© court WhatsApp (1 ligne par joueur¬∑euse)
    function buildMatchShortSummaryText(entry) {
      const {
        label,
        opponent,
        playersSnapshot,
        statsSnapshot,
        setScoresSnapshot,
        mvpId,
        bestSupportId,
        bestBlockerId,
        ourTeamName,
        opponentTeamName
      } = entry;

      const { ourMatchPts, oppMatchPts } =
        computeMatchScoresFromSnapshot(setScoresSnapshot || {});

      const nameUs =
        (ourTeamName && ourTeamName.trim()) || getOurTeamName();
      const nameOpp =
        (opponentTeamName && opponentTeamName.trim()) ||
        (opponent && opponent.trim()) ||
        getOppTeamName();

      let txt = "";
      txt +=
        (label || "Match") +
        " ‚Äì Score : " +
        nameUs +
        " " +
        ourMatchPts +
        " - " +
        oppMatchPts +
        " " +
        nameOpp +
        "\n";
      if (nameOpp && nameOpp.trim()) {
        txt += "Adversaire : " + nameOpp.trim() + "\n";
      }

      const mvpName     = findPlayerNameFromSnapshot(playersSnapshot, mvpId);
      const supportName = findPlayerNameFromSnapshot(playersSnapshot, bestSupportId);
      const blockerName = findPlayerNameFromSnapshot(playersSnapshot, bestBlockerId);

      if (mvpName || supportName || blockerName) {
        const parts = [];
        if (mvpName)     parts.push(`MVP : ${mvpName}`);
        if (supportName) parts.push(`Meilleur soutien : ${supportName}`);
        if (blockerName) parts.push(`Meilleur¬∑e bloqueur¬∑euse : ${blockerName}`);
        txt += "\nDistinctions : " + parts.join(" | ") + "\n";
      }

      txt += "\nBilan rapide :\n";

      const ps = (playersSnapshot || []).slice().sort((a, b) =>
        (a.name || "").localeCompare(b.name || "")
      );

      ps.forEach(p => {
        const pStatsAllSets = (statsSnapshot && statsSnapshot[p.id]) || {};
        let plusMatch = 0;
        let minusMatch = 0;

        for (const sn in pStatsAllSets) {
          const st = pStatsAllSets[sn];
          FAULT_CATEGORIES.forEach(cat => {
            minusMatch += st[cat + "Minus"] || 0;
          });
          POINT_CATEGORIES.forEach(cat => {
            plusMatch += st[cat + "Plus"] || 0;
          });
        }

        const delta = plusMatch - minusMatch;
        const deltaStr = (delta > 0 ? "+" : "") + delta;

        const header =
          (p.number ? "#" + p.number + " " : "") + (p.name || "Sans nom");

        txt += `- ${header} : ${plusMatch} pts / ${minusMatch} fautes (Œî ${deltaStr})\n`;
      });

      return txt.trim();
    }

    function resetMatchData() {
      stats = {};
      setScores = {};
      opponentStats = {};
      saveStats();
      saveSetScores();
      saveOpponentStats();
      setCurrentSet(1);
  if (typeof initDiagnosticsToggle === 'function') initDiagnosticsToggle();
      renderSetScore();
      renderOpponentStats();
      renderDashboard();
    }

    function archiveCurrentMatch() {
      const hasAnyScore = Object.values(setScores || {}).some(
        sc => (sc.nous || 0) > 0 || (sc.eux || 0) > 0
      );
      const hasAnyStats = Object.keys(stats || {}).length > 0;
      if (!hasAnyScore && !hasAnyStats) {
        if (!confirm("Aucune donn√©e ou presque pour ce match. L‚Äôarchiver quand m√™me ?")) {
          return;
        }
      }

      const defaultLabel = "Match " + new Date().toLocaleDateString("fr-FR");
      const label = prompt(
        "Nom du match (ex : Entra√Ænement du jeudi, Tournoi X) :",
        defaultLabel
      );
      if (label === null) return;

      const opponent = prompt(
        "Nom de l‚Äôadversaire (optionnel) :",
        getOppTeamName()
      );
      const createdAt = new Date().toISOString();

      const mvpSelect     = document.getElementById("select-mvp");
      const supportSelect = document.getElementById("select-best-support");
      const blockSelect   = document.getElementById("select-best-block");

      const mvpId         = mvpSelect ? (mvpSelect.value || "") : "";
      const bestSupportId = supportSelect ? (supportSelect.value || "") : "";
      const bestBlockerId = blockSelect ? (blockSelect.value || "") : "";

      if (opponent !== null) {
        teamNames.opp = (opponent || "").trim();
        saveTeamNames();
      }

      const ourNameNow = getOurTeamName();
      const oppNameNow = getOppTeamName();

      const entry = {
        id: "m_" + Date.now() + "_" + Math.random().toString(16).slice(2),
        createdAt,
        label: (label || "").trim(),
        opponent: (opponent || "").trim(),
        ourTeamName: ourNameNow,
        opponentTeamName: oppNameNow,
        playersSnapshot: deepClone(players),
        statsSnapshot: deepClone(stats),
        setScoresSnapshot: deepClone(setScores),
        opponentStatsSnapshot: deepClone(opponentStats),
        mvpId,
        bestSupportId,
        bestBlockerId
      };

      entry.summaryText = buildMatchSummaryText(entry);
      entry.shortSummaryText = buildMatchShortSummaryText(entry);

      historyMatches.push(entry);
      saveHistory();

      resetMatchData();
      alert(
        "Match archiv√© dans l‚Äôhistorique. Tu peux le partager depuis l‚Äôonglet Historique."
      );
      renderHistory();
    }

    /* --------- HISTORIQUE UI ---------- */
    function renderHistory() {
      const listDiv = document.getElementById("history-list");
      if (!listDiv) return;
      listDiv.innerHTML = "";

      if (!historyMatches || historyMatches.length === 0) {
        listDiv.innerHTML = "<p>Aucun match archiv√© pour l‚Äôinstant.</p>";
        return;
      }

      const ordered = historyMatches.slice().sort((a, b) => {
        return (b.createdAt || "").localeCompare(a.createdAt || "");
      });

      ordered.forEach(entry => {
        if (!entry.shortSummaryText) {
          entry.shortSummaryText = buildMatchShortSummaryText(entry);
          saveHistory();
        }

        const {
          id,
          label,
          opponent,
          createdAt,
          setScoresSnapshot,
          summaryText,
          shortSummaryText,
          ourTeamName,
          opponentTeamName
        } = entry;

        const { ourMatchPts, oppMatchPts } =
          computeMatchScoresFromSnapshot(setScoresSnapshot || {});

        const nameUs = (ourTeamName && ourTeamName.trim())
          ? ourTeamName.trim()
          : getOurTeamName();
        const nameOpp = (opponentTeamName && opponentTeamName.trim())
          ? opponentTeamName.trim()
          : (opponent && opponent.trim()) || getOppTeamName();

        const item = document.createElement("div");
        item.className = "history-item";
        item.dataset.id = id;

        const header = document.createElement("div");
        header.className = "history-header";

        const titleEl = document.createElement("h3");
        titleEl.textContent = label || "Match sans nom";

        const scoreSpan = document.createElement("span");
        scoreSpan.className = "history-score";
        scoreSpan.textContent =
          `${nameUs} ${ourMatchPts} ‚Äì ${oppMatchPts} ${nameOpp}`;

        header.appendChild(titleEl);
        header.appendChild(scoreSpan);

        const meta = document.createElement("div");
        meta.className = "history-meta";
        const dateStr = createdAt
          ? new Date(createdAt).toLocaleString("fr-FR", {
              dateStyle: "short",
              timeStyle: "short"
            })
          : "";
        const opponentLabel = (nameOpp && nameOpp.trim())
          ? ` ¬∑ Adversaire : ${nameOpp.trim()}`
          : "";
        meta.textContent =
          `${dateStr ? "Date : " + dateStr : ""}${opponentLabel}`;

        const btnToggle = document.createElement("button");
        btnToggle.className = "btn-history-toggle";
        btnToggle.textContent = "Voir / cacher les r√©sum√©s";
        btnToggle.dataset.id = id;

        const btnDelete = document.createElement("button");
        btnDelete.className = "btn-history-delete";
        btnDelete.textContent = "Supprimer";
        btnDelete.dataset.id = id;

        const btnPrint = document.createElement("button");
        btnPrint.className = "btn-history-print";
        btnPrint.textContent = "Imprimer / PDF";
        btnPrint.dataset.id = id;

        const btnShare = document.createElement("button");
        btnShare.className = "btn-history-share";
        btnShare.textContent = "Partager";
        btnShare.dataset.id = id;

        const btnWA = document.createElement("button");
        btnWA.className = "btn-history-wa";
        btnWA.textContent = "WhatsApp";
        btnWA.dataset.id = id;

        const btnTG = document.createElement("button");
        btnTG.className = "btn-history-tg";
        btnTG.textContent = "Telegram";
        btnTG.dataset.id = id;

        const actions = document.createElement("div");
        actions.className = "history-actions";
        actions.appendChild(btnToggle);
        actions.appendChild(btnPrint);
        actions.appendChild(btnShare);
        actions.appendChild(btnWA);
        actions.appendChild(btnTG);
        actions.appendChild(btnDelete);

        const body = document.createElement("div");
        body.className = "history-body";
        body.style.display = "none";

        const labelLong = document.createElement("div");
        labelLong.style.fontSize = "12px";
        labelLong.style.marginBottom = "2px";
        labelLong.textContent = "R√©sum√© d√©taill√© :";

        const textareaLong = document.createElement("textarea");
        textareaLong.readOnly = true;
        textareaLong.className = "history-text-long";
        textareaLong.value = summaryText || entry.summaryText || "";

        const previewLong = document.createElement("div");
        previewLong.className = "report-preview";
        previewLong.innerHTML = (textareaLong.value || "").trim() ? prettyReportHTML(textareaLong.value) : "";

        const btnCopyLong = document.createElement("button");
        btnCopyLong.className = "btn-history-copy";
        btnCopyLong.textContent = "Copier le r√©sum√© d√©taill√©";
        btnCopyLong.dataset.id = id;
        btnCopyLong.dataset.type = "long";

        const labelShortEl = document.createElement("div");
        labelShortEl.style.fontSize = "12px";
        labelShortEl.style.margin = "8px 0 2px";
        labelShortEl.textContent = "R√©sum√© court :";

        const textareaShort = document.createElement("textarea");
        textareaShort.readOnly = true;
        textareaShort.className = "history-text-short";
        textareaShort.value = shortSummaryText || entry.shortSummaryText || "";

        const previewShort = document.createElement("div");
        previewShort.className = "report-preview";
        previewShort.innerHTML = (textareaShort.value || "").trim() ? prettyReportHTML(textareaShort.value) : "";

        const btnCopyShort = document.createElement("button");
        btnCopyShort.className = "btn-history-copy";
        btnCopyShort.textContent = "Copier le r√©sum√© court";
        btnCopyShort.dataset.id = id;
        btnCopyShort.dataset.type = "short";

        body.appendChild(labelLong);
        body.appendChild(previewLong);
        body.appendChild(textareaLong);
        body.appendChild(btnCopyLong);
        body.appendChild(labelShortEl);
        body.appendChild(previewShort);
        body.appendChild(textareaShort);
        body.appendChild(btnCopyShort);

        item.appendChild(header);
        item.appendChild(meta);
        item.appendChild(actions);
        item.appendChild(body);

        listDiv.appendChild(item);
      });
    }

    function initHistoryEvents() {
      const listDiv = document.getElementById("history-list");
      if (!listDiv) return;

      listDiv.addEventListener("click", function (e) {
        const btnToggle = e.target.closest(".btn-history-toggle");
        const btnDelete = e.target.closest(".btn-history-delete");
        const btnCopy   = e.target.closest(".btn-history-copy");
        const btnPrint  = e.target.closest(".btn-history-print");
        const btnShare  = e.target.closest(".btn-history-share");
        const btnWA     = e.target.closest(".btn-history-wa");
        const btnTG     = e.target.closest(".btn-history-tg");

        if (btnToggle) {
          const id = btnToggle.dataset.id;
          const item = listDiv.querySelector(`.history-item[data-id="${id}"]`);
          if (!item) return;
          const body = item.querySelector(".history-body");
          if (!body) return;
          const shown = body.style.display !== "none";
          body.style.display = shown ? "none" : "block";
        }

        if (btnDelete) {
          const id = btnDelete.dataset.id;
          if (!confirm("Supprimer d√©finitivement ce match de l‚Äôhistorique ?")) return;
          historyMatches = historyMatches.filter(m => m.id !== id);
          saveHistory();
          renderHistory();
        }

        if (btnCopy) {
          const id = btnCopy.dataset.id;
          const type = btnCopy.dataset.type || "long";
          const item = listDiv.querySelector(`.history-item[data-id="${id}"]`);
          if (!item) return;
          const textarea = item.querySelector(
            type === "short" ? ".history-text-short" : ".history-text-long"
          );
          if (!textarea) return;
          const text = textarea.value || "";
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(
              () => alert("R√©sum√© copi√©. Tu peux le coller dans WhatsApp."),
              () => fallbackCopy(textarea)
            );
          } else {
            fallbackCopy(textarea);
          }
        }

        if (btnPrint) {
          const id = btnPrint.dataset.id;
          const entry = historyMatches.find(m => m.id === id);
          if (!entry) return;
          openPrintableMatchReport(entry);
        }

        if (btnShare) {
          const id = btnShare.dataset.id;
          const entry = historyMatches.find(m => m.id === id);
          if (!entry) return;
          const txt =
            entry.summaryText && entry.summaryText.trim()
              ? entry.summaryText
              : buildMatchSummaryText(entry);
          shareTextSmart("Stat2Match ‚Äì Rapport de match", txt, "Rapport copi√© ‚úÖ");
        }

        if (btnWA) {
          const id = btnWA.dataset.id;
          const entry = historyMatches.find(m => m.id === id);
          if (!entry) return;
          const txt =
            entry.summaryText && entry.summaryText.trim()
              ? entry.summaryText
              : buildMatchSummaryText(entry);
          openShareWhatsApp(txt);
        }

        if (btnTG) {
          const id = btnTG.dataset.id;
          const entry = historyMatches.find(m => m.id === id);
          if (!entry) return;
          const txt =
            entry.summaryText && entry.summaryText.trim()
              ? entry.summaryText
              : buildMatchSummaryText(entry);
          openShareTelegram(txt);
        }
      });
    }

    function openPrintableMatchReport(entry) {
      const fullText =
        entry.summaryText && entry.summaryText.trim()
          ? entry.summaryText
          : buildMatchSummaryText(entry);

      const createdAt = entry.createdAt || entry.date || "";
      const dateStr = createdAt
        ? new Date(createdAt).toLocaleString("fr-FR", { dateStyle: "short", timeStyle: "short" })
        : "";

      const setScoresSnapshot = entry.setScoresSnapshot || entry.setScores || entry.scores || {};
      const score = computeMatchScoresFromSnapshot(setScoresSnapshot || {});
      const nameUs  = (entry.teamNameUs || entry.nameUs || entry.teamUs || "Nous");
      const nameOpp = (entry.teamNameOpp || entry.nameOpp || entry.opponent || "Adversaire");

      const meta = `${nameUs} ${score.ourMatchPts ?? 0} ‚Äì ${score.oppMatchPts ?? 0} ${nameOpp}${dateStr ? " ¬∑ " + dateStr : ""}`;

      openPrintableTextPage("Stat2Match ‚Äì Rapport de match", meta, fullText);
    }

/* --------- formulaire joueur ---------- */
const playerForm = document.getElementById("player-form");
if (playerForm) playerForm.addEventListener("submit", function (e) {
  e.preventDefault();

  const id = document.getElementById("player-id").value || null;
  const name = document.getElementById("player-name").value.trim();
  const number = document.getElementById("player-number").value.trim();
  const license = document.getElementById("player-license").value.trim();
  const role = document.getElementById("player-role").value;
  const color = document.getElementById("player-color").value;
  const inMatch = document.getElementById("player-in-match").checked;

  if (!name) {
    alert("Nom obligatoire");
    return;
  }

  if (id) {
    // √©dition d'une joueur¬∑euse existante
    const p = players.find((x) => x.id === id);
    if (p) {
      p.name = name;
      p.number = number;
      p.role = role;
      p.color = color;
      p.license = license;
      p.inMatch = inMatch;
    }
  } else {
    // cr√©ation d'une nouvelle joueur¬∑euse
    const newPlayer = {
      id: "p_" + Date.now() + "_" + Math.random().toString(16).slice(2),
      name,
      number,
      license,
      role,
      color,
      inMatch: inMatch
    };
    players.push(newPlayer);
  }

  savePlayers();
  renderRoster(); // remet √† jour la liste, le banc, les s√©lecteurs

  // remise √† z√©ro du formulaire
  this.reset();
  document.getElementById("player-id").value = "";
  document.getElementById("player-in-match").checked = true;
});



    /* --------- boutons vue effectif / dashboard / historique ---------- */
    document.addEventListener("DOMContentLoaded", ()=>{
  const __btr = document.getElementById("btn-toggle-roster");
  if (!__btr) return;
  __btr.addEventListener("click", function(){
      const roster = document.getElementById("roster");
      const hidden = roster.style.display === "none" || roster.style.display === "";
      roster.style.display = hidden ? "block" : "none";
      this.textContent = hidden ? "Masquer l'effectif" : "G√©rer l'effectif";
    });
});

const btnValidateRoster = document.getElementById("btn-validate-match-roster");
if (btnValidateRoster) {
  btnValidateRoster.addEventListener("click", function () {
    refreshPositionSelects();
    renderBench();
    refreshAwardsSelectors();
    alert("Effectif du match mis √† jour.");
  });
}

    
document.addEventListener("DOMContentLoaded", ()=>{
  const __bx = document.getElementById("btn-diagnostics");
  if (!__bx) return;
  __bx.addEventListener("click", ()=>{
    try {
      const isStatsVisible = (document.getElementById("stats-container") && document.getElementById("stats-container").style.display === "block");
      const pickFallbackPlayerId = ()=>{
        const list = (players || []).filter(p=>p && p.id && p.name && (p.inMatch !== false));
        return list.length ? list[0].id : null;
      };
      const targetId = (typeof currentStatsPlayerId !== "undefined" && currentStatsPlayerId) ? currentStatsPlayerId : pickFallbackPlayerId();

      if (!isStatsVisible) {
        if (targetId && typeof openPlayerStats === "function") {
          openPlayerStats(targetId);
        } else {
          document.getElementById("main-view").style.display = "none";
          document.getElementById("history-container").style.display = "none";
          document.getElementById("dashboard-container").style.display = "block";
          if (typeof renderDashboard === "function") renderDashboard();
          return;
        }
      }

      // Ensure DOM is ready then open + scroll Diagnostics (so user actually sees it)
      setTimeout(()=>{
        try{
          if (typeof initDiagnosticsToggle === "function") if (typeof initDiagnosticsToggle === 'function') initDiagnosticsToggle();

          const btn = document.getElementById("btn-toggle-diagnostics");
          const box = document.getElementById("player-diagnostics");

          // If panel exists but is still empty, render once (safe)
          if (box && typeof renderPlayerDiagnostics === "function") {
            const empty = !box.innerHTML || !box.innerHTML.trim();
            if (empty) {
              const pid = (typeof currentStatsPlayerId !== "undefined" && currentStatsPlayerId) ? currentStatsPlayerId : targetId;
              if (pid) renderPlayerDiagnostics(pid);
            }
          }

          if (btn && box) {
            const isOpen = (box.style.display !== "none" && !box.classList.contains("is-collapsed"));
            if (!isOpen) btn.click();

            // Scroll into view (the #1 reason people think it's 'not there')
            setTimeout(()=>{
              try{
                if (box.style.display !== "none") box.scrollIntoView({behavior:"smooth", block:"start"});
              }catch(e){}
            }, 80);
          } else if (box) {
            // Fallback (shouldn't happen): force open
            box.style.display = "block";
            box.classList.remove("is-collapsed");
            try{ box.scrollIntoView({behavior:"smooth", block:"start"}); }catch(e){}
          }
        }catch(e){
          console.warn("Diagnostics open error:", e);
        }
      }, 0);
    } catch(e) {
      console.warn("Diagnostics button error:", e);
    }
  });
});


document.addEventListener("DOMContentLoaded", ()=>{
  const __bd = document.getElementById("btn-dashboard");
  if (!__bd) return;
  __bd.addEventListener("click", function(){
      document.getElementById("main-view").style.display = "none";
      document.getElementById("stats-container").style.display = "none";
      document.getElementById("history-container").style.display = "none";
      document.getElementById("dashboard-container").style.display = "block";
      renderDashboard();
    });
});

    const btnBackDash = document.getElementById("btn-back-from-dashboard");
    if (btnBackDash) {
      btnBackDash.onclick = () => {
        document.getElementById("dashboard-container").style.display = "none";
        document.getElementById("main-view").style.display = "block";
      };
    }

  // Boutons Tableau de bord (export)
  const btnDashPrint = document.getElementById("btn-dashboard-print");
  const btnDashShare = document.getElementById("btn-dashboard-share");
  const btnDashCopy  = document.getElementById("btn-dashboard-copy");
  const btnDashWA    = document.getElementById("btn-dashboard-wa");
  const btnDashTG    = document.getElementById("btn-dashboard-tg");

  if (btnDashPrint) btnDashPrint.onclick = printDashboardNow;
  if (btnDashShare) btnDashShare.onclick = shareDashboardNow;
  if (btnDashCopy)  btnDashCopy.onclick  = copyDashboardNow;
  if (btnDashWA)    btnDashWA.onclick    = shareDashboardWhatsApp;
  if (btnDashTG)    btnDashTG.onclick    = shareDashboardTelegram;


// Match I/O (save/import)
const btnDashSaveMatch = document.getElementById("btn-dashboard-save-match");
const btnDashLoadMatch = document.getElementById("btn-dashboard-load-match");
const fileImportMatch  = document.getElementById("file-import-match");

if (btnDashSaveMatch) btnDashSaveMatch.onclick = () => {
  const snap = buildMatchSnapshot();
  const txt = safeJSONStringify(snap);
  openMatchIOModal(txt);
};

if (btnDashLoadMatch) btnDashLoadMatch.onclick = () => openMatchIOModal("");

// Modal actions
const matchioClose = document.getElementById("matchio-close");
const matchioPick  = document.getElementById("matchio-pickfile");
const matchioImport= document.getElementById("matchio-import");
const matchioCopy  = document.getElementById("matchio-copy");
const matchioDown  = document.getElementById("matchio-download");

if (matchioClose) matchioClose.onclick = closeMatchIOModal;

if (matchioPick) matchioPick.onclick = () => {
  if (fileImportMatch) fileImportMatch.click();
};

if (fileImportMatch) fileImportMatch.addEventListener("change", async (e) => {
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  try {
    const txt = await f.text();
    const ta = document.getElementById("matchio-text");
    if (ta) ta.value = txt;
  } catch(err) {}
  // reset pour permettre re-choisir le m√™me fichier
  e.target.value = "";
});

if (matchioImport) matchioImport.onclick = () => {
  const ta = document.getElementById("matchio-text");
  const txt = (ta && ta.value) ? ta.value : "";
  try{
    importMatchSnapshotFromText(txt);
    closeMatchIOModal();
    alert("Match import√© ‚úÖ Tu peux continuer la saisie.");
  }catch(err){
    alert(err.message || "Import impossible.");
  }
};

if (matchioCopy) matchioCopy.onclick = () => {
  const ta = document.getElementById("matchio-text");
  const txt = (ta && ta.value) ? ta.value : "";
  copyTextToClipboard(txt);
};

if (matchioDown) matchioDown.onclick = () => {
  const ta = document.getElementById("matchio-text");
  const txt = (ta && ta.value) ? ta.value : "";
  const name = (getOurTeamName().replace(/\s+/g,'_') || "Stat2Match") + "_" + new Date().toISOString().slice(0,10) + ".json";
  downloadTextFile(name, txt || safeJSONStringify(buildMatchSnapshot()));
};

      // Bouton Historique
    document.addEventListener("DOMContentLoaded", ()=>{
  const __bh = document.getElementById("btn-history");
  if (!__bh) return;
  __bh.addEventListener("click", function(){
      document.getElementById("main-view").style.display = "none";
      document.getElementById("stats-container").style.display = "none";
      document.getElementById("dashboard-container").style.display = "none";
      document.getElementById("help-container").style.display = "none";
      document.getElementById("history-container").style.display = "block";
      renderHistory();
    });
});

     // Bouton Tutoriel / Aide
  const btnHelp = document.getElementById("btn-help");
  if (btnHelp) {
    btnHelp.addEventListener("click", function() {
      document.getElementById("main-view").style.display = "none";
      document.getElementById("stats-container").style.display = "none";
      document.getElementById("dashboard-container").style.display = "none";
      document.getElementById("history-container").style.display = "none";
      document.getElementById("help-container").style.display = "block";
    });
  }

  const btnHelpBack = document.getElementById("btn-back-from-help");
  if (btnHelpBack) {
    btnHelpBack.onclick = () => {
      document.getElementById("help-container").style.display = "none";
      document.getElementById("main-view").style.display = "block";
    };
  }

  // Bouton "Retour au terrain" depuis l'historique
  function goBackFromHistory() {
    document.getElementById("history-container").style.display = "none";
    document.getElementById("main-view").style.display = "block";
  }

  const btnHistoryTop = document.getElementById("btn-back-from-history");
  if (btnHistoryTop) btnHistoryTop.onclick = goBackFromHistory;

  const btnHistoryBottom = document.getElementById("btn-back-from-history-bottom");
  if (btnHistoryBottom) btnHistoryBottom.onclick = goBackFromHistory;

  // Bouton "Cl√¥turer ce match" (tableau de bord)
  const btnCloseMatch = document.getElementById("btn-close-match");
  if (btnCloseMatch) {
    btnCloseMatch.addEventListener("click", archiveCurrentMatch);
  }

  /* --------- init globale ---------- */
/* ===== INIT (centralis√©) ===== */
function initAll() {
  // (Legacy) Initialisation centralis√©e d√©sactiv√©e : le boot est fait en bas de page.
  // L‚Äôimport match fait d√©sormais un reload propre apr√®s √©criture du snapshot.
}

function bootApp() {
loadPlayers();
  loadStats();
  loadSetScores();
  loadOpponentStats();
  loadHistory();
  loadTeamNames();



// ===== Pro (match pro) : √©tat + contr√¥les + actions sur tuiles =====
loadProState();
loadPointUndoStack();
fillLiberoSelect();
initProControls();       // listeners
initProActionOverlay();  // legacy overlay (garde)
renderProControlsUI();
ensureProActionPads();
wireProActionPadDelegation();
// ================================================================

  renderRoster();
  applyCourtFromStorage();      // r√©injecte la compo sauvegard√©e (si elle existe)
  initSetButtonsMain();
  initSetButtonsStats();
  initSetButtonsDashboard();
  initStatsControls();
  initScoreControls();
  initOpponentControls();
  initOpponentPointPanel();
  initOpponentFaultPanel();
  initOpponentPanelsToggle();
  initHistoryEvents();
  setCurrentSet(1);
  updateTeamNamesUI();

  // √©couteurs sur les champs de noms d‚Äô√©quipe
  const inpOurTeam = document.getElementById("team-name-input");
  const inpOppTeam = document.getElementById("opponent-name-input");

  if (inpOurTeam) {
    inpOurTeam.addEventListener("change", function() {
      teamNames.our = this.value.trim();
      saveTeamNames();
      updateTeamNamesUI();
    });
  }

  if (inpOppTeam) {
    inpOppTeam.addEventListener("change", function() {
      teamNames.opp = this.value.trim();
      saveTeamNames();
      updateTeamNamesUI();
    });
  }

  const btnExportConfig = document.getElementById("btn-export-config");
  if (btnExportConfig) {
    btnExportConfig.addEventListener("click", exportConfigToTextarea);
  }

  const btnImportConfig = document.getElementById("btn-import-config");
  if (btnImportConfig) {
    btnImportConfig.addEventListener("click", importConfigFromTextarea);
  }
const btnRotateCourt = document.getElementById("btn-rotate-court");
if (btnRotateCourt) {
  btnRotateCourt.addEventListener("click", function () {
    rotateCourtClockwise();
  });
}
const btnRotateCourtCCW = document.getElementById("btn-rotate-court-ccw");
if (btnRotateCourtCCW) {
  btnRotateCourtCCW.addEventListener("click", function () {
    rotateCourtCounterClockwise();
  });
}

  // Mode rallye : boutons d'action
  document.querySelectorAll(".rally-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const cat = btn.dataset.skill;
      const outcome = btn.dataset.outcome;
      openRallyOverlay(cat, outcome);
    });
  });

  // Fermeture overlay rallye
  const rallyOverlay = document.getElementById("rally-overlay");
  const rallyBackdrop = document.getElementById("rally-overlay-backdrop");
  const rallyCloseBtn = document.getElementById("rally-close-btn");

  // Wiring rally overlay (close + drag) ‚Äì robust
  initRallyOverlayWiring();
  // S√©curit√© : si le bouton de fin de rallye est cr√©√© apr√®s ce script,
   // on capte le clic au niveau du document.
   document.addEventListener("click", function(e) {
     const target = e.target;
    if (!target) return;
    if (target.id === "rally-close-btn" ||
        (typeof target.closest === "function" && target.closest("#rally-close-btn"))) {
       e.preventDefault();
       closeRallyOverlay();
     }
   });
 


}

function showFatalError(err){
  console.error(err);
  const msg = (err && (err.message || String(err))) ? (err.message || String(err)) : "Erreur inconnue";
  alert("Erreur JS : " + msg + "\n\nAstuce: ouvre la console (F12) pour voir le d√©tail.");
}

document.addEventListener("DOMContentLoaded", () => {
  try {
    bootApp();
  } catch (err) {
    showFatalError(err);
  }
});
/* ===== Dashboard export + distinctions auto (v2) ===== */
function getPlayerMatchAgg(playerId) {
  // Agr√®ge sur le set courant uniquement (pour le tableau de bord).
  const s = getPlayerSetStats(playerId, currentSet) || {};
  const plus =
    (s.attaquePlus||0)+(s.servicePlus||0)+(s.blocPlus||0)+(s.receptionPlus||0)+
    (s.defensePlus||0)+(s.passePlus||0);
  const minus =
    (s.attaqueMinus||0)+(s.serviceMinus||0)+(s.blocMinus||0)+(s.receptionMinus||0)+
    (s.defenseMinus||0)+(s.passeMinus||0);
  return { plus, minus, delta: plus - minus, s };
}

function suggestAwardsFromCurrentSet() {
  const onMatchPlayers = players.filter(p => p && p.id);
  let bestSupport = null;
  let bestSupportScore = -1;

  let bestMVP = null;
  let bestMVPPlus = -1;

  let bestBlocker = null;
  let bestBlockPts = -1;

  onMatchPlayers.forEach(p => {
    const { plus, delta, s } = getPlayerMatchAgg(p.id);

    // Meilleur soutien = defenses+ + recep+ (positives)
    const supportScore = (s.defensePlus||0) + (s.receptionPlus||0);
    if (supportScore > bestSupportScore) {
      bestSupportScore = supportScore;
      bestSupport = p;
    }

    // MVP = plus le + de +, delta doit √™tre positif
    if (delta > 0) {
      if (plus > bestMVPPlus) {
        bestMVPPlus = plus;
        bestMVP = p;
      }
    }

    // Meilleur bloqueur
    const b = (s.blocPlus||0);
    if (b > bestBlockPts) {
      bestBlockPts = b;
      bestBlocker = p;
    }
  });

  return {
    bestSupport,
    bestSupportScore,
    bestMVP,
    bestMVPPlus,
    bestBlocker,
    bestBlockPts
  };
}

function applyAwardsAutofill() {
  const mvpSelect = document.getElementById("select-mvp");
  const supportSelect = document.getElementById("select-best-support");
  const blockSelect = document.getElementById("select-best-block");
  const mvpHint = document.getElementById("mvp-suggestion");
  const supportHint = document.getElementById("support-suggestion");
  const blockHint = document.getElementById("block-suggestion");

  if (!mvpSelect && !supportSelect && !blockSelect) return;

  // s'assure que les options existent
  if (typeof refreshAwardsSelectors === "function") {
    refreshAwardsSelectors();
  }

  const sug = suggestAwardsFromCurrentSet();

  if (sug.bestMVP && mvpSelect && !mvpSelect.value) {
    mvpSelect.value = sug.bestMVP.id;
  }
  if (sug.bestSupport && supportSelect && !supportSelect.value) {
    supportSelect.value = sug.bestSupport.id;
  }
  if (sug.bestBlocker && blockSelect && !blockSelect.value) {
    blockSelect.value = sug.bestBlocker.id;
  }

  function fmtPlayer(p){
    if (!p) return "‚Äî";
    return (p.number ? "#"+p.number+" " : "") + (p.name||"");
  }

  if (mvpHint) {
    if (sug.bestMVP) mvpHint.textContent = `Suggestion auto : ${fmtPlayer(sug.bestMVP)} ‚Äî Actions + : ${sug.bestMVPPlus} (Œî positif obligatoire)`;
    else mvpHint.textContent = "Suggestion auto : ‚Äî (aucune joueur¬∑euse avec Œî positif pour l‚Äôinstant)";
  }
  if (blockHint) {
    blockHint.textContent = `Suggestion auto : ${fmtPlayer(sug.bestBlocker)} ‚Äî Bloc + : ${sug.bestBlockPts}`;
  }
  if (supportHint) {
    supportHint.textContent = `Suggestion auto : ${fmtPlayer(sug.bestSupport)} ‚Äî D√©fense+ ${((sug.bestSupport && getPlayerSetStats(sug.bestSupport.id,currentSet).defensePlus)||0)} + R√©cep+ ${((sug.bestSupport && getPlayerSetStats(sug.bestSupport.id,currentSet).receptionPlus)||0)} = ${sug.bestSupportScore}`;
  }
}

function buildDashboardShareText(setNum) {
  // Texte lisible (storytelling) + impact + distinctions.
  const teamName = (document.getElementById("team-name")?.value || document.getElementById("dash-team-name-us")?.innerText || "Nous").trim() || "Nous";
  const oppName = (typeof getOppTeamName === "function" ? getOppTeamName() : (document.getElementById("opp-name")?.value || document.getElementById("dash-team-name-opponent")?.innerText || "Adversaire")).trim() || "Adversaire";

  const scoreLabel = document.getElementById("dash-score-set-label")?.innerText?.trim() || `Set ${setNum}`;
  const scoreUsTxt = document.getElementById("dash-score-nous")?.innerText?.trim() || "0";
  const scoreThemTxt = document.getElementById("dash-score-eux")?.innerText?.trim() || "0";
  const scoreLine = document.getElementById("dash-score-line")?.innerText?.trim() || "";

  const toInt = (x) => {
    const n = parseInt(String(x||"0").replace(/[^\d-]/g,""), 10);
    return isFinite(n) ? n : 0;
  };
  const scoreUs = toInt(scoreUsTxt);
  const scoreThem = toInt(scoreThemTxt);
  const diff = scoreUs - scoreThem;
  const diffStr = diff === 0 ? "√©galit√©" : (diff > 0 ? `+${diff}` : `${diff}`);

  // "Lecture coach" (6x6: on s'appuie sur le commentaire + le r√©sum√© highlights)
  const dashComment = (document.getElementById("dash-comment")?.innerText || "").trim();
  const highlights = (document.getElementById("dash-highlights-body")?.innerText || "").trim();

  // Stats adverses (d√©j√† calcul√©es dans la dashboard)
  const oppSF = document.getElementById("dash-opp-service-fautes")?.innerText || "0";
  const oppSP = document.getElementById("dash-opp-service-points")?.innerText || "0";
  const oppBP = document.getElementById("dash-opp-bloc-points")?.innerText || "0";
  const oppGifts = document.getElementById("dash-opp-cadeaux")?.innerText || "0";
  const oppPNous = document.getElementById("dash-opp-points-pourNous")?.innerText || "0";
  const oppPEux = document.getElementById("dash-opp-points-pourEux")?.innerText || "0";

  const ourPos = document.getElementById("dash-our-pos")?.innerText || "0";
  const ourNeg = document.getElementById("dash-our-neg")?.innerText || "0";
  const oppPos = document.getElementById("dash-opp-pos")?.innerText || "0";
  const oppNeg = document.getElementById("dash-opp-neg")?.innerText || "0";
  const impactOurs = (document.getElementById("dash-impact-ours")?.innerText || "").trim();
  const impactTheirs = (document.getElementById("dash-impact-theirs")?.innerText || "").trim();

  // Distinctions (6x6: pas forc√©ment de select MVP)
  const pickNameFromSuggestion = (txt) => {
    const t = String(txt||"").replace(/\s+/g," ").trim();
    // Ex: "Suggestion auto : Clara ‚Äî Actions+ 7 | ..."
    let m = t.match(/Suggestion\s*auto\s*[:Ôºö]\s*([^\n‚Äî\-|]+)/i);
    if (m && m[1]) return m[1].trim();
    // fallback: premier mot capitalis√©
    m = t.match(/\b([A-Z√Ä-√ñ√ò-√ù][A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'‚Äô-]{1,})\b/);
    return m ? m[1] : "‚Äî";
  };

  const mvpWhy = (document.getElementById("mvp-suggestion")?.innerText || "").trim();
  const blockWhy = (document.getElementById("block-suggestion")?.innerText || "").trim();
  const attackWhy = (document.getElementById("attack-suggestion")?.innerText || "").trim();
  const supportWhy = (document.getElementById("support-suggestion")?.innerText || "").trim();

  const mvp = (document.getElementById("select-best-mvp")?.value || pickNameFromSuggestion(mvpWhy) || "‚Äî").trim() || "‚Äî";
  const block = (document.getElementById("select-best-block")?.value || "‚Äî").trim() || "‚Äî";
  const attack = (document.getElementById("select-best-attack")?.value || "‚Äî").trim() || "‚Äî";
  const support = (document.getElementById("select-best-support")?.value || "‚Äî").trim() || "‚Äî";

  const lines = [];
  lines.push(`üèê Stat2Match ‚Äî Tableau de bord (${scoreLabel})`);
  lines.push(`${teamName} vs ${oppName}`);
  lines.push(`Score: ${scoreUs} - ${scoreThem} (diff ${diffStr})`);
  if (scoreLine) lines.push(scoreLine);

  lines.push("");
  lines.push("üß† Lecture coach (r√©sum√© clair)");
  if (dashComment) lines.push(dashComment);
  if (highlights) lines.push(highlights);
  if (!dashComment && !highlights) lines.push("‚Äî");

  lines.push("");
  lines.push(`üéØ Adversaire ‚Äî ${oppName} (${scoreLabel.toLowerCase()})`);
  lines.push(`‚Ä¢ Service: ${toInt(oppSF)} fautes / ${toInt(oppSP)} points`);
  lines.push(`‚Ä¢ Bloc: ${toInt(oppBP)} points pour eux`);
  lines.push(`‚Ä¢ Cadeaux: ${toInt(oppGifts)} points pour nous`);
  lines.push(`‚Ä¢ Hors service: ${toInt(oppPNous)} pour nous / ${toInt(oppPEux)} pour eux`);

  lines.push("");
  lines.push("‚öñÔ∏è Balance + / ‚àí (impact score)");
  lines.push(`‚Ä¢ Positifs: Nous ${toInt(ourPos)} | Eux ${toInt(oppPos)}`);
  lines.push(`‚Ä¢ N√©gatifs: Nous ${toInt(ourNeg)} | Eux ${toInt(oppNeg)}`);
  if (impactOurs) lines.push(`‚Ä¢ Impact (nous): ${impactOurs}`);
  if (impactTheirs) lines.push(`‚Ä¢ Impact (eux): ${impactTheirs}`);

  lines.push("");
  lines.push("üèÖ Distinctions (avec raisons)");
  lines.push(`MVP: ${mvp}${mvpWhy ? " ‚Äî " + mvpWhy : ""}`);
  lines.push(`Meilleur¬∑e bloqueur¬∑euse: ${block}${blockWhy ? " ‚Äî " + blockWhy : ""}`);
  lines.push(`Meilleur¬∑e attaquant¬∑e: ${attack}${attackWhy ? " ‚Äî " + attackWhy : ""}`);
  lines.push(`Meilleur soutien: ${support}${supportWhy ? " ‚Äî " + supportWhy : ""}`);

  return lines.join("\n").replace(/\n{3,}/g, "\n\n").trim();
}



function copyDashboardNow() {
  const txt = buildDashboardShareText(currentSet);
  // Utilise le helper global (avec fallback) si dispo
  if (typeof copyTextToClipboard === "function") {
    copyTextToClipboard(txt, "Tableau de bord copi√© ‚úÖ");
    return;
  }
  // Fallback ultra-safe
  try {
    const ta = document.createElement("textarea");
    ta.value = String(txt || "");
    ta.style.position = "fixed";
    ta.style.opacity = "0";
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    alert("Tableau de bord copi√© ‚úÖ");
  } catch (e) {
    alert("Copie impossible sur ce navigateur.");
  }
}

async function shareDashboardNow() {
  const txt = buildDashboardShareText(currentSet);
  if (navigator.share) {
    try {
      await navigator.share({ title: "Stat2Match ‚Äì Tableau de bord", text: txt });
      return;
    } catch (e) { /* fallback below */ }
  }
  copyDashboardNow();
}

function shareDashboardWhatsApp() {
  const txt = buildDashboardShareText(currentSet);
  const url = "https://wa.me/?text=" + encodeURIComponent(txt);
  window.open(url, "_blank");
}

function shareDashboardTelegram() {
  const txt = buildDashboardShareText(currentSet);
  const url = "https://t.me/share/url?text=" + encodeURIComponent(txt);
  window.open(url, "_blank");
}


/* ---------- PARTAGE & COPIE (g√©n√©riques) ---------- */
function openShareWhatsApp(text) {
  const url = "https://wa.me/?text=" + encodeURIComponent(text || "");
  window.open(url, "_blank");
}
function openShareTelegram(text) {
  const url = "https://t.me/share/url?text=" + encodeURIComponent(text || "");
  window.open(url, "_blank");
}
function copyTextToClipboard(text, okMsg) {
  const t = String(text || "");
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(t).then(() => {
      if (okMsg) alert(okMsg);
    }).catch(() => fallbackCopyPlainText(t, okMsg));
  } else {
    fallbackCopyPlainText(t, okMsg);
  }
}
function fallbackCopyPlainText(text, okMsg) {
  const tmp = document.createElement("textarea");
  tmp.value = String(text || "");
  tmp.style.position = "fixed";
  tmp.style.opacity = "0";
  document.body.appendChild(tmp);
  tmp.focus();
  tmp.select();
  tmp.setSelectionRange(0, tmp.value.length);
  try { document.execCommand("copy"); } catch (e) {}
  document.body.removeChild(tmp);
  if (okMsg) alert(okMsg);
}
async function shareTextSmart(title, text, okMsg) {
  const t = String(text || "");
  if (navigator.share) {
    try {
      await navigator.share({ title: title || "Stat2Match", text: t });
      return true;
    } catch (e) { /* fallback below */ }
  }
  copyTextToClipboard(t, okMsg || "Texte copi√© ‚úÖ");
  return false;
}

/* ---------- IMPRESSION (g√©n√©rique funky) ---------- */
function buildFunkyPrintHTML(title, metaLine, text) {
  const esc = (v) => String(v ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
  const safeTitle = esc(title || "Stat2Match");
  const safeMeta = esc(metaLine || "");
  const safeText = esc(text || "");
  return `<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>${safeTitle}</title>
  <style>
    :root{
      --blue:#4992db; --orange:#ec4f21; --yellow:#f49a1e; --green:#9ece09;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
      background: radial-gradient(circle at 20% 10%, rgba(73,146,219,.18), transparent 45%),
                  radial-gradient(circle at 85% 15%, rgba(236,79,33,.16), transparent 55%),
                  radial-gradient(circle at 45% 85%, rgba(158,206,9,.14), transparent 55%),
                  #f6f7fb;
      padding: 22px;
    }
    .wrap{ max-width: 880px; margin:0 auto; }
    .card{
      background: #ffffffcc;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      box-shadow: 0 14px 40px rgba(0,0,0,.12);
      padding: 16px 16px 18px;
    }
    h1{ margin:0; font-size: 22px; letter-spacing: .2px; }
    .meta{
      margin-top: 6px;
      color: #444;
      font-size: 12px;
      line-height: 1.4;
    }
    .actions{ margin: 14px 0 10px; display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border: 1px solid rgba(0,0,0,.12);
      background: #fff;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      cursor:pointer;
    }
    pre{
      margin: 12px 0 0;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      line-height: 1.5;
      background: rgba(0,0,0,.03);
      border: 1px dashed rgba(0,0,0,.12);
      border-radius: 14px;
      padding: 12px;
    }
    @media print{
      body{ padding:0; background:#fff; }
      .card{ box-shadow:none; border:none; border-radius:0; }
      .actions{ display:none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>${safeTitle}</h1>
      ${safeMeta ? `<div class="meta">${safeMeta}</div>` : ``}
      <div class="actions">
        <button class="btn" onclick="window.print()">Imprimer / PDF</button>
      </div>
      <pre>${safeText}</pre>
    </div>
  </div>

  <!-- Floating back-to-court buttons (anchored, no scroll needed) -->
</body>
</html>`;
}
function openPrintableTextPage(title, metaLine, text) {
  const win = window.open("", "_blank");
  if (!win) {
    alert("Impossible d‚Äôouvrir la fen√™tre d‚Äôimpression. Autorise les pop-ups si besoin.");
    return;
  }
  win.document.open();
  win.document.write(buildFunkyPrintHTML(title, metaLine, text));
  win.document.close();
}


function buildDashboardPrintHTML(setNum) {
  const esc = (v) => String(v ?? "")
    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

  const title = `Stat2Match ‚Äî Tableau de bord (set ${setNum})`;
  const scoreLine = document.getElementById("dash-score-line")?.innerText?.trim() || "";
  const ourBody = document.getElementById("dash-team-body")?.innerHTML || "";
  const oppName = (typeof getOppTeamName === "function" ? getOppTeamName() : "") || (document.getElementById("dash-team-name-opponent")?.innerText || "Adversaire");
  const oppServiceF = document.getElementById("dash-opp-service-fautes")?.innerText || "0";
  const oppServiceP = document.getElementById("dash-opp-service-points")?.innerText || "0";
  const oppBlocP = document.getElementById("dash-opp-bloc-points")?.innerText || "0";
  const oppCad = document.getElementById("dash-opp-cadeaux")?.innerText || "0";
  const oppPNous = document.getElementById("dash-opp-points-pourNous")?.innerText || "0";
  const oppPEux = document.getElementById("dash-opp-points-pourEux")?.innerText || "0";

  const ourPos = document.getElementById("dash-our-pos")?.innerText || "0";
  const oppPos = document.getElementById("dash-opp-pos")?.innerText || "0";
  const ourNeg = document.getElementById("dash-our-neg")?.innerText || "0";
  const oppNeg = document.getElementById("dash-opp-neg")?.innerText || "0";
  const impactTheirs = document.getElementById("dash-impact-theirs")?.innerText || "0%";
  const impactOurs   = document.getElementById("dash-impact-ours")?.innerText || "0%";

  const mvp = document.getElementById("select-mvp")?.selectedOptions?.[0]?.textContent || "‚Äî";
  const block = document.getElementById("select-best-blocker")?.selectedOptions?.[0]?.textContent || "‚Äî";
  const attack = document.getElementById("select-best-attack")?.selectedOptions?.[0]?.textContent || "‚Äî";
  const support = document.getElementById("select-best-support")?.selectedOptions?.[0]?.textContent || "‚Äî";

  const hi = (typeof getSetHighlights === "function") ? getSetHighlights(setNum) : null;
  const hlDelta = hi ? formatTopList(hi.topDelta, "delta", true) : "";
  const hlSupport = hi ? formatTopList(hi.topSupport, "support", false) : "";
  const hlAttack = hi ? formatTopList(hi.topAttack, "attack", false) : "";
  const hlFaults = hi ? formatTopList(hi.topFaults, "minus", false) : "";

  return `<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${esc(title)}</title>
<style>
  body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; margin:0; background:#0b0b0e; color:#fff; }
  .wrap{ max-width:820px; margin:0 auto; padding:18px; }
  .card{ border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:14px; background: rgba(255,255,255,0.06); margin:12px 0; }
  h1{ font-size:20px; margin:0 0 6px; }
  h2{ font-size:15px; margin:0 0 10px; opacity:.95; }
  .score{ font-weight:800; font-size:16px; }
  .btnbar{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 0; }
  .btn{ border:none; border-radius:999px; padding:10px 14px; background:#d81b60; color:#fff; cursor:pointer; font-weight:700; }
  .btn.secondary{ background:#111; border:1px solid rgba(255,255,255,.18); }
  .row{ display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.10); }
  .row:last-child{ border-bottom:none; }
  .k{ color:#ddd; font-weight:700; }
  .v{ color:#fff; font-weight:700; text-align:right; }
  .pill{ display:inline-block; margin:4px 6px 0 0; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); background: rgba(0,0,0,.25); font-size:12px; }
  .pill.pink{ border-color: rgba(216,27,96,.55); background: rgba(216,27,96,.14); }
  .pill.green{ border-color: rgba(0,200,83,.55); background: rgba(0,200,83,.14); }
  .pill.orange{ border-color: rgba(255,152,0,.55); background: rgba(255,152,0,.14); }
  .pill.blue{ border-color: rgba(0,119,255,.55); background: rgba(0,119,255,.14); }
  table{ width:100%; border-collapse:collapse; }
  /* dash-team-body is divs, keep it readable */
  .stat-row{ display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.10); }
  .stat-row:last-child{ border-bottom:none; }
  .stat-label{ font-weight:700; color:#ddd; }
  .stat-controls{ font-weight:700; color:#fff; }
  .stat-sep{ color:#bbb; margin:0 6px; font-weight:600; }
  @media print{
    body{ background:#fff; color:#000; }
    .card{ background:#fff; border-color:#ddd; }
    .btnbar{ display:none; }
    .k{ color:#111; }
    .stat-sep{ color:#333; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>${esc(title)}</h1>
      <div class="score">${esc(scoreLine)}</div>
      <div class="btnbar">
        <button class="btn" onclick="window.print()">Imprimer / PDF</button>
        <button class="btn secondary" onclick="window.close()">Fermer</button>
      </div>
    </div>

    <div class="card">
      <h2>üü© Nos stats</h2>
      ${ourBody}
    </div>

    <div class="card">
      <h2>üü• Stats adverses ‚Äî ${esc(oppName)}</h2>
      <div class="row"><div class="k">Services</div><div class="v">${esc(oppServiceF)} fautes / ${esc(oppServiceP)} points</div></div>
      <div class="row"><div class="k">Bloc</div><div class="v">${esc(oppBlocP)} points</div></div>
      <div class="row"><div class="k">Cadeaux</div><div class="v">${esc(oppCad)} points pour nous</div></div>
      <div class="row"><div class="k">Points (hors service)</div><div class="v">${esc(oppPNous)} pour nous / ${esc(oppPEux)} pour eux</div></div>
    </div>

    <div class="card">
      <h2>üü¶ Comparatif ‚Äî Nous vs Eux</h2>
      <div class="row"><div class="k">Actions positives</div><div class="v">Nous ${esc(ourPos)} | Eux ${esc(oppPos)}</div></div>
      <div class="row"><div class="k">Actions n√©gatives</div><div class="v">Nous ${esc(ourNeg)} | Eux ${esc(oppNeg)}</div></div>
      <div class="row"><div class="k">Impact fautes</div><div class="v">Nos fautes ‚Üí ${esc(impactTheirs)} | Leurs fautes ‚Üí ${esc(impactOurs)}</div></div>
    </div>

    <div class="card">
      <h2>‚≠ê Highlights</h2>
      ${(hlDelta? `<span class="pill pink">Top Œî : ${esc(hlDelta)}</span>`:"")}
      ${(hlSupport? `<span class="pill green">Top soutien : ${esc(hlSupport)}</span>`:"")}
      ${(hlAttack? `<span class="pill orange">Top attaque : ${esc(hlAttack)}</span>`:"")}
      ${(hlFaults? `<span class="pill blue">Fautes : ${esc(hlFaults)}</span>`:"")}
      ${(!hlDelta && !hlSupport && !hlAttack && !hlFaults) ? "<div style=\"opacity:.75\">‚Äî</div>" : ""}
    </div>

    <div class="card">
      <h2>üèÖ Distinctions</h2>
      <div class="row"><div class="k">MVP</div><div class="v">${esc(mvp)}</div></div>
      <div class="row"><div class="k">Meilleur¬∑e bloqueur¬∑euse</div><div class="v">${esc(block)}</div></div>
      <div class="row"><div class="k">Meilleur¬∑e attaquant¬∑e</div><div class="v">${esc(attack)}</div></div>
      <div class="row"><div class="k">Meilleur soutien</div><div class="v">${esc(support)}</div></div>
    </div>
  </div>
</body>
</html>`;
}

function printDashboardNow() {
  const html = buildDashboardPrintHTML(currentSet);
  const w = window.open("", "_blank");
  if (!w) { alert("Impossible d‚Äôouvrir la fen√™tre d‚Äôimpression (popup bloqu√©e)."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
  try { w.focus(); } catch(e) {}
}
/* ===== Rallye : fermeture auto sur actions adverses + drag ===== */
function makeRallyPanelDraggable() {
  const panel = document.getElementById("rally-overlay-panel");
  const handle = document.getElementById("rally-drag-handle");
  if (!panel || !handle) return;

  let dragging = false;
  let startX = 0, startY = 0;
  let startLeft = 0, startTop = 0;

  const clamp = (v, min, max) => Math.min(Math.max(v, min), max);

  function getXY(ev){
    if (ev.touches && ev.touches[0]) return {x: ev.touches[0].clientX, y: ev.touches[0].clientY};
    return {x: ev.clientX, y: ev.clientY};
  }

  function onDown(ev){
    // ignore clicks on close button
    if (ev.target && (ev.target.id === "rally-close-x" || ev.target.closest && ev.target.closest("#rally-close-x"))) return;
    dragging = true;
    ev.preventDefault();
    const rect = panel.getBoundingClientRect();
    const pos = getXY(ev);
    startX = pos.x;
    startY = pos.y;
    startLeft = rect.left;
    startTop = rect.top;

    panel.style.right = "auto";
    panel.style.bottom = "auto";
    panel.style.left = startLeft + "px";
    panel.style.top  = startTop + "px";

    document.addEventListener("mousemove", onMove);
    document.addEventListener("mouseup", onUp);
    document.addEventListener("touchmove", onMove, {passive:false});
    document.addEventListener("touchend", onUp);
  }

  function onMove(ev){
    if (!dragging) return;
    ev.preventDefault();
    const pos = getXY(ev);
    const dx = pos.x - startX;
    const dy = pos.y - startY;

    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const rect = panel.getBoundingClientRect();

    const newLeft = clamp(startLeft + dx, 10, vw - rect.width - 10);
    const newTop  = clamp(startTop + dy, 10, vh - rect.height - 10);

    panel.style.left = newLeft + "px";
    panel.style.top  = newTop  + "px";
  }

  function onUp(){
    dragging = false;
    document.removeEventListener("mousemove", onMove);
    document.removeEventListener("mouseup", onUp);
    document.removeEventListener("touchmove", onMove);
    document.removeEventListener("touchend", onUp);
  }

  handle.addEventListener("mousedown", onDown);
  handle.addEventListener("touchstart", onDown, {passive:false});
}

// Fermeture auto du rallye si action adverse (bloc / points / etc)
document.addEventListener("click", (e) => {
  if (window.__rallyMode !== "multi") return;
  const t = e.target;
  if (!t) return;
  if (t.closest && t.closest("#opponent-stats-list")) {
    closeRallyOverlay();
  }
}, true);


/* === Floating Back-to-court (anchored) === */
(function(){
  function qs(id){ return document.getElementById(id); }
  function isVisible(el){
    if (!el) return false;
    const cs = window.getComputedStyle(el);
    return cs && cs.display !== "none" && cs.visibility !== "hidden" && cs.opacity !== "0";
  }

  function goToCourt(){
    // Hide all "pages" and show the terrain
    const main = qs("main-view");
    const pages = ["stats-container","dashboard-container","history-container","help-container"];
    pages.forEach(pid => { const el = qs(pid); if(el) el.style.display = "none"; });

    if (main) main.style.display = "block";

    // If roster overlay exists, keep it as-is (user choice).
    // Smooth re-focus near terrain title when possible
    try{
      const anchor = qs("main-view");
      if (anchor) anchor.scrollIntoView({behavior:"smooth", block:"start"});
      else window.scrollTo({top:0, behavior:"smooth"});
    }catch(e){
      window.scrollTo(0,0);
    }
  }

  function updateFloating(){
    const left = qs("floating-back-left");
    const right = qs("floating-back-right");
    if (!left || !right) return;

    const auxOpen =
      isVisible(qs("stats-container")) ||
      isVisible(qs("dashboard-container")) ||
      isVisible(qs("history-container")) ||
      isVisible(qs("help-container"));

    // show only when you're NOT on the terrain (i.e., some other page is open)
    if (auxOpen){
      left.classList.remove("floating-back-hidden");
      right.classList.remove("floating-back-hidden");
      left.setAttribute("aria-hidden","false");
      right.setAttribute("aria-hidden","false");
    } else {
      left.classList.add("floating-back-hidden");
      right.classList.add("floating-back-hidden");
      left.setAttribute("aria-hidden","true");
      right.setAttribute("aria-hidden","true");
    }
  }

  function bind(){
    const bl = qs("btn-float-back-left");
    const br = qs("btn-float-back-right");
    if (bl) bl.addEventListener("click", goToCourt);
    if (br) br.addEventListener("click", goToCourt);

    // keep it always correct even if other code toggles views
    updateFloating();
    setInterval(updateFloating, 250);

    // Also update right after common nav/back buttons
    ["btn-back-from-dashboard","btn-back-from-history","btn-back-from-history-bottom","btn-back-from-help"].forEach(id=>{
      const b = qs(id);
      if (b) b.addEventListener("click", ()=>setTimeout(updateFloating, 30));
    });

    // If there are nav buttons that open pages, hook them too
    ["btn-dashboard","btn-history","btn-help"].forEach(id=>{
      const b = qs(id);
      if (b) b.addEventListener("click", ()=>setTimeout(updateFloating, 30));
    });
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", bind);
  else bind();
})();



// === SAFETY: ensure no fullscreen overlay blocks clicks on load (6x6 port fix) ===
document.addEventListener('DOMContentLoaded', () => {
  const forceHidden = ['matchio-overlay','rally-overlay'];
  forceHidden.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  const bd = document.getElementById('rally-overlay-backdrop');
  if (bd) bd.style.display = 'none';
});


document.addEventListener("DOMContentLoaded", ()=>{
  const b1 = document.getElementById("btn-open-rally-overlay");
  if (b1) b1.addEventListener("click", ()=> { try{ openRallyMatrixOverlay(); }catch(e){} });

  const b2 = document.getElementById("btn-open-rally-overlay-bar");
  if (b2) b2.addEventListener("click", ()=> { try{ openRallyMatrixOverlay(); }catch(e){} });
});

// === Compat: certains noms historiques sont appel√©s par boot() dans certaines versions ===
if (typeof window.bindScoreButtons !== "function") {
  window.bindScoreButtons = function(){
    // score + temps-morts + sets
    if (typeof initScoreControls === "function") initScoreControls();
    if (typeof initSetButtonsMain === "function") initSetButtonsMain();
    if (typeof initSetButtonsStats === "function") initSetButtonsStats();
    if (typeof initSetButtonsDashboard === "function") initSetButtonsDashboard();
    // premier rendu
    if (typeof renderSetScore === "function") renderSetScore();
  };
}

if (typeof window.bindOpponentControls !== "function") {
  window.bindOpponentControls = function(){
    if (typeof initOpponentControls === "function") initOpponentControls();
    // panneaux rapides point/fautes + toggle
    if (typeof initOpponentPointPanelControls === "function") initOpponentPointPanelControls();
    if (typeof initOpponentFaultPanelControls === "function") initOpponentFaultPanelControls();
    if (typeof initOpponentPanelsToggle === "function") initOpponentPanelsToggle();
    if (typeof renderOpponentStats === "function") renderOpponentStats();
    if (typeof renderOpponentPointPanel === "function") renderOpponentPointPanel();
    if (typeof renderOpponentFaultPanel === "function") renderOpponentFaultPanel();
  };
}

if (typeof window.bindRallyButtons !== "function") {
  window.bindRallyButtons = function(){
    // pro pad (terrain) + bandeau rally
    if (typeof wireProActionPadDelegation === "function") wireProActionPadDelegation();
    if (typeof wireRallyBarButtons === "function") wireRallyBarButtons();
  };
}

if (typeof window.bindRallyOverlay !== "function") {
  window.bindRallyOverlay = function(){
    if (typeof initRallyOverlayWiring === "function") initRallyOverlayWiring();
  };
}


document.addEventListener("DOMContentLoaded", boot);

function boot() {
  console.log("üü¢ Stat2Match 6x6 ‚Äî BOOT OK");

  bindScoreButtons();
  bindRallyButtons();
  bindRallyOverlay();
  bindOpponentControls();
}


/* === Diagnostics Modal wiring (PRO) ‚Äî safe === */
(function(){
  function _diagPickPlayerId(){
    try{
      if (typeof currentStatsPlayerId !== "undefined" && currentStatsPlayerId) return currentStatsPlayerId;
    }catch(e){}
    try{
      const list = (players || []).filter(p=>p && p.id && p.name && (p.inMatch !== false));
      return list.length ? list[0].id : null;
    }catch(e){}
    return null;
  }

  function _diagEligiblePlayers(){
    try{
      return (players || []).filter(p => p && p.id && (p.inMatch !== false));
    }catch(e){ return []; }
  }

  function _diagPlayerName(pid){
    try{
      const p = (players || []).find(x => x && x.id === pid);
      if(!p) return "";
      const num = (p.number !== undefined && p.number !== null && String(p.number).trim() !== "") ? ("#" + p.number + " ") : "";
      return (num + (p.name || "")).trim();
    }catch(e){ return ""; }
  }

  function _diagFillSelect(selectedId){
    const sel = document.getElementById("diag-player-select");
    if(!sel) return;
    const list = _diagEligiblePlayers();
    const prev = sel.value;
    sel.innerHTML = "";
    list.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = _diagPlayerName(p.id) || ("Joueur " + p.id);
      sel.appendChild(opt);
    });
    const pick = selectedId || prev || (list[0] && list[0].id) || "";
    if(pick) sel.value = pick;
  }

  function _diagOpenForPlayer(pid){
    try{
      if(!pid) pid = _diagPickPlayerId();
      if(!pid){
        _diagShowModal("<p style='opacity:.85'>Aucun joueur s√©lectionn√©.</p>", "");
        return;
      }

      // Navigue vers stats (safe) + rend le bloc diagnostics (safe)
      try{ if (typeof openPlayerStats === "function") openPlayerStats(pid); }catch(e){}
      try{ if (typeof renderPlayerDiagnostics === "function") renderPlayerDiagnostics(pid); }catch(e){}

      const box = document.getElementById("player-diagnostics");
      const html = box ? box.innerHTML : "<p style='opacity:.85'>Aucune donn√©e disponible.</p>";
      _diagFillSelect(pid);
      _diagShowModal(html, _diagPlayerName(pid));
      // M√©morise
      try{ currentStatsPlayerId = pid; }catch(e){}
    }catch(e){
      console.warn("_diagOpenForPlayer error:", e);
      _diagShowModal("<p style='opacity:.85'>Erreur lors de l'ouverture des diagnostics.</p>", "");
    }
  }


  function _diagShowModal(html, subtitle){
    const bd = document.getElementById("diag-modal-backdrop");
    const body = document.getElementById("diag-modal-body");
    const sub = document.getElementById("diag-modal-sub");
    if(!bd || !body) return;
    body.innerHTML = html || "<p style='opacity:.85'>Aucune donn√©e disponible.</p>";
    if(sub) sub.textContent = subtitle ? ("‚Äî " + subtitle) : "";
    bd.style.display = "block";
    bd.setAttribute("aria-hidden","false");
  }

  function _diagHideModal(){
    const bd = document.getElementById("diag-modal-backdrop");
    if(!bd) return;
    bd.style.display = "none";
    bd.setAttribute("aria-hidden","true");
  }

  window.openDiagnosticsPRO = function(playerId){
    _diagOpenForPlayer(playerId || null);
  };

  document.addEventListener("DOMContentLoaded", ()=>{
    const navBtn = document.getElementById("btn-diagnostics");

    const statsBtn = document.getElementById("btn-toggle-diagnostics");
    if(statsBtn && !statsBtn.__diagModalBound){
      statsBtn.__diagModalBound = true;
      statsBtn.addEventListener("click", (ev)=>{ ev.preventDefault(); window.openDiagnosticsPRO(); });
    }
    if(navBtn && !navBtn.__diagBound){
      navBtn.__diagBound = true;
      navBtn.addEventListener("click", (ev)=>{ ev.preventDefault(); window.openDiagnosticsPRO(); });
    }

    // Controls inside modal
    const sel = document.getElementById("diag-player-select");
    const prevBtn = document.getElementById("diag-player-prev");
    const nextBtn = document.getElementById("diag-player-next");

    // Populate select once at boot (safe)
    _diagFillSelect(_diagPickPlayerId());

    if(sel && !sel.__diagBound){
      sel.__diagBound = true;
      sel.addEventListener("change", ()=>{
        const pid = sel.value;
        if(pid) _diagOpenForPlayer(pid);
      });
    }

    function _diagStep(delta){
      const list = _diagEligiblePlayers();
      if(!list.length) return;
      const current = (sel && sel.value) ? sel.value : _diagPickPlayerId();
      const idx = Math.max(0, list.findIndex(p=>p.id === current));
      const next = list[(idx + delta + list.length) % list.length];
      if(next && next.id) _diagOpenForPlayer(next.id);
    }

    if(prevBtn && !prevBtn.__diagBound){
      prevBtn.__diagBound = true;
      prevBtn.addEventListener("click", ()=>_diagStep(-1));
    }
    if(nextBtn && !nextBtn.__diagBound){
      nextBtn.__diagBound = true;
      nextBtn.addEventListener("click", ()=>_diagStep(1));
    }
    const closeBtn = document.getElementById("diag-modal-close");
    if(closeBtn) closeBtn.addEventListener("click", _diagHideModal);
    const bd = document.getElementById("diag-modal-backdrop");
    if(bd) bd.addEventListener("click", (e)=>{ if(e.target === bd) _diagHideModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") _diagHideModal(); });
  });
})();
</script>

  <!-- OVERLAY RALLYE : LISTE DES JOUEUSES SUR LE TERRAIN -->
  <div id="rally-overlay">
    <div id="rally-overlay-backdrop"></div>
    <div id="rally-overlay-panel" data-cat="matrix" data-mode="matrix">
      <div id="rally-drag-handle">
        <div>
          <span id="rally-overlay-title">Rallye</span>
          <small id="rally-overlay-subtitle" style="display:block;opacity:.8;">Passe ‚Ä¢ Attaque ‚Ä¢ D√©fense ‚Ä¢ Relance</small>
        </div>
        <button id="rally-close-x" type="button" aria-label="Fermer">√ó</button>
      </div>

      <p id="rally-overlay-hint">1) Choisis l‚Äôissue <b>‚àí / + / P / F</b>. 2) Tape la joueuse dans la bonne rubrique. <b>P/F</b> ferme automatiquement le rallye. <span style="opacity:.9;">¬∑ <b>Clic droit</b> sur une joueuse = <b>‚àí1</b> (correction).</span></p>

      <div id="rally-issue-selector" class="rally-issue" role="group" aria-label="Issue du rallye">
        <button type="button" class="rally-issue-btn" data-outcome="minus" aria-label="Action n√©gative (‚àí) : le rallye continue">‚àí</button>
        <button type="button" class="rally-issue-btn mid" data-outcome="point" aria-label="Point pour nous (P) : ferme le rallye">P</button>
        <button type="button" class="rally-issue-btn mid" data-outcome="fault" aria-label="Faute : point pour eux (F) : ferme le rallye">F</button>
        <button type="button" class="rally-issue-btn" data-outcome="plus" aria-label="Action positive (+) : le rallye continue">+</button>
      </div>

      <div id="rally-matrix-wrap">
        <div class="rally-matrix-grid">
          <section class="rally-matrix-card" data-skill="passe">
            <h4>Passe</h4>
            <div id="rally-player-list-passe"></div>
          </section>
          <section class="rally-matrix-card" data-skill="attaque">
            <h4>Attaque</h4>
            <div id="rally-player-list-attaque"></div>
          </section>
          <section class="rally-matrix-card" data-skill="defense">
            <h4>D√©fense</h4>
            <div id="rally-player-list-defense"></div>
          </section>
          <section class="rally-matrix-card" data-skill="relance">
            <h4>Relance</h4>
            <div id="rally-player-list-relance"></div>
          </section>
        </div>
      </div>

      <button id="rally-close-btn" type="button">Terminer le rallye</button>
    </div>
  </div>

  <div id="app-signature">
    ¬© Coach Eddy Takougang ¬∑ stat2match-volley
  </div>

  <!-- PRO ACTION OVERLAY (+ / - / P / F) -->
  <div id="pro-action-overlay">
    <div id="pro-action-backdrop"></div>
    <div id="pro-action-panel">
      <div id="pro-action-title">
        <span id="pro-action-title-text">Action</span>
        <button type="button" id="pro-action-close" class="pro-pill">Fermer</button>
      </div>
      <div id="pro-action-grid">
        <button type="button" class="pro-action-choice" data-outcome="plus">+</button>
        <button type="button" class="pro-action-choice" data-outcome="minus">-</button>
        <button type="button" class="pro-action-choice" data-outcome="point">P</button>
        <button type="button" class="pro-action-choice" data-outcome="fault">F</button>
      </div>
      <p style="margin:10px 0 0; font-size:12px; opacity:.75;">
        + / - = qualit√© (ne change pas le score) ¬∑ P / F = point / faute (change le score)
      </p>
    </div>
  </div>


  <!-- Floating back-to-court buttons (anchored, no scroll needed) -->
  <div id="floating-back-left" class="floating-back-wrap left floating-back-hidden" aria-hidden="true">
    <button type="button" class="floating-back-btn" id="btn-float-back-left" aria-label="Retour au terrain">‚Ü© Terrain</button>
  </div>
  <div id="floating-back-right" class="floating-back-wrap right floating-back-hidden" aria-hidden="true">
    <button type="button" class="floating-back-btn" id="btn-float-back-right" aria-label="Retour au terrain">Terrain ‚Ü©</button>
  </div>



  <!-- === Diagnostics Modal (PRO) === -->
  <div id="diag-modal-backdrop" aria-hidden="true">
    <div id="diag-modal" role="dialog" aria-modal="true" aria-label="Diagnostics (PRO)">
      <div class="diag-modal-head">
        <div class="diag-modal-title">
          üìä Diagnostics (PRO) <span id="diag-modal-sub" style="opacity:.8;font-weight:600;"></span>
        </div>
        <div class="diag-modal-controls" aria-label="Navigation diagnostics">
          <button type="button" id="diag-player-prev" class="diag-nav-btn" title="Joueur pr√©c√©dent">‚Äπ</button>
          <select id="diag-player-select" class="diag-player-select" aria-label="Choisir un joueur"></select>
          <button type="button" id="diag-player-next" class="diag-nav-btn" title="Joueur suivant">‚Ä∫</button>
        </div>
        <button id="diag-modal-close" class="diag-modal-close">‚úï Fermer</button>
      </div>
      <div id="diag-modal-body" class="diag-modal-body"></div>
    </div>
  </div>
</body>
</html>
